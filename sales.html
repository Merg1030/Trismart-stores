<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background:#1e1e2f; color:#fff; margin:0; padding:10px; }
  h2 { text-align:center; color:#ffcc00; margin-bottom:15px; font-size:1.2rem; }
  .buttons { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
  input, select { padding:6px; border-radius:6px; border:none; background:#2c2c44; color:#fff; font-size:0.85rem; margin:3px; width:160px; }
  button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; background:#ffcc00; color:#1e1e2f; font-weight:600; font-size:0.85rem; margin:3px; }
  button:hover { background:#e6b800; }
  table { width:100%; border-collapse:collapse; margin-top:15px; font-size:0.8rem; }
  th, td { padding:6px 4px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.1); }
  th { color:#ffcc00; font-weight:600; }
  tbody tr:nth-child(even) { background:#2c2c44; }
  tbody tr:nth-child(odd) { background:#1f1f33; }
  .form-container { display:flex; flex-direction:column; align-items:center; gap:8px; margin-bottom:10px; }
  .total-sales { text-align:center; margin-top:8px; font-size:0.95rem; font-weight:bold; }
  .scroll-container { overflow-x:auto; }

  @media(max-width:768px){ input, select, button { width:90%; max-width:220px; } table { font-size:0.75rem; } }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
  authDomain: "trismart-online-app.firebaseapp.com",
  projectId: "trismart-online-app",
  storageBucket: "trismart-online-app.firebasestorage.app",
  messagingSenderId: "867677912389",
  appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
  measurementId: "G-KEWDREKNDB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserUID, inventory = [], salesCache = {};
onAuthStateChanged(auth, async user => {
  if(!user) window.location.href="index.html";
  currentUserUID = user.uid;
  await loadInventory();
  setTodayDate();
  await loadSalesByDate(document.getElementById('filterDate').value);
});

// Cache inventory locally to reduce reads
async function loadInventory(){
  if(inventory.length>0) return;
  const snapshot = await getDocs(collection(db, "users", currentUserUID, "inventory"));
  inventory = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
  populateProductOptions();
}

function populateProductOptions(){
  const select = document.getElementById('productCode');
  select.innerHTML = '<option value="">Select Product</option>';
  inventory.forEach(item => { 
    const option = document.createElement('option'); 
    option.value=item.code; option.textContent=item.name; 
    select.appendChild(option); 
  });
}

function setTodayDate(){
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('saleDate').value = today;
  document.getElementById('filterDate').value = today;
}

async function makeSale(event){
  event.preventDefault();
  const productCode = document.getElementById('productCode').value;
  const quantity = parseInt(document.getElementById('quantity').value);
  const date = document.getElementById('saleDate').value;
  if(!productCode || isNaN(quantity) || !date) return alert("Fill all fields!");
  
  const item = inventory.find(i => i.code===productCode);
  if(!item || item.stock < quantity) return alert(`Insufficient stock for ${item?item.name:''}`);
  
  item.stock -= quantity;
  item.sold = (item.sold||0)+quantity;

  const saleEntry = { date, code:item.code, name:item.name, price:item.price, quantity };
  await addDoc(collection(db, "users", currentUserUID, "sales"), saleEntry);
  await updateDoc(doc(db, "users", currentUserUID, "inventory", item.id), { stock:item.stock, sold:item.sold });

  if(!salesCache[date]) salesCache[date]=[];
  salesCache[date].push(saleEntry); // update local cache
  renderSalesTable(date);
  document.getElementById('salesForm').reset();
}

async function loadSalesByDate(date){
  if(!salesCache[date]){
    const salesRef = collection(db, "users", currentUserUID, "sales");
    const q = query(salesRef, where("date","==",date));
    const snapshot = await getDocs(q);
    salesCache[date] = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
  }
  renderSalesTable(date);
}

function renderSalesTable(date){
  const tbody = document.querySelector('#salesTable tbody');
  tbody.innerHTML='';
  const sales = salesCache[date] || [];
  if(sales.length===0){
    tbody.innerHTML='<tr><td colspan="5" style="text-align:center;">No sales yet</td></tr>';
    updateTotalSales(date);
    return;
  }
  sales.forEach(sale=>{
    const total=(sale.price*sale.quantity).toFixed(2);
    const row=document.createElement('tr');
    row.innerHTML=`<td>${sale.code}</td><td>${sale.name}</td><td>${sale.price}</td><td>${sale.quantity}</td><td>${total}</td>`;
    tbody.appendChild(row);
  });
  updateTotalSales(date);
}

function updateTotalSales(date){
  const total=(salesCache[date]||[]).reduce((acc,s)=>acc+s.price*s.quantity,0).toFixed(2);
  document.querySelector('.total-sales').textContent=`Total Sales for ${date}: ZMW ${total}`;
}

function filterByDate(){ loadSalesByDate(document.getElementById('filterDate').value); }

function toggleForm(){
  const form=document.querySelector('.form-container');
  form.style.display=form.style.display==='flex'?'none':'flex';
}

window.makeSale=makeSale;
window.toggleForm=toggleForm;
window.filterByDate=filterByDate;
</script>
</head>
<body>
<div class="container">
  <h2>Sales Dashboard</h2>
  <div class="buttons">
    <button onclick="toggleForm()">Toggle Sale Form</button>
    <input type="date" id="filterDate" onchange="filterByDate()">
  </div>
  <div class="form-container" style="display:flex;">
    <form id="salesForm" onsubmit="makeSale(event)">
      <input type="date" id="saleDate" required>
      <select id="productCode" required></select>
      <input type="number" id="quantity" placeholder="Quantity" required>
      <button type="submit">Record Sale</button>
    </form>
  </div>
  <div class="scroll-container">
    <table id="salesTable">
      <thead>
        <tr>
          <th>Product Code</th>
          <th>Product Name</th>
          <th>Price</th>
          <th>Quanti
