<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background:#1e1e2f; color:#fff; margin:0; padding:10px; }
  h2 { text-align:center; color:#ffcc00; margin-bottom:15px; font-size:1.2rem; }
  .buttons { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
  input, select { padding:6px; border-radius:6px; border:none; background:#2c2c44; color:#fff; font-size:0.85rem; margin:3px; width:160px; }
  button { padding:6px 10px; border-radius:6px; border:none; cursor:pointer; background:#ffcc00; color:#1e1e2f; font-weight:600; font-size:0.85rem; margin:3px; }
  button:hover { background:#e6b800; }
  button:disabled { background: #666; color: #999; cursor: not-allowed; }
  table { width:100%; border-collapse:collapse; margin-top:15px; font-size:0.8rem; }
  th, td { padding:6px 4px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.1); }
  th { color:#ffcc00; font-weight:600; }
  tbody tr:nth-child(even) { background:#2c2c44; }
  tbody tr:nth-child(odd) { background:#1f1f33; }
  .form-container { display:flex; flex-direction:column; align-items:center; gap:8px; margin-bottom:10px; }
  .total-sales { text-align:center; margin-top:8px; font-size:0.95rem; font-weight:bold; }
  .scroll-container { overflow-x:auto; }
  .out-of-stock { color: #999; background-color: #2a2a2a !important; }
  .filter-toggle { background: #2c2c44 !important; color: #ffcc00 !important; font-size: 0.8rem !important; padding: 5px 8px !important; }
  .filter-container { 
    display: none; 
    flex-direction: column; 
    align-items: center; 
    gap: 8px; 
    margin-bottom: 15px; 
    background: #2c2c44; 
    padding: 10px; 
    border-radius: 8px;
    width: 95%;
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
  }
  .filter-container.active { display: flex; }
  .filter-group { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 100%; }
  .filter-group input, .filter-group button { width: 90%; max-width: 250px; font-size: 0.8rem; padding: 5px; }
  .filter-title { color: #ffcc00; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }

  @media(max-width:768px){ 
    input, select, button { width:90%; max-width:220px; } 
    table { font-size:0.75rem; } 
  }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
  authDomain: "trismart-online-app.firebaseapp.com",
  projectId: "trismart-online-app",
  storageBucket: "trismart-online-app.firebasestorage.app",
  messagingSenderId: "867677912389",
  appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
  measurementId: "G-KEWDREKNDB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserUID, inventory = [], salesCache = {};
let reverseMode = false;
let isProcessing = false;
let viewMode = 'daily';

onAuthStateChanged(auth, async user => {
  if(!user) window.location.href="index.html";
  currentUserUID = user.uid;
  await loadInventory();
  setTodayDate();
  await loadSalesByDate(new Date().toISOString().split('T')[0]); // Auto-load today's sales
});

async function loadInventory(){
  const snapshot = await getDocs(collection(db, "users", currentUserUID, "inventory"));
  inventory = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
  populateProductOptions();
}

function populateProductOptions(){
  const select = document.getElementById('productCode');
  select.innerHTML = '<option value="">Select Product</option>';
  inventory.forEach(item => { 
    const option = document.createElement('option'); 
    option.value = item.code; 
    option.textContent = `${item.name} (Stock: ${item.stock})`;
    
    if (item.stock <= 0) {
      option.disabled = true;
      option.classList.add('out-of-stock');
    }
    
    select.appendChild(option); 
  });
}

function setTodayDate(){
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('saleDate').value = today;
  document.getElementById('filterDate').value = today;
  
  const now = new Date();
  document.getElementById('filterMonth').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
}

async function makeSale(event){
  event.preventDefault();
  
  if (isProcessing) {
    alert("Please wait, processing your sale...");
    return;
  }
  
  const productCode = document.getElementById('productCode').value;
  const quantity = parseInt(document.getElementById('quantity').value);
  const date = document.getElementById('saleDate').value;
  
  if(!productCode || isNaN(quantity) || quantity <= 0 || !date) return alert("Fill all fields with valid values!");
  
  const item = inventory.find(i => i.code === productCode);
  if(!item) return alert("Product not found!");
  
  if(item.stock < quantity) return alert(`Insufficient stock for ${item.name}. Only ${item.stock} available.`);
  
  isProcessing = true;
  const saleButton = document.querySelector('#salesForm button[type="submit"]');
  const originalText = saleButton.textContent;
  saleButton.textContent = "Processing...";
  saleButton.disabled = true;
  
  try {
    item.stock -= quantity;
    item.sold = (item.sold||0) + quantity;

    const saleEntry = { date, code:item.code, name:item.name, price:item.price, quantity };
    const saleRef = await addDoc(collection(db, "users", currentUserUID, "sales"), saleEntry);
    saleEntry.id = saleRef.id;

    await updateDoc(doc(db, "users", currentUserUID, "inventory", item.id), { 
      stock:item.stock, 
      sold:item.sold 
    });

    delete salesCache[date];
    
    populateProductOptions();
    
    if (viewMode === 'daily') {
      await loadSalesByDate(date);
    } else {
      await loadSalesByMonth(document.getElementById('filterMonth').value);
    }
    
    document.getElementById('salesForm').reset();
    alert("Sale recorded successfully!");
  } catch (error) {
    console.error("Error recording sale:", error);
    alert("Error recording sale. Please try again.");
  } finally {
    isProcessing = false;
    saleButton.textContent = originalText;
    saleButton.disabled = false;
  }
}

async function loadSalesByDate(date){
  if (isProcessing) return;
  
  viewMode = 'daily';
  const filterButton = document.getElementById('loadDayBtn');
  const originalText = filterButton.textContent;
  filterButton.textContent = "Loading...";
  filterButton.disabled = true;
  isProcessing = true;
  
  try {
    if(!salesCache[date]){
      const salesRef = collection(db, "users", currentUserUID, "sales");
      const q = query(salesRef, where("date","==",date));
      const snapshot = await getDocs(q);
      salesCache[date] = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
    }
    renderSalesTable(salesCache[date], `Sales for ${date}`);
  } catch (error) {
    console.error("Error loading sales:", error);
    alert("Error loading sales data.");
  } finally {
    isProcessing = false;
    filterButton.textContent = originalText;
    filterButton.disabled = false;
  }
}

async function loadSalesByMonth(monthValue){
  if (isProcessing) return;
  
  viewMode = 'monthly';
  const filterButton = document.getElementById('loadMonthBtn');
  const originalText = filterButton.textContent;
  filterButton.textContent = "Loading...";
  filterButton.disabled = true;
  isProcessing = true;
  
  try {
    const [year, month] = monthValue.split('-');
    const startDate = `${year}-${month}-01`;
    const endDate = `${year}-${month}-${new Date(year, month, 0).getDate()}`;
    
    const cacheKey = `month-${monthValue}`;
    
    if(!salesCache[cacheKey]){
      const salesRef = collection(db, "users", currentUserUID, "sales");
      const snapshot = await getDocs(salesRef);
      
      salesCache[cacheKey] = snapshot.docs
        .map(docSnap => ({ id: docSnap.id, ...docSnap.data() }))
        .filter(sale => {
          const saleDate = new Date(sale.date);
          return saleDate.getFullYear() === parseInt(year) && 
                 saleDate.getMonth() + 1 === parseInt(month);
        });
    }
    
    renderSalesTable(salesCache[cacheKey], `Sales for ${monthValue}`);
  } catch (error) {
    console.error("Error loading monthly sales:", error);
    alert("Error loading monthly sales data.");
  } finally {
    isProcessing = false;
    filterButton.textContent = originalText;
    filterButton.disabled = false;
  }
}

function renderSalesTable(sales, title){
  const tbody = document.querySelector('#salesTable tbody');
  tbody.innerHTML='';
  
  if(sales.length===0){
    tbody.innerHTML='<tr><td colspan="6" style="text-align:center;">No sales found</td></tr>';
    updateTotalSales(sales, title);
    return;
  }
  
  sales.forEach(sale => {
    const total=(sale.price*sale.quantity).toFixed(2);
    const row=document.createElement('tr');
    
    if(reverseMode){
      row.innerHTML=`
        <td><input type="checkbox" data-id="${sale.id}" data-date="${sale.date}"></td>
        <td>${sale.date || ''}</td>
        <td>${sale.code}</td>
        <td>${sale.name}</td>
        <td>${sale.price.toFixed(2)}</td>
        <td>${sale.quantity}</td>
        <td>${total}</td>
      `;
    } else {
      row.innerHTML=`
        <td>${sale.date || ''}</td>
        <td>${sale.code}</td>
        <td>${sale.name}</td>
        <td>${sale.price.toFixed(2)}</td>
        <td>${sale.quantity}</td>
        <td>${total}</td>
      `;
    }
    
    tbody.appendChild(row);
  });
  
  updateTotalSales(sales, title);
}

function updateTotalSales(sales, title){
  const total = sales.reduce((acc,s) => acc + s.price * s.quantity, 0).toFixed(2);
  document.querySelector('.total-sales').textContent = `${title}: ZMW ${total}`;
}

function filterByDate(){ 
  loadSalesByDate(document.getElementById('filterDate').value); 
}

function filterByMonth() {
  loadSalesByMonth(document.getElementById('filterMonth').value);
}

function toggleForm(){
  if (isProcessing) return;
  
  const form=document.querySelector('.form-container');
  form.style.display=form.style.display==='flex'?'none':'flex';
}

function toggleFilters(){
  const filters = document.getElementById('filterContainer');
  filters.classList.toggle('active');
  
  const toggleBtn = document.getElementById('toggleFilters');
  toggleBtn.textContent = filters.classList.contains('active') ? 'Hide Filters' : 'Show Filters';
}

function enableReverseMode(){
  if (isProcessing) return;
  
  reverseMode = !reverseMode;
  const btn = document.getElementById('reverseBtn');
  
  if (reverseMode) {
    btn.textContent = 'Confirm Reverse';
    btn.style.background = '#ff4444';
    btn.onclick = confirmReverseSales;
  } else {
    btn.textContent = 'Reverse Sale';
    btn.style.background = '#ffcc00';
    btn.onclick = enableReverseMode;
  }
  
  if (viewMode === 'daily') {
    const date = document.getElementById('filterDate').value;
    renderSalesTable(salesCache[date] || [], `Sales for ${date}`);
  } else {
    const month = document.getElementById('filterMonth').value;
    const cacheKey = `month-${month}`;
    renderSalesTable(salesCache[cacheKey] || [], `Sales for ${month}`);
  }
}

async function confirmReverseSales(){
  if (isProcessing) {
    alert("Please wait, another operation is in progress...");
    return;
  }
  
  const checkboxes = document.querySelectorAll('#salesTable tbody input[type="checkbox"]:checked');
  
  if(checkboxes.length === 0) {
    alert("Select at least one sale to reverse");
    enableReverseMode();
    return;
  }
  
  isProcessing = true;
  const reverseButton = document.getElementById('reverseBtn');
  const originalText = reverseButton.textContent;
  reverseButton.textContent = "Reversing...";
  reverseButton.disabled = true;
  
  try {
    for(const cb of checkboxes){
      const saleId = cb.dataset.id;
      const saleDate = cb.dataset.date;
      
      let sale;
      if (viewMode === 'daily') {
        sale = salesCache[saleDate].find(s => s.id === saleId);
      } else {
        const month = document.getElementById('filterMonth').value;
        const cacheKey = `month-${month}`;
        sale = salesCache[cacheKey].find(s => s.id === saleId);
      }
      
      if(!sale) continue;

      const item = inventory.find(i => i.code === sale.code);
      if(item){
        item.stock += sale.quantity;
        item.sold -= sale.quantity;
        await updateDoc(doc(db, "users", currentUserUID, "inventory", item.id), { 
          stock: item.stock, 
          sold: item.sold 
        });
      }
      
      await deleteDoc(doc(db, "users", currentUserUID, "sales", saleId));
      
      if (viewMode === 'daily') {
        salesCache[saleDate] = salesCache[saleDate].filter(s => s.id !== saleId);
      } else {
        const month = document.getElementById('filterMonth').value;
        const cacheKey = `month-${month}`;
        salesCache[cacheKey] = salesCache[cacheKey].filter(s => s.id !== saleId);
      }
    }
    
    populateProductOptions();
    
    alert("Sales reversed successfully!");
  } catch (error) {
    console.error("Error reversing sales:", error);
    alert("Error reversing sales. Please try again.");
  } finally {
    isProcessing = false;
    reverseButton.textContent = originalText;
    reverseButton.disabled = false;
    
    reverseMode = false;
    reverseButton.textContent = 'Reverse Sale';
    reverseButton.style.background = '#ffcc00';
    reverseButton.onclick = enableReverseMode;
    
    if (viewMode === 'daily') {
      const date = document.getElementById('filterDate').value;
      renderSalesTable(salesCache[date] || [], `Sales for ${date}`);
    } else {
      const month = document.getElementById('filterMonth').value;
      const cacheKey = `month-${month}`;
      renderSalesTable(salesCache[cacheKey] || [], `Sales for ${month}`);
    }
  }
}

window.makeSale = makeSale;
window.toggleForm = toggleForm;
window.filterByDate = filterByDate;
window.filterByMonth = filterByMonth;
window.enableReverseMode = enableReverseMode;
window.toggleFilters = toggleFilters;
     // -------------------------------
  // 1️⃣ Redirect after 15 minutes of inactivity
  // -------------------------------
  let inactivityTime = function () {
    let timer;
    const maxInactivity = 15 * 60 * 1000; // 15 minutes in milliseconds

    function resetTimer() {
      clearTimeout(timer);
      timer = setTimeout(() => {
       
        window.location.href = "index.html";
      }, maxInactivity);
    }

    // Listen to user events
    window.onload = resetTimer;
    document.onmousemove = resetTimer;
    document.onkeydown = resetTimer;
    document.onclick = resetTimer;
    document.onscroll = resetTimer;
  };

  inactivityTime();

  // -------------------------------
  // 2️⃣ Disable right-click
  // -------------------------------
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    
  });

  // -------------------------------
  // 3️⃣ Disable Ctrl+C, Ctrl+X, Ctrl+V
  // -------------------------------
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && (e.key === 'c' || e.key === 'x' || e.key === 'v')) {
      e.preventDefault();
      
    }
  });
</script>
</head>
<body>
<div class="container">
  <h2>Sales Dashboard</h2>
  
  <div class="buttons">
    <button onclick="toggleForm()">Toggle Sale Form</button>
    <button class="filter-toggle" id="toggleFilters" onclick="toggleFilters()">Show Filters</button>
    <button id="reverseBtn" onclick="enableReverseMode()">Reverse Sale</button>
  </div>
  
  <div id="filterContainer" class="filter-container">
    <div class="filter-group">
      <div class="filter-title">Daily Filter</div>
      <input type="date" id="filterDate">
      <button id="loadDayBtn" onclick="filterByDate()">Load Day</button>
    </div>
    
    <div class="filter-group">
      <div class="filter-title">Monthly Filter</div>
      <input type="month" id="filterMonth">
      <button id="loadMonthBtn" onclick="filterByMonth()">Load Month</button>
    </div>
  </div>
  
  <div class="form-container" style="display:none;">
    <form id="salesForm" onsubmit="makeSale(event)">
      <input type="date" id="saleDate" required>
      <select id="productCode" required>
        <option value="">Select Product</option>
      </select>
      <input type="number" id="quantity" placeholder="Quantity" min="1" required>
      <button type="submit">Record Sale</button>
    </form>
  </div>
  
  <div class="scroll-container">
    <table id="salesTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Code</th>
          <th>Name</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="6" style="text-align:center;">Loading today's sales...</td></tr>
      </tbody>
    </table>
  </div>
  
  <div class="total-sales">Today's Sales: Loading...</div>
</div>
</body>
</html>

