<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: #0f1220;
      color:#fff;
      min-height:100vh;
      padding:20px;
    }
    
    .container{
      width:100%;
      height:100vh;
      display:flex;
      flex-direction:column;
    }
    
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-bottom:15px;
      border-bottom:1px solid #27293d;
      flex-shrink:0;
    }
    
    h1{
      margin:0;
      font-size:24px;
    }
    
    .user-info{
      color:#b8b8cc;
      font-size:14px;
    }
    
    .btn{
      padding:8px 16px;
      border-radius:8px;
      border:none;
      background:#ffcc00;
      color:#111;
      font-weight:700;
      cursor:pointer;
    }
    
    .btn.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:#b8b8cc;
    }
    
    .btn.info{
      background:#2196f3;
      color:#fff;
    }
    
    .btn.success{
      background:#4caf50;
      color:#fff;
    }
    
    .btn.warning{
      background:#ff9800;
      color:#fff;
    }
    
    .tabs{
      display:flex;
      gap:4px;
      margin:15px 0;
      flex-shrink:0;
    }
    
    .tab-btn{
      padding:10px 20px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:transparent;
      color:#b8b8cc;
      cursor:pointer;
      font-weight:600;
    }
    
    .tab-btn.active{
      background:#2196f3;
      color:#fff;
      border-color:#2196f3;
    }
    
    .controls{
      display:flex;
      gap:10px;
      margin:15px 0;
      flex-shrink:0;
    }
    
    .input{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:transparent;
      color:#fff;
    }
    
    .content-area{
      flex:1;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    
    .tab-content{
      display:none;
      flex:1;
      overflow:hidden;
    }
    
    .tab-content.active{
      display:flex;
      flex-direction:column;
    }
    
    /* Make Sale Tab Styles */
    .sale-form{
      flex:1;
      overflow-y:auto;
      padding-right:10px;
    }
    
    .sale-section{
      background:#191b2a;
      border-radius:8px;
      padding:20px;
      margin-bottom:15px;
      border:1px solid rgba(255,255,255,0.03);
    }
    
    label{
      display:block;
      color:#b8b8cc;
      font-size:0.9rem;
      margin-bottom:6px;
    }
    
    input, select{
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:transparent;
      color:#fff;
      margin-bottom:16px;
    }
    
    .sale-item{
      display:flex;
      gap:12px;
      align-items:flex-end;
      margin-bottom:12px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    
    .item-product{flex:2}
    .item-qty{flex:1}
    .item-price{flex:1}
    .item-total{flex:1;text-align:right}
    .item-remove{flex:0.5}
    
    .remove-btn{
      color:#f44336;
      background:none;
      border:none;
      cursor:pointer;
      padding:8px;
    }
    
    .sale-summary{
      background:rgba(255,255,255,0.02);
      padding:16px;
      border-radius:8px;
      margin-top:20px;
    }
    
    .summary-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:8px;
    }
    
    .total-row{
      font-size:1.2rem;
      font-weight:700;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    
    .stock-warning{
      color:#f44336;
      font-size:0.9rem;
      margin-top:4px;
    }
    
    .empty{
      text-align:center;
      padding:40px;
      color:#b8b8cc;
    }
    
    .add-item-btn{
      width:100%;
      padding:10px;
      margin-top:10px;
      background:rgba(255,255,255,0.03);
      border:1px dashed rgba(255,255,255,0.06);
      color:#b8b8cc;
      border-radius:8px;
      cursor:pointer;
    }
    
    /* Sales History Tab Styles */
    .table-container{
      flex:1;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background:#191b2a;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.03);
    }
    
    .table-header{
      padding:15px;
      border-bottom:1px solid rgba(255,255,255,0.04);
      background:rgba(0,0,0,0.1);
      flex-shrink:0;
    }
    
    .table-scroll{
      flex:1;
      overflow-y:auto;
    }
    
    table{
      width:100%;
      border-collapse:collapse;
    }
    
    th{
      padding:12px 15px;
      text-align:left;
      color:#b8b8cc;
      font-weight:700;
      border-bottom:2px solid #27293d;
      position:sticky;
      top:0;
      background:#191b2a;
    }
    
    td{
      padding:12px 15px;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    
    tr:hover{
      background:rgba(255,255,255,0.02);
    }
    
    .badge{
      padding:4px 8px;
      border-radius:4px;
      font-size:0.8rem;
      font-weight:700;
    }
    
    .badge.success{
      background:rgba(76, 175, 80, 0.1);
      color:#4caf50;
    }
    
    .badge.pending{
      background:rgba(255, 152, 0, 0.1);
      color:#ff9800;
    }
    
    .badge.cancelled{
      background:rgba(244, 67, 54, 0.1);
      color:#f44336;
    }
    
    .customer-cell{
      max-width:200px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    
    .date-cell{
      white-space:nowrap;
    }
    
    .amount-cell{
      text-align:right;
      font-weight:700;
      color:#ffcc00;
    }
    
    .items-cell{
      color:#b8b8cc;
      font-size:0.9rem;
    }
    
    .summary-bar{
      display:flex;
      gap:30px;
      margin-top:15px;
      padding-top:15px;
      border-top:1px solid rgba(255,255,255,0.03);
      flex-shrink:0;
    }
    
    .summary-item{
      display:flex;
      flex-direction:column;
    }
    
    .summary-label{
      color:#b8b8cc;
      font-size:0.9rem;
    }
    
    .summary-value{
      font-size:1.2rem;
      font-weight:700;
    }
    
    .summary-value.total{
      color:#ffcc00;
    }
    
    .summary-value.count{
      color:#4caf50;
    }
    
    .summary-value.pending{
      color:#ff9800;
    }
    
    /* Sale Details Modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      visibility:hidden;
      opacity:0;
      transition:all .2s;
      z-index:1000;
      padding:20px;
    }
    
    .modal-overlay.show{
      visibility:visible;
      opacity:1;
    }
    
    .modal{
      width:100%;
      max-width:800px;
      max-height:90vh;
      background:#191b2a;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.03);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    
    .modal-header{
      padding:20px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      background:rgba(0,0,0,0.2);
    }
    
    .modal-body{
      flex:1;
      overflow-y:auto;
      padding:20px;
    }
    
    .modal-footer{
      padding:20px;
      border-top:1px solid rgba(255,255,255,0.03);
      background:rgba(0,0,0,0.2);
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
    
    .sale-details{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-bottom:20px;
    }
    
    .detail-group{
      margin-bottom:15px;
    }
    
    .detail-label{
      color:#b8b8cc;
      font-size:0.9rem;
      margin-bottom:5px;
    }
    
    .detail-value{
      font-size:1rem;
    }
    
    .items-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
    }
    
    .items-table th{
      padding:10px;
      font-size:0.9rem;
    }
    
    .items-table td{
      padding:10px;
      font-size:0.9rem;
    }
    
    /* Customer info styles */
    .customer-info {
      background: rgba(255, 204, 0, 0.05);
      border: 1px solid rgba(255, 204, 0, 0.1);
      border-radius: 8px;
      padding: 12px;
      margin-top: 5px;
      font-size: 0.85rem;
    }
    
    .customer-info i {
      color: #ffcc00;
      margin-right: 6px;
    }
    
    .no-customers {
      text-align: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
      margin-top: 10px;
    }
    
    .no-customers a {
      color: #ffcc00;
      text-decoration: none;
      font-weight: bold;
    }
    
    .no-customers a:hover {
      text-decoration: underline;
    }
    
    /* Warehouse selector */
    .warehouse-selector {
      margin-bottom: 16px;
    }
    
    .warehouse-buttons {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    
    .warehouse-btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.06);
      background: transparent;
      color: #b8b8cc;
      cursor: pointer;
      text-align: center;
    }
    
    .warehouse-btn.active {
      background: rgba(33, 150, 243, 0.2);
      border-color: #2196f3;
      color: #2196f3;
    }
    
    .warehouse-btn.hq {
      border-left: 4px solid #ffcc00;
    }
    
    .warehouse-btn.user {
      border-left: 4px solid #4caf50;
    }
    
    .commission-info {
      background: rgba(255, 204, 0, 0.1);
      border: 1px solid rgba(255, 204, 0, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    
    .commission-info i {
      color: #ffcc00;
      margin-right: 6px;
    }
    
    @media (max-width:768px){
      .sale-item{
        flex-wrap:wrap;
      }
      
      .sale-details{
        grid-template-columns:1fr;
      }
      
      .summary-bar{
        flex-wrap:wrap;
        gap:15px;
      }
      
      .controls{
        flex-wrap:wrap;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <a href="warehouse.html" style="color:#b8b8cc;text-decoration:none"><i class="fas fa-arrow-left"></i></a>
        <h1>Sales Management</h1>
        <div class="user-info" id="userEmail">Loading...</div>
        <div class="user-info" id="customerCount" style="font-size:0.85rem;color:#ffcc00;margin-top:3px"></div>
      </div>
      <div>
        <button class="btn ghost" id="btnLogout">Logout</button>
      </div>
    </div>
    
    <!-- Tabs for switching between functions -->
    <div class="tabs">
      <button class="tab-btn active" id="tabMakeSale">
        <i class="fas fa-cart-plus"></i> Make Sale
      </button>
      <button class="tab-btn" id="tabSalesHistory">
        <i class="fas fa-history"></i> Sales History
      </button>
    </div>
    
    <!-- Make Sale Tab Content -->
    <div class="tab-content active" id="makeSaleTab">
      <div class="sale-form">
        <!-- Warehouse Selection (Only for Admin) -->
        <div class="sale-section" id="warehouseSection" style="display:none">
          <h3 style="margin:0 0 16px 0"><i class="fas fa-warehouse"></i> Select Warehouse</h3>
          <div class="warehouse-buttons">
            <button class="warehouse-btn hq active" id="btnHQWarehouse">
              <i class="fas fa-home"></i> HQ Warehouse
            </button>
            <button class="warehouse-btn user" id="btnUserWarehouse">
              <i class="fas fa-user"></i> My Warehouse
            </button>
          </div>
          <div id="warehouseInfo" class="commission-info" style="display:none">
            <i class="fas fa-info-circle"></i>
            <span id="warehouseDetails">Selling from HQ Warehouse. Commission goes to customer owner.</span>
          </div>
        </div>
        
        <!-- Customer Selection -->
        <div class="sale-section">
          <h3 style="margin:0 0 16px 0"><i class="fas fa-user"></i> Customer</h3>
          <label for="customerSelect">Select Customer</label>
          <select id="customerSelect">
            <option value="">-- Select Customer --</option>
          </select>
          <div id="customerInfo" class="customer-info" style="display:none">
            <i class="fas fa-info-circle"></i>
            <span id="customerDetails">Customer details will appear here</span>
          </div>
          <div id="noCustomersMessage" class="no-customers" style="display:none">
            <p>No customers available.</p>
            <p style="font-size:0.8rem;color:#b8b8cc;margin-top:10px">Admin can sell to any customer</p>
          </div>
        </div>
        
        <!-- Sale Items -->
        <div class="sale-section">
          <h3 style="margin:0 0 16px 0"><i class="fas fa-shopping-cart"></i> Sale Items</h3>
          
          <div id="saleItems">
            <!-- Sale items will be added here -->
          </div>
          
          <button class="add-item-btn" id="btnAddItem">
            <i class="fas fa-plus"></i> Add Product
          </button>
        </div>
        
        <!-- Sale Summary -->
        <div class="sale-section">
          <h3 style="margin:0 0 16px 0"><i class="fas fa-receipt"></i> Sale Summary</h3>
          
          <div class="sale-summary">
            <div class="summary-row">
              <span>Subtotal:</span>
              <span id="subtotal">ZMW 0.00</span>
            </div>
            <div class="summary-row">
              <span>Items:</span>
              <span id="itemCount">0</span>
            </div>
            <div id="commissionInfo" class="summary-row" style="color:#4caf50; display:none">
              <span>Commission (10%):</span>
              <span id="commissionAmount">ZMW 0.00</span>
            </div>
            <div class="summary-row total-row">
              <span>Total:</span>
              <span id="total">ZMW 0.00</span>
            </div>
          </div>
          
          <button class="btn success" id="btnCompleteSale" style="width:100%;margin-top:20px;padding:12px">
            <i class="fas fa-check-circle"></i> Complete Sale
          </button>
        </div>
      </div>
    </div>
    
    <!-- Sales History Tab Content -->
    <div class="tab-content" id="salesHistoryTab">
      <div class="controls">
        <input type="text" id="searchInput" class="input" placeholder="Search by customer, product..." style="flex:1">
        <select id="statusFilter" class="input" style="width:150px">
          <option value="all">All Status</option>
          <option value="completed">Completed</option>
          <option value="pending">Pending</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <input type="date" id="dateFrom" class="input" style="width:150px">
        <input type="date" id="dateTo" class="input" style="width:150px">
        <button class="btn ghost" id="btnClearFilters"><i class="fas fa-times"></i> Clear</button>
        <button class="btn info" id="btnRefresh"><i class="fas fa-sync"></i> Refresh</button>
      </div>
      
      <div class="table-container">
        <div class="table-header">
          <strong>All Sales</strong>
        </div>
        
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th style="width:150px">Date & Time</th>
                <th>Customer</th>
                <th style="width:120px">Items</th>
                <th style="width:100px">Status</th>
                <th style="width:120px;text-align:right">Amount (ZMW)</th>
                <th style="width:80px">Actions</th>
              </tr>
            </thead>
            <tbody id="salesBody">
              <tr><td colspan="6" class="empty">Loading sales...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="summary-bar">
        <div class="summary-item">
          <div class="summary-label">Total Sales</div>
          <div class="summary-value count" id="totalSales">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Total Amount</div>
          <div class="summary-value total" id="totalAmount">ZMW 0.00</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Completed</div>
          <div class="summary-value count" id="completedSales">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Pending</div>
          <div class="summary-value pending" id="pendingSales">0</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sale Details Modal -->
  <div id="detailsModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 style="margin:0">Sale Details</h3>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Sale details will be loaded here -->
      </div>
      <div class="modal-footer">
        <button class="btn ghost" id="modalClose">Close</button>
        <button class="btn info" id="btnPrintReceipt"><i class="fas fa-print"></i> Print Receipt</button>
      </div>
    </div>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
        getFirestore,
        collection,
        query,
        where,
        orderBy,
        getDocs,
        getDoc,
        addDoc,
        writeBatch,
        serverTimestamp,
        doc,
        updateDoc,
        runTransaction
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
        authDomain: "trismart-online-app.firebasestorage.app",
        projectId: "trismart-online-app",
        storageBucket: "trismart-online-app.firebasestorage.app",
        messagingSenderId: "867677912389",
        appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
        measurementId: "G-KEWDREKNDB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const userEmailEl = document.getElementById('userEmail');
    const customerCountEl = document.getElementById('customerCount');
    const btnLogout = document.getElementById('btnLogout');
    
    // Tab elements
    const tabMakeSale = document.getElementById('tabMakeSale');
    const tabSalesHistory = document.getElementById('tabSalesHistory');
    const makeSaleTab = document.getElementById('makeSaleTab');
    const salesHistoryTab = document.getElementById('salesHistoryTab');
    
    // Make Sale elements
    const customerSelect = document.getElementById('customerSelect');
    const saleItems = document.getElementById('saleItems');
    const btnAddItem = document.getElementById('btnAddItem');
    const btnCompleteSale = document.getElementById('btnCompleteSale');
    const subtotalEl = document.getElementById('subtotal');
    const itemCountEl = document.getElementById('itemCount');
    const totalEl = document.getElementById('total');
    const customerInfo = document.getElementById('customerInfo');
    const customerDetails = document.getElementById('customerDetails');
    const noCustomersMessage = document.getElementById('noCustomersMessage');
    const commissionInfo = document.getElementById('commissionInfo');
    const commissionAmount = document.getElementById('commissionAmount');
    
    // Warehouse elements (for admin)
    const warehouseSection = document.getElementById('warehouseSection');
    const btnHQWarehouse = document.getElementById('btnHQWarehouse');
    const btnUserWarehouse = document.getElementById('btnUserWarehouse');
    const warehouseInfo = document.getElementById('warehouseInfo');
    const warehouseDetails = document.getElementById('warehouseDetails');
    
    // Sales History elements
    const btnRefresh = document.getElementById('btnRefresh');
    const btnClearFilters = document.getElementById('btnClearFilters');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    const salesBody = document.getElementById('salesBody');
    const totalSalesEl = document.getElementById('totalSales');
    const totalAmountEl = document.getElementById('totalAmount');
    const completedSalesEl = document.getElementById('completedSales');
    const pendingSalesEl = document.getElementById('pendingSales');
    
    // Modal elements
    const detailsModal = document.getElementById('detailsModal');
    const modalBody = document.getElementById('modalBody');
    const modalClose = document.getElementById('modalClose');
    const btnPrintReceipt = document.getElementById('btnPrintReceipt');

    let currentUser = null;
    let userProducts = [];
    let hqProducts = []; // HQ stock products
    let allCustomers = []; // All customers for admin
    let myCustomers = []; // My customers for regular users
    let saleItemsList = [];
    let salesData = [];
    let isAdmin = false;
    let sellingFromHQ = true; // Default for admin, false for regular users
    
    // Set default dates for history filter
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setDate(today.getDate() - 30);
    if (dateFrom) dateFrom.value = lastMonth.toISOString().split('T')[0];
    if (dateTo) dateTo.value = today.toISOString().split('T')[0];

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'index.html';
            return;
        }
        currentUser = user;
        userEmailEl.textContent = user.email;
        
        // Check if user is admin (chris)
        isAdmin = user.email.toLowerCase() === 'chrischishe@gmail.com';
        
        console.log('User is admin:', isAdmin, 'Email:', user.email);
        
        // Show/hide warehouse selector for admin
        if (isAdmin) {
            warehouseSection.style.display = 'block';
            warehouseInfo.style.display = 'block';
            sellingFromHQ = true;
            updateWarehouseInfo();
        } else {
            warehouseSection.style.display = 'none';
            sellingFromHQ = false; // Regular users sell from their own warehouse
        }
        
        // Load initial data
        if (isAdmin && sellingFromHQ) {
            loadHQProducts(); // Admin selling from HQ
        } else {
            loadUserProducts(); // User selling from their warehouse
        }
        loadCustomers();
        loadSales(); // Load sales history initially
    });

    // Tab switching
    tabMakeSale.addEventListener('click', () => {
        tabMakeSale.classList.add('active');
        tabSalesHistory.classList.remove('active');
        makeSaleTab.classList.add('active');
        salesHistoryTab.classList.remove('active');
        
        // Refresh products when switching to make sale tab
        if (isAdmin && sellingFromHQ) {
            loadHQProducts();
        } else {
            loadUserProducts();
        }
    });
    
    tabSalesHistory.addEventListener('click', () => {
        tabSalesHistory.classList.add('active');
        tabMakeSale.classList.remove('active');
        salesHistoryTab.classList.add('active');
        makeSaleTab.classList.remove('active');
        
        // Refresh sales when switching to history tab
        loadSales();
    });

    // Warehouse selection (admin only)
    btnHQWarehouse.addEventListener('click', () => {
        if (!isAdmin) return;
        sellingFromHQ = true;
        btnHQWarehouse.classList.add('active');
        btnUserWarehouse.classList.remove('active');
        updateWarehouseInfo();
        loadHQProducts();
        // Clear sale items when switching warehouse
        saleItemsList = [];
        renderSaleItems();
    });
    
    btnUserWarehouse.addEventListener('click', () => {
        if (!isAdmin) return;
        sellingFromHQ = false;
        btnUserWarehouse.classList.add('active');
        btnHQWarehouse.classList.remove('active');
        updateWarehouseInfo();
        loadUserProducts();
        // Clear sale items when switching warehouse
        saleItemsList = [];
        renderSaleItems();
    });
    
    function updateWarehouseInfo() {
        if (sellingFromHQ) {
            warehouseDetails.innerHTML = `
                <strong>Selling from HQ Warehouse</strong><br>
                Commission goes to the customer owner (sales agent who added the customer)
            `;
        } else {
            warehouseDetails.innerHTML = `
                <strong>Selling from Your Warehouse</strong><br>
                You earn commission from your own sales
            `;
        }
    }

    // ========== PRODUCT LOADING ==========
    
    // Load HQ products (for admin selling from HQ)
    async function loadHQProducts() {
        try {
            const productsQuery = query(
                collection(db, 'products'),
                orderBy('code')
            );
            
            const snapshot = await getDocs(productsQuery);
            hqProducts = [];
            
            snapshot.docs.forEach(docSnap => {
                const data = docSnap.data();
                if (data.stock > 0) {
                    hqProducts.push({
                        id: docSnap.id,
                        code: data.code,
                        name: data.name,
                        price: data.price || 0,
                        stock: data.stock || 0
                    });
                }
            });
            
            console.log('Loaded HQ products:', hqProducts.length);
            
        } catch (error) {
            console.error('Error loading HQ products:', error);
            hqProducts = [];
        }
    }

    // Load user's warehouse products
    async function loadUserProducts() {
        const userEmail = currentUser.email;
        
        try {
            const userWarehouseQuery = query(
                collection(db, 'userWarehouse'),
                where('userEmail', '==', userEmail)
            );
            
            const snapshot = await getDocs(userWarehouseQuery);
            userProducts = [];
            
            snapshot.docs.forEach(docSnap => {
                const data = docSnap.data();
                if (data.warehouseStock > 0) {
                    userProducts.push({
                        id: docSnap.id,
                        productId: data.productId,
                        code: data.productCode,
                        name: data.productName,
                        price: data.price,
                        stock: data.warehouseStock
                    });
                }
            });
            
            // Sort by product code
            userProducts.sort((a, b) => (a.code || '').localeCompare(b.code || ''));
            
        } catch (error) {
            console.error('Error loading products:', error);
            userProducts = [];
        }
    }

    // Load customers
    async function loadCustomers() {
        try {
            console.log('Loading customers for user:', currentUser.email);
            
            if (isAdmin) {
                // Admin can see ALL customers
                const customersQuery = query(collection(db, 'customers'));
                const snapshot = await getDocs(customersQuery);
                
                allCustomers = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data()
                }));
                myCustomers = [...allCustomers];
            } else {
                // Regular users can only see customers THEY added
                const customersQuery = query(
                    collection(db, 'customers'),
                    where('createdBy', '==', currentUser.uid)
                );
                
                const snapshot = await getDocs(customersQuery);
                myCustomers = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data()
                }));
                allCustomers = [...myCustomers];
            }
            
            console.log('Loaded customers:', allCustomers.length, 'Admin mode:', isAdmin);
            
            // Update customer count display
            customerCountEl.textContent = `Available customers: ${allCustomers.length}`;
            
            // Populate customer dropdown
            customerSelect.innerHTML = '<option value="">-- Select Customer --</option>';
            
            if (allCustomers.length === 0) {
                noCustomersMessage.style.display = 'block';
                customerSelect.style.display = 'none';
                customerInfo.style.display = 'none';
            } else {
                noCustomersMessage.style.display = 'none';
                customerSelect.style.display = 'block';
                
                allCustomers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} (${customer.phone || 'No phone'})`;
                    if (customer.createdByEmail) {
                        option.textContent += ` - Added by: ${customer.createdByEmail}`;
                    }
                    customerSelect.appendChild(option);
                });
            }
            
        } catch (error) {
            console.error('Error loading customers:', error);
            allCustomers = [];
            myCustomers = [];
            customerSelect.innerHTML = '<option value="">-- Select Customer --</option>' +
                                      '<option value="" disabled>Error loading customers</option>';
            customerCountEl.textContent = 'Error loading customers';
        }
    }

    // ========== MAKE SALE FUNCTIONALITY ==========
    
    // Add sale item
    btnAddItem.addEventListener('click', () => {
        const availableProducts = sellingFromHQ ? hqProducts : userProducts;
        
        if (availableProducts.length === 0) {
            alert('No products available in selected warehouse');
            return;
        }
        
        const saleItem = {
            id: Date.now(), // Unique ID for this item
            productId: '',
            productCode: '',
            productName: '',
            price: 0,
            quantity: 1,
            availableStock: 0
        };
        
        saleItemsList.push(saleItem);
        renderSaleItems();
    });

    // Customer selection change handler
    customerSelect.addEventListener('change', (e) => {
        const customerId = e.target.value;
        if (!customerId) {
            customerInfo.style.display = 'none';
            return;
        }
        
        const customer = allCustomers.find(c => c.id === customerId);
        if (customer) {
            let customerInfoText = `<strong>${customer.name}</strong><br>`;
            if (customer.phone) customerInfoText += `<i class="fas fa-phone"></i> ${customer.phone}<br>`;
            if (customer.address) customerInfoText += `<i class="fas fa-map-marker-alt"></i> ${customer.address}<br>`;
            if (customer.createdByEmail) customerInfoText += `<i class="fas fa-user-tag"></i> Added by: ${customer.createdByEmail}`;
            
            customerDetails.innerHTML = customerInfoText;
            customerInfo.style.display = 'block';
            
            // Update commission info if selling from HQ
            if (isAdmin && sellingFromHQ && customer.createdByEmail) {
                commissionInfo.style.display = 'flex';
                updateSaleSummary(); // Update commission display
            } else {
                commissionInfo.style.display = 'none';
            }
        }
    });

    // Render sale items
    function renderSaleItems() {
        if (saleItemsList.length === 0) {
            saleItems.innerHTML = '<div class="empty">Add products to sale</div>';
            updateSaleSummary();
            return;
        }
        
        const availableProducts = sellingFromHQ ? hqProducts : userProducts;
        
        saleItems.innerHTML = saleItemsList.map((item, index) => {
            // Get available products for dropdown
            const productOptions = availableProducts.map(product => {
                const selected = (sellingFromHQ ? product.id : product.productId) === item.productId ? 'selected' : '';
                return `<option value="${sellingFromHQ ? product.id : product.productId}" ${selected}>${product.code} - ${product.name} (Stock: ${product.stock}, Price: ZMW ${product.price.toFixed(2)})</option>`;
            }).join('');
            
            const subtotal = item.price * item.quantity;
            
            return `
                <div class="sale-item">
                    <div class="item-product">
                        <label>Product</label>
                        <select class="product-select" data-index="${index}">
                            <option value="">-- Select Product --</option>
                            ${productOptions}
                        </select>
                        ${item.availableStock > 0 ? `<div class="stock-warning">Available: ${item.availableStock}</div>` : ''}
                    </div>
                    <div class="item-qty">
                        <label>Qty</label>
                        <input type="number" min="1" value="${item.quantity}" data-index="${index}" class="quantity-input">
                    </div>
                    <div class="item-price">
                        <label>Price (ZMW)</label>
                        <input type="number" step="0.01" min="0" value="${item.price.toFixed(2)}" data-index="${index}" class="price-input">
                    </div>
                    <div class="item-total">
                        <label>Total (ZMW)</label>
                        <div>ZMW ${subtotal.toFixed(2)}</div>
                    </div>
                    <div class="item-remove">
                        <label>&nbsp;</label>
                        <button class="remove-btn" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        updateSaleSummary();
        attachSaleItemListeners();
    }

    // Attach event listeners to sale items
    function attachSaleItemListeners() {
        const availableProducts = sellingFromHQ ? hqProducts : userProducts;
        
        // Product selection
        document.querySelectorAll('.product-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const index = parseInt(e.target.dataset.index);
                const productId = e.target.value;
                
                const product = availableProducts.find(p => 
                    (sellingFromHQ ? p.id : p.productId) === productId
                );
                
                if (product) {
                    saleItemsList[index].productId = productId;
                    saleItemsList[index].productCode = product.code;
                    saleItemsList[index].productName = product.name;
                    saleItemsList[index].price = product.price;
                    saleItemsList[index].availableStock = product.stock;
                    
                    // Auto-set quantity to 1 if it's 0
                    if (saleItemsList[index].quantity < 1) {
                        saleItemsList[index].quantity = 1;
                    }
                    
                    // Limit quantity to available stock
                    if (saleItemsList[index].quantity > product.stock) {
                        saleItemsList[index].quantity = product.stock;
                    }
                } else {
                    saleItemsList[index].productId = '';
                    saleItemsList[index].productCode = '';
                    saleItemsList[index].productName = '';
                    saleItemsList[index].price = 0;
                    saleItemsList[index].availableStock = 0;
                }
                
                renderSaleItems();
            });
        });
        
        // Quantity input
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const index = parseInt(e.target.dataset.index);
                const quantity = parseInt(e.target.value) || 1;
                
                // Validate quantity
                if (quantity < 1) {
                    saleItemsList[index].quantity = 1;
                } else if (saleItemsList[index].availableStock > 0 && quantity > saleItemsList[index].availableStock) {
                    saleItemsList[index].quantity = saleItemsList[index].availableStock;
                    alert(`Maximum available stock: ${saleItemsList[index].availableStock}`);
                } else {
                    saleItemsList[index].quantity = quantity;
                }
                
                renderSaleItems();
            });
        });
        
        // Price input
        document.querySelectorAll('.price-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const index = parseInt(e.target.dataset.index);
                const price = parseFloat(e.target.value) || 0;
                saleItemsList[index].price = price;
                renderSaleItems();
            });
        });
        
        // Remove buttons
        document.querySelectorAll('.remove-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.target.closest('button').dataset.index);
                saleItemsList.splice(index, 1);
                renderSaleItems();
            });
        });
    }

    // Update sale summary
    function updateSaleSummary() {
        let subtotal = 0;
        let itemCount = 0;
        
        saleItemsList.forEach(item => {
            if (item.productId && item.quantity > 0) {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                itemCount += item.quantity;
            }
        });
        
        subtotalEl.textContent = `ZMW ${subtotal.toFixed(2)}`;
        itemCountEl.textContent = itemCount;
        totalEl.textContent = `ZMW ${subtotal.toFixed(2)}`;
        
        // Update commission info if applicable
        const customerId = customerSelect.value;
        const customer = allCustomers.find(c => c.id === customerId);
        
        if (isAdmin && sellingFromHQ && customer && customer.createdByEmail) {
            const commission = subtotal * 0.10;
            commissionAmount.textContent = `ZMW ${commission.toFixed(2)}`;
            commissionInfo.style.display = 'flex';
        } else {
            commissionInfo.style.display = 'none';
        }
    }

    // Function to create commission for customer owner
    async function createCommissionForCustomerOwner(saleDocRef, saleData, saleTotal, customerOwnerEmail, customerOwnerId) {
        try {
            if (!customerOwnerEmail || !customerOwnerId) {
                console.log('No customer owner found for commission');
                return;
            }
            
            // Calculate 10% commission
            const commissionAmount = saleTotal * 0.10;
            
            if (commissionAmount <= 0) {
                console.log('No commission to create (sale amount is 0)');
                return;
            }
            
            // Prepare commission data
            const commissionData = {
                userId: customerOwnerId,
                userEmail: customerOwnerEmail,
                userName: customerOwnerEmail.split('@')[0], // Use email prefix as name
                saleId: saleDocRef.id,
                saleAmount: saleTotal,
                amount: commissionAmount,
                customerName: saleData.customerName || 'Unknown Customer',
                soldByAdmin: true,
                adminEmail: currentUser.email,
                status: 'pending',
                commissionRate: 0.10, // 10%
                saleDate: saleData.saleDate || new Date().toISOString(),
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                notes: `Commission from admin sale to ${saleData.customerName}`
            };
            
            // Add commission to database
            const commissionsRef = collection(db, 'commissions');
            await addDoc(commissionsRef, commissionData);
            
            console.log('Commission created for customer owner:', customerOwnerEmail, commissionAmount);
            
        } catch (error) {
            console.error('Error creating commission for customer owner:', error);
        }
    }

    // Complete sale
    btnCompleteSale.addEventListener('click', async () => {
        // Validate customer
        const customerId = customerSelect.value;
        if (!customerId) {
            alert('Please select a customer');
            return;
        }
        
        // Validate sale items
        const validItems = saleItemsList.filter(item => 
            item.productId && item.quantity > 0 && item.price > 0
        );
        
        if (validItems.length === 0) {
            alert('Please add at least one product to the sale');
            return;
        }
        
        // Check stock availability
        const availableProducts = sellingFromHQ ? hqProducts : userProducts;
        
        for (const item of validItems) {
            const product = availableProducts.find(p => 
                (sellingFromHQ ? p.id : p.productId) === item.productId
            );
            
            if (!product) {
                alert(`Product ${item.productName} is no longer available in selected warehouse`);
                return;
            }
            
            if (item.quantity > product.stock) {
                alert(`Insufficient stock for ${product.code}. Available: ${product.stock}, Requested: ${item.quantity}`);
                return;
            }
        }
        
        const customer = allCustomers.find(c => c.id === customerId);
        const total = validItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        // Prepare confirmation message based on who gets commission
        let confirmationMessage = `Complete sale to ${customer.name} for ZMW ${total.toFixed(2)}?`;
        
        if (isAdmin && sellingFromHQ && customer.createdByEmail) {
            confirmationMessage += `\n\nCommission (10%): ZMW ${(total * 0.10).toFixed(2)} will go to: ${customer.createdByEmail}`;
        } else if (!sellingFromHQ) {
            confirmationMessage += `\n\nYou will earn 10% commission: ZMW ${(total * 0.10).toFixed(2)}`;
        } else {
            confirmationMessage += `\n\nNo commission (admin selling from HQ to customer without owner)`;
        }
        
        if (!confirm(confirmationMessage)) {
            return;
        }
        
        try {
            // Create sale record
            const saleData = {
                customerId: customerId,
                customerName: customer.name,
                customerPhone: customer.phone || '',
                customerAddress: customer.address || '',
                customerEmail: customer.email || '',
                sellerId: currentUser.uid,
                sellerEmail: currentUser.email,
                items: validItems.map(item => ({
                    productId: item.productId,
                    productCode: item.productCode,
                    productName: item.productName,
                    quantity: item.quantity,
                    price: item.price,
                    total: item.price * item.quantity
                })),
                subtotal: total,
                total: total,
                status: 'completed',
                saleDate: new Date().toISOString(),
                createdAt: serverTimestamp(),
                timestamp: new Date().getTime(),
                soldFromHQ: sellingFromHQ,
                warehouseType: sellingFromHQ ? 'hq' : 'user'
            };
            
            console.log('Saving sale:', saleData);
            
            // Add sale to database
            const salesRef = collection(db, 'sales');
            const saleDocRef = await addDoc(salesRef, saleData);
            
            console.log('Sale saved with ID:', saleDocRef.id);
            
            // Handle stock deduction and commission based on warehouse type
            const batch = writeBatch(db);
            
            if (sellingFromHQ) {
                // Selling from HQ - deduct from HQ stock
                for (const item of validItems) {
                    const productRef = doc(db, "products", item.productId);
                    const productSnap = await getDoc(productRef);
                    
                    if (productSnap.exists()) {
                        const productData = productSnap.data();
                        const newStock = (productData.stock || 0) - item.quantity;
                        
                        if (newStock < 0) {
                            throw new Error(`Insufficient HQ stock for ${item.productName}`);
                        }
                        
                        batch.update(productRef, {
                            stock: newStock,
                            updatedAt: serverTimestamp()
                        });
                    }
                }
                
                // Create commission for customer owner if exists
                if (customer.createdByEmail && customer.createdBy) {
                    await createCommissionForCustomerOwner(
                        saleDocRef, 
                        saleData, 
                        total, 
                        customer.createdByEmail, 
                        customer.createdBy
                    );
                }
                
            } else {
                // Selling from user warehouse - deduct from user's stock
                const userEmail = currentUser.email;
                
                for (const item of validItems) {
                    // Find the userWarehouse document for this product
                    const userWarehouseQuery = query(
                        collection(db, 'userWarehouse'),
                        where('userEmail', '==', userEmail),
                        where('productId', '==', item.productId)
                    );
                    
                    const userWarehouseSnap = await getDocs(userWarehouseQuery);
                    
                    if (!userWarehouseSnap.empty) {
                        const userWarehouseDoc = userWarehouseSnap.docs[0];
                        const userWarehouseData = userWarehouseDoc.data();
                        const newStock = userWarehouseData.warehouseStock - item.quantity;
                        
                        if (newStock <= 0) {
                            // Delete if stock is 0 or less
                            batch.delete(userWarehouseDoc.ref);
                        } else {
                            batch.update(userWarehouseDoc.ref, {
                                warehouseStock: newStock,
                                lastUpdated: serverTimestamp(),
                                lastSaleDate: new Date().toISOString()
                            });
                        }
                    }
                }
                
                // Create commission for seller (user themselves)
                if (!isAdmin) { // Only regular users get commission from their own sales
                    const commissionData = {
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        userName: currentUser.displayName || currentUser.email.split('@')[0],
                        saleId: saleDocRef.id,
                        saleAmount: total,
                        amount: total * 0.10,
                        customerName: customer.name,
                        status: 'pending',
                        commissionRate: 0.10,
                        saleDate: new Date().toISOString(),
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    const commissionsRef = collection(db, 'commissions');
                    await addDoc(commissionsRef, commissionData);
                }
            }
            
            await batch.commit();
            
            // Show success message
            let successMessage = `Sale completed successfully!\n\nTotal: ZMW ${total.toFixed(2)}`;
            
            if (isAdmin && sellingFromHQ && customer.createdByEmail) {
                successMessage += `\nCommission (10%): ZMW ${(total * 0.10).toFixed(2)} will go to: ${customer.createdByEmail}`;
            } else if (!sellingFromHQ && !isAdmin) {
                successMessage += `\nYour Commission: ZMW ${(total * 0.10).toFixed(2)} (10%)`;
                successMessage += `\n\nCommission will appear in your commission dashboard.`;
            }
            
            alert(successMessage);
            
            // Reset form
            saleItemsList = [];
            customerSelect.value = '';
            customerInfo.style.display = 'none';
            commissionInfo.style.display = 'none';
            renderSaleItems();
            
            // Refresh products to update stock
            if (sellingFromHQ) {
                loadHQProducts();
            } else {
                loadUserProducts();
            }
            
            // Switch to sales history tab and refresh
            tabSalesHistory.click();
            loadSales();
            
        } catch (err) {
            console.error('Sale error:', err);
            alert('Failed to complete sale: ' + err.message);
        }
    });

    // ========== SALES HISTORY FUNCTIONALITY ==========
    
    async function loadSales() {
        try {
            console.log('Loading sales for user:', currentUser.email);
            
            salesBody.innerHTML = '<tr><td colspan="6" class="empty">Loading sales...</td></tr>';
            
            let snapshot;
            
            if (isAdmin) {
                // Admin can see ALL sales
                try {
                    const salesQuery = query(
                        collection(db, 'sales'),
                        orderBy('timestamp', 'desc')
                    );
                    snapshot = await getDocs(salesQuery);
                } catch (orderError) {
                    console.log('OrderBy failed for admin, trying without:', orderError);
                    const salesQuery = query(collection(db, 'sales'));
                    snapshot = await getDocs(salesQuery);
                }
            } else {
                // Regular users can only see their own sales
                try {
                    const salesQuery = query(
                        collection(db, 'sales'),
                        where('sellerEmail', '==', currentUser.email),
                        orderBy('timestamp', 'desc')
                    );
                    snapshot = await getDocs(salesQuery);
                } catch (orderError) {
                    console.log('OrderBy failed, trying without:', orderError);
                    const salesQuery = query(
                        collection(db, 'sales'),
                        where('sellerEmail', '==', currentUser.email)
                    );
                    snapshot = await getDocs(salesQuery);
                }
            }
            
            if (snapshot.empty) {
                console.log('No sales found in database');
                salesData = [];
                salesBody.innerHTML = '<tr><td colspan="6" class="empty">No sales yet. Make your first sale!</td></tr>';
                updateHistorySummary([]);
                return;
            }
            
            salesData = [];
            snapshot.forEach(doc => {
                try {
                    const data = doc.data();
                    console.log('Found sale:', doc.id, data);
                    salesData.push({
                        id: doc.id,
                        ...data
                    });
                } catch (error) {
                    console.error('Error processing sale document:', error);
                }
            });
            
            console.log('Total sales loaded:', salesData.length, 'Admin mode:', isAdmin);
            
            if (salesData.length === 0) {
                salesBody.innerHTML = '<tr><td colspan="6" class="empty">No sales data found</td></tr>';
                updateHistorySummary([]);
                return;
            }
            
            renderSales();
            
        } catch (error) {
            console.error('Error loading sales:', error);
            console.error('Error details:', error.code, error.message);
            
            // Try a simpler approach as fallback
            try {
                console.log('Trying fallback query...');
                const salesRef = collection(db, 'sales');
                const allDocs = await getDocs(salesRef);
                const allSales = [];
                
                allDocs.forEach(doc => {
                    const data = doc.data();
                    // Show all for admin, only own sales for regular users
                    if (isAdmin || data.sellerEmail === currentUser.email) {
                        allSales.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                if (allSales.length > 0) {
                    console.log('Fallback found sales:', allSales.length);
                    salesData = allSales;
                    renderSales();
                    return;
                }
            } catch (fallbackError) {
                console.error('Fallback also failed:', fallbackError);
            }
            
            salesBody.innerHTML = '<tr><td colspan="6" class="empty">No sales found. Make a sale first!</td></tr>';
            updateHistorySummary([]);
        }
    }

    function renderSales() {
        if (!salesData || salesData.length === 0) {
            salesBody.innerHTML = '<tr><td colspan="6" class="empty">No sales found</td></tr>';
            updateHistorySummary([]);
            return;
        }
        
        console.log('Rendering sales:', salesData.length, 'Admin mode:', isAdmin);
        
        // Apply filters
        let filteredSales = [...salesData];
        
        // Date filter
        if (dateFrom.value) {
            const fromDate = new Date(dateFrom.value);
            fromDate.setHours(0, 0, 0, 0);
            filteredSales = filteredSales.filter(sale => {
                let saleDate;
                if (sale.timestamp) {
                    saleDate = new Date(sale.timestamp);
                } else if (sale.saleDate) {
                    saleDate = new Date(sale.saleDate);
                } else if (sale.createdAt && sale.createdAt.toDate) {
                    saleDate = sale.createdAt.toDate();
                } else if (sale.createdAt) {
                    saleDate = new Date(sale.createdAt);
                } else {
                    return false;
                }
                return saleDate >= fromDate;
            });
        }
        
        if (dateTo.value) {
            const toDate = new Date(dateTo.value);
            toDate.setHours(23, 59, 59, 999); // End of day
            filteredSales = filteredSales.filter(sale => {
                let saleDate;
                if (sale.timestamp) {
                    saleDate = new Date(sale.timestamp);
                } else if (sale.saleDate) {
                    saleDate = new Date(sale.saleDate);
                } else if (sale.createdAt && sale.createdAt.toDate) {
                    saleDate = sale.createdAt.toDate();
                } else if (sale.createdAt) {
                    saleDate = new Date(sale.createdAt);
                } else {
                    return false;
                }
                return saleDate <= toDate;
            });
        }
        
        // Status filter
        if (statusFilter.value !== 'all') {
            filteredSales = filteredSales.filter(sale => sale.status === statusFilter.value);
        }
        
        // Search filter
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            filteredSales = filteredSales.filter(sale => 
                (sale.customerName && sale.customerName.toLowerCase().includes(searchTerm)) ||
                (sale.customerEmail && sale.customerEmail.toLowerCase().includes(searchTerm)) ||
                (sale.sellerEmail && sale.sellerEmail.toLowerCase().includes(searchTerm)) ||
                (sale.items && sale.items.some(item => 
                    item.productName && item.productName.toLowerCase().includes(searchTerm)
                ))
            );
        }
        
        if (filteredSales.length === 0) {
            salesBody.innerHTML = '<tr><td colspan="6" class="empty">No sales match your filters</td></tr>';
            updateHistorySummary([]);
            return;
        }
        
        // Sort by timestamp or date
        filteredSales.sort((a, b) => {
            const dateA = a.timestamp || (a.saleDate ? new Date(a.saleDate).getTime() : 0);
            const dateB = b.timestamp || (b.saleDate ? new Date(b.saleDate).getTime() : 0);
            return dateB - dateA; // Newest first
        });
        
        // Render sales table
        salesBody.innerHTML = filteredSales.map(sale => {
            let saleDate;
            let formattedDate = 'N/A';
            
            // Try different date fields
            if (sale.timestamp) {
                saleDate = new Date(sale.timestamp);
                formattedDate = saleDate.toLocaleDateString() + ' ' + saleDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } else if (sale.saleDate) {
                saleDate = new Date(sale.saleDate);
                formattedDate = saleDate.toLocaleDateString() + ' ' + saleDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } else if (sale.createdAt && sale.createdAt.toDate) {
                saleDate = sale.createdAt.toDate();
                formattedDate = saleDate.toLocaleDateString() + ' ' + saleDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } else if (sale.createdAt) {
                saleDate = new Date(sale.createdAt);
                formattedDate = saleDate.toLocaleDateString() + ' ' + saleDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            const totalItems = sale.items ? sale.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;
            
            let statusBadge = '';
            switch(sale.status) {
                case 'completed':
                    statusBadge = '<span class="badge success">Completed</span>';
                    break;
                case 'pending':
                    statusBadge = '<span class="badge pending">Pending</span>';
                    break;
                case 'cancelled':
                    statusBadge = '<span class="badge cancelled">Cancelled</span>';
                    break;
                default:
                    statusBadge = `<span class="badge">${sale.status || 'N/A'}</span>`;
            }
            
            // Add warehouse info and seller info for admin view
            let extraInfo = '';
            if (isAdmin) {
                extraInfo += `<br><small style="color:#b8b8cc">`;
                if (sale.soldFromHQ) {
                    extraInfo += `HQ Sale`;
                } else {
                    extraInfo += `User Sale`;
                }
                extraInfo += ` | Sold by: ${sale.sellerEmail || 'Unknown'}</small>`;
            }
            
            return `
                <tr data-id="${sale.id}">
                    <td class="date-cell">${formattedDate}</td>
                    <td class="customer-cell" title="${sale.customerName || 'N/A'}">
                        ${sale.customerName || 'N/A'}
                        ${extraInfo}
                    </td>
                    <td class="items-cell">${totalItems} items</td>
                    <td>${statusBadge}</td>
                    <td class="amount-cell">ZMW ${(sale.total || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn ghost view-details" style="padding:4px 8px;font-size:0.8rem" data-id="${sale.id}">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        updateHistorySummary(filteredSales);
        attachHistoryEventListeners();
    }

    function updateHistorySummary(sales) {
        const totalSales = sales.length;
        const totalAmount = sales.reduce((sum, sale) => sum + (sale.total || 0), 0);
        const completedSales = sales.filter(sale => sale.status === 'completed').length;
        const pendingSales = sales.filter(sale => sale.status === 'pending').length;
        
        totalSalesEl.textContent = totalSales;
        totalAmountEl.textContent = `ZMW ${totalAmount.toFixed(2)}`;
        completedSalesEl.textContent = completedSales;
        pendingSalesEl.textContent = pendingSales;
    }

    function attachHistoryEventListeners() {
        // View details buttons
        document.querySelectorAll('.view-details').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const saleId = e.target.closest('button').dataset.id;
                showSaleDetails(saleId);
            });
        });
    }

    async function showSaleDetails(saleId) {
        const sale = salesData.find(s => s.id === saleId);
        if (!sale) return;
        
        let saleDate;
        let formattedDate = 'N/A';
        
        if (sale.timestamp) {
            saleDate = new Date(sale.timestamp);
            formattedDate = saleDate.toLocaleDateString() + ' ' + saleDate.toLocaleTimeString();
        } else if (sale.saleDate) {
            saleDate = new Date(sale.saleDate);
            formattedDate = saleDate.toLocaleDateString() + ' ' + saleDate.toLocaleTimeString();
        } else if (sale.createdAt && sale.createdAt.toDate) {
            saleDate = sale.createdAt.toDate();
            formattedDate = saleDate.toLocaleDateString() + ' ' + saleDate.toLocaleTimeString();
        }
        
        // Calculate commission for display
        const saleTotal = Number(sale.total || 0);
        const commissionAmount = saleTotal * 0.10;
        
        // Create items table HTML
        let itemsTable = '';
        if (sale.items && sale.items.length > 0) {
            itemsTable = `
                <div class="detail-group">
                    <div class="detail-label">Items Sold</div>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Price (ZMW)</th>
                                <th style="text-align:right">Total (ZMW)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sale.items.map(item => `
                                <tr>
                                    <td>${item.productName || 'N/A'}</td>
                                    <td>${item.quantity || 0}</td>
                                    <td>ZMW ${(item.price || 0).toFixed(2)}</td>
                                    <td style="text-align:right">ZMW ${((item.price || 0) * (item.quantity || 0)).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Add warehouse and commission info
        let warehouseInfo = '';
        if (sale.soldFromHQ) {
            warehouseInfo = `
                <div class="detail-group">
                    <div class="detail-label">Warehouse</div>
                    <div class="detail-value">
                        <span class="badge" style="background:rgba(255, 204, 0, 0.1);color:#ffcc00">HQ Warehouse</span>
                    </div>
                </div>
            `;
        } else {
            warehouseInfo = `
                <div class="detail-group">
                    <div class="detail-label">Warehouse</div>
                    <div class="detail-value">
                        <span class="badge" style="background:rgba(76, 175, 80, 0.1);color:#4caf50">User Warehouse</span>
                    </div>
                </div>
            `;
        }
        
        // Add seller info for admin
        const sellerInfo = isAdmin ? `
            <div class="detail-group">
                <div class="detail-label">Sold By</div>
                <div class="detail-value">${sale.sellerEmail || currentUser.email}</div>
            </div>
        ` : '';
        
        // Add customer details
        const customerDetails = `
            <div class="detail-group">
                <div class="detail-label">Customer Phone</div>
                <div class="detail-value">${sale.customerPhone || 'N/A'}</div>
            </div>
            <div class="detail-group">
                <div class="detail-label">Customer Address</div>
                <div class="detail-value">${sale.customerAddress || 'N/A'}</div>
            </div>
        `;
        
        // Create modal content
        modalBody.innerHTML = `
            <div class="sale-details">
                <div>
                    <div class="detail-group">
                        <div class="detail-label">Sale ID</div>
                        <div class="detail-value">${sale.id.substring(0, 8)}...</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Date & Time</div>
                        <div class="detail-value">${formattedDate}</div>
                    </div>
                    ${warehouseInfo}
                    <div class="detail-group">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            ${sale.status === 'completed' ? '<span class="badge success">Completed</span>' : 
                                sale.status === 'pending' ? '<span class="badge pending">Pending</span>' : 
                                sale.status === 'cancelled' ? '<span class="badge cancelled">Cancelled</span>' : 
                                `<span class="badge">${sale.status || 'N/A'}</span>`}
                        </div>
                    </div>
                </div>
                <div>
                    <div class="detail-group">
                        <div class="detail-label">Customer</div>
                        <div class="detail-value">${sale.customerName || 'N/A'}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Customer Email</div>
                        <div class="detail-value">${sale.customerEmail || 'N/A'}</div>
                    </div>
                    ${customerDetails}
                    ${sellerInfo}
                </div>
            </div>
            
            ${itemsTable}
            
            <div class="detail-group" style="margin-top:20px;border-top:1px solid rgba(255,255,255,0.03);padding-top:15px">
                <div class="summary-bar" style="border:none;padding:0">
                    <div class="summary-item">
                        <div class="summary-label">Total Items</div>
                        <div class="summary-value count">
                            ${sale.items ? sale.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0}
                        </div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Subtotal</div>
                        <div class="summary-value">ZMW ${(sale.subtotal || 0).toFixed(2)}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Amount</div>
                        <div class="summary-value total">ZMW ${(sale.total || 0).toFixed(2)}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Commission (10%)</div>
                        <div class="summary-value" style="color:#00e5a8">ZMW ${commissionAmount.toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `;
        
        detailsModal.classList.add('show');
    }

    // Event listeners for history filters
    searchInput.addEventListener('input', renderSales);
    statusFilter.addEventListener('change', renderSales);
    dateFrom.addEventListener('change', renderSales);
    dateTo.addEventListener('change', renderSales);
    
    btnClearFilters.addEventListener('click', () => {
        searchInput.value = '';
        statusFilter.value = 'all';
        
        const today = new Date();
        const lastMonth = new Date();
        lastMonth.setDate(today.getDate() - 30);
        
        dateFrom.value = lastMonth.toISOString().split('T')[0];
        dateTo.value = today.toISOString().split('T')[0];
        
        renderSales();
    });
    
    btnRefresh.addEventListener('click', () => {
        loadSales();
        loadCustomers(); // Also refresh customers list
        if (sellingFromHQ) {
            loadHQProducts(); // Refresh HQ products
        } else {
            loadUserProducts(); // Refresh user products
        }
    });
    
    // Modal controls
    modalClose.addEventListener('click', () => {
        detailsModal.classList.remove('show');
    });
    
    btnPrintReceipt.addEventListener('click', () => {
        // Simple print functionality
        const printContent = modalBody.innerHTML;
        const originalContent = document.body.innerHTML;
        
        document.body.innerHTML = `
            <div style="padding:20px;background:white;color:black">
                <h2>Sale Receipt</h2>
                ${printContent}
            </div>
        `;
        
        window.print();
        document.body.innerHTML = originalContent;
        location.reload(); // Reload to restore event listeners
    });
    
    // Close modal on overlay click
    detailsModal.addEventListener('click', (e) => {
        if (e.target === detailsModal) {
            detailsModal.classList.remove('show');
        }
    });

    // Logout
    btnLogout.addEventListener('click', async () => {
        try {
            await signOut(auth);
            window.location.href = 'index.html';
        } catch (error) {
            console.error('Logout error:', error);
            alert('Logout failed');
        }
    });

</script>
<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
</body>
</html>