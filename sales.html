<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background: #1e1e2f; color: #fff; margin: 0; padding: 20px; }
  h2 { text-align: center; color: #ffcc00; margin-bottom: 20px; }
  .buttons { text-align: center; margin-bottom: 20px; flex-wrap: wrap; display: flex; justify-content: center; gap:10px; }
  input, select { padding: 10px; border-radius: 8px; border: none; margin: 5px; width: 200px; background: #2c2c44; color: #fff; }
  button { margin: 5px; padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; background: #ffcc00; color: #1e1e2f; font-weight: 600; }
  button:hover { background: #e6b800; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { padding: 12px; text-align: left; border: none; }
  th { color: #ffcc00; font-weight: 600; font-size: 0.95rem; }
  tbody tr:nth-child(even) { background: #2c2c44; }
  tbody tr:nth-child(odd) { background: #1f1f33; }
  .form-container { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px; }
  .total-sales { text-align: center; margin-top: 20px; font-size: 18px; font-weight: bold; }
  .scroll-container { overflow-x: auto; }

  /* Responsive */
  @media (max-width: 768px) {
    input, select { width: 100%; max-width: 300px; }
    table, thead, tbody, th, td, tr { display: block; }
    th { display: none; }
    td { text-align: right; padding-left: 50%; position: relative; }
    td::before {
      content: attr(data-label);
      position: absolute;
      left: 15px;
      font-weight: 600;
      color: #ffcc00;
      text-transform: capitalize;
    }
  }
</style>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
    authDomain: "trismart-online-app.firebaseapp.com",
    projectId: "trismart-online-app",
    storageBucket: "trismart-online-app.firebasestorage.app",
    messagingSenderId: "867677912389",
    appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
    measurementId: "G-KEWDREKNDB"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  let currentUserUID;
  let inventory = [];
  let sales = [];

  onAuthStateChanged(auth, async (user) => {
    if (!user) window.location.href = "index.html";
    currentUserUID = user.uid;
    await loadInventory();
    setTodayDate();
    await loadSalesByDate(document.getElementById('filterDate').value);
  });

  async function loadInventory() {
    inventory = [];
    const snapshot = await getDocs(collection(db, "users", currentUserUID, "inventory"));
    snapshot.forEach(docSnap => inventory.push({ id: docSnap.id, ...docSnap.data() }));
    populateProductOptions();
  }

  function populateProductOptions() {
    const select = document.getElementById('productCode');
    select.innerHTML = '<option value="">Select Product</option>';
    inventory.forEach(item => {
      const option = document.createElement('option');
      option.value = item.code;
      option.textContent = item.name;
      select.appendChild(option);
    });
  }

  function setTodayDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('saleDate').value = today;
    document.getElementById('filterDate').value = today;
  }

  async function makeSale(event) {
    event.preventDefault();
    const productCode = document.getElementById('productCode').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const date = document.getElementById('saleDate').value;

    if (!productCode || isNaN(quantity) || !date) return alert("Fill all fields!");
    const item = inventory.find(i => i.code === productCode);
    if (!item || item.stock < quantity) return alert(`Insufficient stock for ${item ? item.name : ''}`);

    item.stock -= quantity;
    item.sold = (item.sold || 0) + quantity;

    const saleEntry = { date, code: item.code, name: item.name, price: item.price, quantity };
    await addDoc(collection(db, "users", currentUserUID, "sales"), saleEntry);
    await updateDoc(doc(db, "users", currentUserUID, "inventory", item.id), { stock: item.stock, sold: item.sold });

    await loadSalesByDate(date);
    document.getElementById('salesForm').reset();
  }

  async function loadSalesByDate(date) {
    sales = [];
    const salesRef = collection(db, "users", currentUserUID, "sales");
    const q = query(salesRef, where("date", "==", date));
    const snapshot = await getDocs(q);
    snapshot.forEach(docSnap => sales.push({ id: docSnap.id, ...docSnap.data() }));
    renderSalesTable();
  }

  function renderSalesTable() {
    const tbody = document.querySelector('#salesTable tbody');
    tbody.innerHTML = '';
    sales.forEach(sale => {
      const total = (sale.price * sale.quantity).toFixed(2);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td data-label="Product Code">${sale.code}</td>
        <td data-label="Product Name">${sale.name}</td>
        <td data-label="Price">${sale.price}</td>
        <td data-label="Quantity">${sale.quantity}</td>
        <td data-label="Total">${total}</td>
      `;
      tbody.appendChild(row);
    });
    updateTotalSales();
  }

  function updateTotalSales() {
    const total = sales.reduce((acc, s) => acc + s.price * s.quantity, 0).toFixed(2);
    document.querySelector('.total-sales').textContent = `Total Sales for ${document.getElementById('filterDate').value}: $${total}`;
  }

  function filterByDate() {
    const date = document.getElementById('filterDate').value;
    loadSalesByDate(date);
  }

  function toggleForm() {
    const form = document.querySelector('.form-container');
    form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
  }

  window.makeSale = makeSale;
  window.toggleForm = toggleForm;
  window.filterByDate = filterByDate;
</script>
</head>
<body>
<div class="container">
  <h2>Sales Dashboard</h2>
  <div class="buttons">
    <button onclick="toggleForm()">Toggle Sale Form</button>
    <input type="date" id="filterDate" onchange="filterByDate()">
  </div>
  <div class="form-container">
    <form id="salesForm" onsubmit="makeSale(event)">
      <input type="date" id="saleDate" required>
      <select id="productCode" required></select>
      <input type="number" id="quantity" placeholder="Quantity" required>
      <button type="submit">Record Sale</button>
    </form>
  </div>
  <div class="scroll-container">
    <table id="salesTable">
      <thead>
        <tr>
          <th>Product Code</th>
          <th>Product Name</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5" style="text-align:center;">No sales yet</td></tr>
      </tbody>
    </table>
  </div>
  <div class="total-sales">Total Sales ZMW0.00</div>
</div>
</body>
</html>
