<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Commission Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: Arial, sans-serif;
      background: #0f1220;
      color:#fff;
      min-height:100vh;
      padding:20px;
    }
    
    .container{
      width:100%;
      max-width:1200px;
      margin:0 auto;
    }
    
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-bottom:15px;
      border-bottom:1px solid #27293d;
      margin-bottom:25px;
    }
    
    h1{
      margin:0;
      font-size:24px;
      color:#ffcc00;
    }
    
    .user-info{
      color:#b8b8cc;
      font-size:14px;
    }
    
    .btn{
      padding:8px 16px;
      border-radius:8px;
      border:none;
      background:#ffcc00;
      color:#111;
      font-weight:700;
      cursor:pointer;
      text-decoration:none;
      display:inline-block;
    }
    
    .btn.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:#b8b8cc;
    }
    
    .btn.info{
      background:#2196f3;
      color:#fff;
    }
    
    .btn.success{
      background:#4caf50;
      color:#fff;
    }
    
    .btn.warning{
      background:#ff9800;
      color:#fff;
    }
    
    .btn.danger{
      background:#f44336;
      color:#fff;
    }
    
    .admin-badge{
      background:#ff9800;
      color:#111;
      padding:4px 10px;
      border-radius:4px;
      font-size:0.8rem;
      font-weight:bold;
      margin-left:10px;
    }
    
    .commission-box{
      background:#191b2a;
      border-radius:12px;
      padding:25px;
      margin-bottom:30px;
      border:1px solid rgba(255,255,255,0.03);
    }
    
    .commission-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:25px;
    }
    
    .commission-cards{
      display:flex;
      gap:20px;
      flex-wrap:wrap;
      margin-bottom:30px;
    }
    
    .card{
      background:rgba(0,0,0,0.2);
      border-radius:10px;
      padding:25px;
      border:1px solid rgba(255,255,255,0.03);
      flex:1;
      min-width:250px;
    }
    
    .card h3{
      color:#b8b8cc;
      font-size:1rem;
      margin-bottom:10px;
    }
    
    .card .amount{
      font-size:2rem;
      font-weight:bold;
    }
    
    .total-earned{
      color:#ffcc00;
    }
    
    .pending{
      color:#ff9800;
    }
    
    .paid{
      color:#4caf50;
    }
    
    .sales-count{
      color:#2196f3;
    }
    
    .commission-table{
      background:#191b2a;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.03);
      overflow:hidden;
      margin-top:20px;
    }
    
    .table-header{
      padding:20px;
      border-bottom:1px solid rgba(255,255,255,0.04);
      background:rgba(0,0,0,0.2);
    }
    
    .table-content{
      overflow-x:auto;
    }
    
    table{
      width:100%;
      border-collapse:collapse;
      min-width:1000px;
    }
    
    th{
      padding:15px 20px;
      text-align:left;
      color:#b8b8cc;
      font-weight:700;
      border-bottom:2px solid #27293d;
      background:#191b2a;
    }
    
    td{
      padding:15px 20px;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    
    tr:hover{
      background:rgba(255,255,255,0.02);
    }
    
    .badge{
      padding:5px 10px;
      border-radius:5px;
      font-size:0.8rem;
      font-weight:bold;
    }
    
    .badge-pending{
      background:rgba(255,152,0,0.2);
      color:#ff9800;
    }
    
    .badge-paid{
      background:rgba(76,175,80,0.2);
      color:#4caf50;
    }
    
    .badge-cancelled{
      background:rgba(244,67,54,0.2);
      color:#f44336;
    }
    
    .empty{
      text-align:center;
      padding:60px;
      color:#b8b8cc;
    }
    
    .loading{
      text-align:center;
      padding:60px;
      color:#b8b8cc;
    }
    
    .sale-id{
      color:#2196f3;
      font-family:monospace;
      font-size:0.9rem;
    }
    
    .commission-amount{
      text-align:right;
      font-weight:bold;
      color:#00e5a8;
    }
    
    .sale-amount{
      text-align:right;
      color:#b8b8cc;
    }
    
    .commission-rate{
      color:#00e5a8;
      font-weight:bold;
    }
    
    .customer-name{
      max-width:150px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    
    .seller-email{
      color:#b8b8cc;
      font-size:0.9rem;
      max-width:180px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    
    .status-buttons{
      display:flex;
      gap:10px;
      margin:20px 0;
      padding:0 20px;
    }
    
    .status-btn{
      padding:8px 16px;
      border-radius:6px;
      background:transparent;
      border:1px solid #27293d;
      color:#b8b8cc;
      cursor:pointer;
    }
    
    .status-btn.active{
      background:#2196f3;
      color:white;
      border-color:#2196f3;
    }
    
    .admin-controls{
      display:flex;
      gap:10px;
      padding:0 20px 20px;
    }
    
    .filter-input{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:transparent;
      color:#fff;
      width:200px;
    }
    
    .action-buttons{
      display:flex;
      gap:5px;
    }
    
    .action-btn{
      padding:6px 10px;
      border-radius:5px;
      border:none;
      background:transparent;
      color:#fff;
      cursor:pointer;
      font-size:0.8rem;
    }
    
    .approve-btn{
      background:rgba(76,175,80,0.2);
      color:#4caf50;
    }
    
    .approve-btn:hover{
      background:rgba(76,175,80,0.3);
    }
    
    .cancel-btn{
      background:rgba(244,67,54,0.2);
      color:#f44336;
    }
    
    .cancel-btn:hover{
      background:rgba(244,67,54,0.3);
    }
    
    .admin-summary{
      display:flex;
      gap:20px;
      margin-top:20px;
      flex-wrap:wrap;
    }
    
    .admin-summary-card{
      background:rgba(0,0,0,0.3);
      border-radius:8px;
      padding:15px;
      flex:1;
      min-width:200px;
    }
    
    .admin-summary-card h4{
      color:#b8b8cc;
      font-size:0.9rem;
      margin-bottom:5px;
    }
    
    .admin-summary-card .value{
      font-size:1.5rem;
      font-weight:bold;
    }
    
    .user-filter{
      background:rgba(33,150,243,0.1);
      border:1px solid rgba(33,150,243,0.3);
      padding:10px;
      border-radius:8px;
      margin-bottom:15px;
    }
    
    @media (max-width:768px){
      .header{
        flex-direction:column;
        align-items:flex-start;
        gap:15px;
      }
      
      .commission-header{
        flex-direction:column;
        align-items:flex-start;
        gap:15px;
      }
      
      .commission-cards{
        flex-direction:column;
      }
      
      .admin-controls{
        flex-direction:column;
      }
      
      .filter-input{
        width:100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <a href="sales.html" class="btn ghost" style="margin-bottom:10px">
          <i class="fas fa-arrow-left"></i> Back to Sales
        </a>
        <h1>Commission Dashboard <span id="adminBadge" class="admin-badge" style="display:none">ADMIN MODE</span></h1>
        <div class="user-info">
          <span id="userEmail">Loading...</span>
          <span id="userRole" style="color:#ff9800;margin-left:10px"></span>
        </div>
      </div>
      <div>
        <button class="btn" id="btnLogout">Logout</button>
      </div>
    </div>
    
    <!-- Admin Summary (only shown for admin) -->
    <div id="adminSummary" style="display:none">
      <div class="admin-summary">
        <div class="admin-summary-card">
          <h4>Total Pending Commissions</h4>
          <div class="value pending" id="adminPendingTotal">$0.00</div>
        </div>
        <div class="admin-summary-card">
          <h4>Total Paid Commissions</h4>
          <div class="value paid" id="adminPaidTotal">$0.00</div>
        </div>
        <div class="admin-summary-card">
          <h4>Total Users</h4>
          <div class="value sales-count" id="totalUsers">0</div>
        </div>
        <div class="admin-summary-card">
          <h4>All Commissions</h4>
          <div class="value total-earned" id="allCommissionsTotal">$0.00</div>
        </div>
      </div>
    </div>
    
    <!-- Commission Summary -->
    <div class="commission-box">
      <div class="commission-header">
        <h2 style="margin:0">
          <span id="summaryTitle">My Commission Summary</span>
          <span id="adminUserFilter" class="user-filter" style="display:none;margin-left:15px">
            Filtering: <strong id="filteredUser">All Users</strong>
          </span>
        </h2>
        <button class="btn info" id="btnRefresh"><i class="fas fa-sync"></i> Refresh</button>
      </div>
      
      <div class="commission-cards">
        <div class="card">
          <h3>Total Commission</h3>
          <div class="amount total-earned" id="totalCommission">$0.00</div>
          <p style="color:#b8b8cc;font-size:0.9rem;margin-top:10px">10% of all sales</p>
        </div>
        
        <div class="card">
          <h3>Pending Payment</h3>
          <div class="amount pending" id="pendingCommission">$0.00</div>
          <p style="color:#b8b8cc;font-size:0.9rem;margin-top:10px">Awaiting payout</p>
        </div>
        
        <div class="card">
          <h3>Paid Out</h3>
          <div class="amount paid" id="paidCommission">$0.00</div>
          <p style="color:#b8b8cc;font-size:0.9rem;margin-top:10px">Already received</p>
        </div>
        
        <div class="card">
          <h3>Total Sales</h3>
          <div class="amount sales-count" id="totalSales">0</div>
          <p style="color:#b8b8cc;font-size:0.9rem;margin-top:10px">Sales made</p>
        </div>
      </div>
    </div>
    
    <!-- Commission History -->
    <div class="commission-table">
      <div class="table-header">
        <h3 style="margin:0">
          <span id="tableTitle">My Commission History</span>
          <span id="adminControls" style="display:none;margin-left:15px">
            <select id="userFilter" class="filter-input">
              <option value="all">All Users</option>
            </select>
          </span>
        </h3>
      </div>
      
      <div class="status-buttons">
        <button class="status-btn active" data-status="all">All</button>
        <button class="status-btn" data-status="pending">Pending</button>
        <button class="status-btn" data-status="paid">Paid</button>
        <button class="status-btn" data-status="cancelled" id="cancelledBtn" style="display:none">Cancelled</button>
      </div>
      
      <div class="admin-controls" id="searchControls" style="display:none">
        <input type="text" id="searchInput" class="filter-input" placeholder="Search by user or customer...">
        <button class="btn ghost" id="btnClearSearch">Clear</button>
        <button class="btn success" id="btnApproveAllPending" style="margin-left:auto">Approve All Pending</button>
      </div>
      
      <div class="table-content">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th id="sellerHeader" style="display:none">Seller</th>
              <th>Sale ID</th>
              <th>Customer</th>
              <th>Sale Amount</th>
              <th>Rate</th>
              <th>Commission</th>
              <th>Status</th>
              <th id="actionsHeader" style="display:none">Actions</th>
            </tr>
          </thead>
          <tbody id="commissionsBody">
            <tr><td colspan="8" class="loading">Loading commissions...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      doc,
      serverTimestamp,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
      authDomain: "trismart-online-app.firebasestorage.app",
      projectId: "trismart-online-app",
      storageBucket: "trismart-online-app.firebasestorage.app",
      messagingSenderId: "867677912389",
      appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
      measurementId: "G-KEWDREKNDB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const userEmailEl = document.getElementById('userEmail');
    const userRoleEl = document.getElementById('userRole');
    const btnLogout = document.getElementById('btnLogout');
    const btnRefresh = document.getElementById('btnRefresh');
    const commissionsBody = document.getElementById('commissionsBody');
    const statusButtons = document.querySelectorAll('.status-btn');
    
    // Summary elements
    const totalCommissionEl = document.getElementById('totalCommission');
    const pendingCommissionEl = document.getElementById('pendingCommission');
    const paidCommissionEl = document.getElementById('paidCommission');
    const totalSalesEl = document.getElementById('totalSales');
    
    // Admin elements
    const adminBadge = document.getElementById('adminBadge');
    const adminSummary = document.getElementById('adminSummary');
    const adminControls = document.getElementById('adminControls');
    const searchControls = document.getElementById('searchControls');
    const sellerHeader = document.getElementById('sellerHeader');
    const actionsHeader = document.getElementById('actionsHeader');
    const cancelledBtn = document.getElementById('cancelledBtn');
    const summaryTitle = document.getElementById('summaryTitle');
    const tableTitle = document.getElementById('tableTitle');
    const adminUserFilter = document.getElementById('adminUserFilter');
    const filteredUser = document.getElementById('filteredUser');
    
    // Admin filter elements
    const userFilter = document.getElementById('userFilter');
    const searchInput = document.getElementById('searchInput');
    const btnClearSearch = document.getElementById('btnClearSearch');
    const btnApproveAllPending = document.getElementById('btnApproveAllPending');
    
    // Admin summary elements
    const adminPendingTotal = document.getElementById('adminPendingTotal');
    const adminPaidTotal = document.getElementById('adminPaidTotal');
    const totalUsers = document.getElementById('totalUsers');
    const allCommissionsTotal = document.getElementById('allCommissionsTotal');

    let currentUser = null;
    let allCommissions = [];
    let currentStatusFilter = 'all';
    let currentUserFilter = 'all';
    let searchTerm = '';
    let isAdmin = false;
    let usersList = [];

    // Admin check - Using the correct admin email from your index.html
    const ADMIN_EMAILS = [
      'chrischishe@gmail.com',  // This is the correct admin email from your system
      'admin@gmail.com',
      'admin@example.com'
    ].map(email => email.toLowerCase());

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = user;
      userEmailEl.textContent = user.email;
      
      // Check if user is admin
      const userEmail = user.email.toLowerCase();
      isAdmin = ADMIN_EMAILS.includes(userEmail);
      
      if (isAdmin) {
        adminBadge.style.display = 'inline-block';
        adminControls.style.display = 'inline-block';
        searchControls.style.display = 'flex';
        sellerHeader.style.display = 'table-cell';
        actionsHeader.style.display = 'table-cell';
        cancelledBtn.style.display = 'inline-block';
        adminSummary.style.display = 'block';
        summaryTitle.textContent = 'All Users Commission Summary';
        tableTitle.textContent = 'All Commissions';
        userRoleEl.textContent = '(Admin)';
        
        // Load users for filter
        loadUsers();
      } else {
        userRoleEl.textContent = '(User)';
      }
      
      // Load commissions
      loadCommissions();
    });

    // Load all users for admin filter
    async function loadUsers() {
      try {
        // Get all commissions to extract unique users
        const commissionsRef = collection(db, 'commissions');
        const snapshot = await getDocs(commissionsRef);
        
        const uniqueUsers = new Map();
        
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.userEmail) {
            const userEmail = data.userEmail.toLowerCase();
            uniqueUsers.set(userEmail, {
              email: data.userEmail,
              name: data.userName || data.userEmail.split('@')[0]
            });
          }
        });
        
        usersList = Array.from(uniqueUsers.values());
        
        // Update user filter dropdown
        userFilter.innerHTML = '<option value="all">All Users</option>';
        usersList.forEach(user => {
          const option = document.createElement('option');
          option.value = user.email;
          option.textContent = `${user.name} (${user.email})`;
          userFilter.appendChild(option);
        });
        
        totalUsers.textContent = usersList.length;
        
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    // Load commissions
    async function loadCommissions() {
      try {
        commissionsBody.innerHTML = '<tr><td colspan="8" class="loading">Loading commissions...</td></tr>';
        
        // Load ALL commissions from Firestore
        const commissionsRef = collection(db, 'commissions');
        const snapshot = await getDocs(commissionsRef);
        
        allCommissions = [];
        
        snapshot.forEach(doc => {
          const commission = doc.data();
          const userEmail = commission.userEmail ? commission.userEmail.toLowerCase() : '';
          
          // For admin, show all commissions
          // For regular user, only show their own commissions
          if (isAdmin || 
              userEmail === currentUser.email.toLowerCase() || 
              commission.userId === currentUser.uid) {
            allCommissions.push({
              id: doc.id,
              ...commission,
              amount: Number(commission.amount || 0),
              saleAmount: Number(commission.saleAmount || 0),
              displayDate: commission.saleDate ? new Date(commission.saleDate) : 
                         (commission.createdAt && commission.createdAt.toDate ? commission.createdAt.toDate() : new Date()),
              userName: commission.userName || commission.userEmail?.split('@')[0] || 'Unknown'
            });
          }
        });
        
        if (allCommissions.length === 0) {
          commissionsBody.innerHTML = `
            <tr>
              <td colspan="8" class="empty">
                <i class="fas fa-money-bill-wave" style="font-size:3rem;margin-bottom:15px;display:block;color:#ffcc00"></i>
                <div>No commissions yet</div>
                <div style="margin-top:10px;font-size:0.9rem;color:#b8b8cc">
                  ${isAdmin ? 'No commissions found in the system.' : 'Make sales to earn 10% commissions!'}
                </div>
                ${!isAdmin ? `<a href="sales.html" class="btn" style="margin-top:20px;display:inline-block">
                  <i class="fas fa-shopping-cart"></i> Go Make Sales
                </a>` : ''}
              </td>
            </tr>
          `;
          updateSummary(allCommissions);
          if (isAdmin) updateAdminSummary(allCommissions);
          return;
        }
        
        // Sort by date (newest first)
        allCommissions.sort((a, b) => b.displayDate - a.displayDate);
        
        // Update admin summary
        if (isAdmin) {
          updateAdminSummary(allCommissions);
        }
        
        // Show commissions
        renderCommissions();
        
      } catch (error) {
        console.error('Error loading commissions:', error);
        
        commissionsBody.innerHTML = `
          <tr>
            <td colspan="8" class="empty">
              <div style="color:#ff6b6b;margin-bottom:10px">
                <i class="fas fa-exclamation-triangle"></i> Error loading commissions
              </div>
              <div style="font-size:0.9rem;color:#b8b8cc">
                Please check your connection and try again.
              </div>
              <button onclick="window.location.reload()" class="btn" style="margin-top:20px">
                <i class="fas fa-redo"></i> Reload Page
              </button>
            </td>
          </tr>
        `;
      }
    }

    // Update admin summary
    function updateAdminSummary(commissions) {
      const pendingTotal = commissions
        .filter(comm => comm.status === 'pending')
        .reduce((sum, comm) => sum + comm.amount, 0);
      
      const paidTotal = commissions
        .filter(comm => comm.status === 'paid')
        .reduce((sum, comm) => sum + comm.amount, 0);
      
      const allTotal = commissions.reduce((sum, comm) => sum + comm.amount, 0);
      
      adminPendingTotal.textContent = `$${pendingTotal.toFixed(2)}`;
      adminPaidTotal.textContent = `$${paidTotal.toFixed(2)}`;
      allCommissionsTotal.textContent = `$${allTotal.toFixed(2)}`;
    }

    // Render commissions in table
    function renderCommissions() {
      // Apply filters
      let filteredCommissions = [...allCommissions];
      
      // Status filter
      if (currentStatusFilter !== 'all') {
        filteredCommissions = filteredCommissions.filter(comm => comm.status === currentStatusFilter);
      }
      
      // User filter (admin only)
      if (isAdmin && currentUserFilter !== 'all') {
        filteredCommissions = filteredCommissions.filter(comm => 
          comm.userEmail?.toLowerCase() === currentUserFilter.toLowerCase()
        );
        adminUserFilter.style.display = 'inline-block';
        const user = usersList.find(u => u.email.toLowerCase() === currentUserFilter.toLowerCase());
        filteredUser.textContent = user ? user.name : currentUserFilter;
      } else {
        adminUserFilter.style.display = 'none';
      }
      
      // Search filter (admin only)
      if (isAdmin && searchTerm) {
        const term = searchTerm.toLowerCase();
        filteredCommissions = filteredCommissions.filter(comm => 
          comm.userEmail?.toLowerCase().includes(term) ||
          comm.userName?.toLowerCase().includes(term) ||
          comm.customerName?.toLowerCase().includes(term) ||
          comm.saleId?.toLowerCase().includes(term)
        );
      }
      
      if (filteredCommissions.length === 0) {
        commissionsBody.innerHTML = `
          <tr>
            <td colspan="${isAdmin ? '9' : '8'}" class="empty">
              No ${currentStatusFilter === 'all' ? '' : currentStatusFilter} commissions found
              ${currentUserFilter !== 'all' ? ` for selected user` : ''}
              ${searchTerm ? ` matching "${searchTerm}"` : ''}
            </td>
          </tr>
        `;
        updateSummary(filteredCommissions);
        return;
      }
      
      // Render table
      commissionsBody.innerHTML = filteredCommissions.map(commission => {
        const date = commission.displayDate.toLocaleDateString();
        const saleId = commission.saleId ? commission.saleId.substring(0, 6) + '...' : 'N/A';
        
        let badgeClass = 'badge-pending';
        let badgeText = 'Pending';
        
        if (commission.status === 'paid') {
          badgeClass = 'badge-paid';
          badgeText = 'Paid';
        } else if (commission.status === 'cancelled') {
          badgeClass = 'badge-cancelled';
          badgeText = 'Cancelled';
        }
        
        const actions = isAdmin && commission.status === 'pending' ? `
          <td class="action-buttons">
            <button class="action-btn approve-btn" data-id="${commission.id}">
              <i class="fas fa-check"></i> Approve
            </button>
            <button class="action-btn cancel-btn" data-id="${commission.id}">
              <i class="fas fa-times"></i> Cancel
            </button>
          </td>
        ` : isAdmin ? `
          <td class="action-buttons">
            <span style="color:#b8b8cc;font-size:0.8rem">${commission.status === 'paid' ? 'Approved' : commission.status === 'cancelled' ? 'Cancelled' : commission.status}</span>
          </td>
        ` : '';
        
        const sellerColumn = isAdmin ? `
          <td class="seller-email" title="${commission.userEmail || 'N/A'}">
            ${commission.userName || 'Unknown'}
            <br><small style="color:#666">${commission.userEmail || ''}</small>
          </td>
        ` : '';
        
        return `
          <tr>
            <td>${date}</td>
            ${sellerColumn}
            <td><span class="sale-id">${saleId}</span></td>
            <td class="customer-name">${commission.customerName || 'Customer'}</td>
            <td class="sale-amount">$${commission.saleAmount.toFixed(2)}</td>
            <td class="commission-rate">10%</td>
            <td class="commission-amount">$${commission.amount.toFixed(2)}</td>
            <td><span class="badge ${badgeClass}">${badgeText}</span></td>
            ${actions}
          </tr>
        `;
      }).join('');
      
      updateSummary(filteredCommissions);
      
      // Attach action button listeners for admin
      if (isAdmin) {
        attachActionListeners();
      }
    }

    // Attach action button listeners
    function attachActionListeners() {
      // Approve buttons
      document.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const commissionId = e.target.closest('button').dataset.id;
          if (confirm('Approve this commission for payment?')) {
            await updateCommissionStatus(commissionId, 'paid');
          }
        });
      });
      
      // Cancel buttons
      document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const commissionId = e.target.closest('button').dataset.id;
          if (confirm('Cancel this commission?')) {
            await updateCommissionStatus(commissionId, 'cancelled');
          }
        });
      });
    }

    // Update commission status
    async function updateCommissionStatus(commissionId, status) {
      try {
        const commissionRef = doc(db, 'commissions', commissionId);
        await updateDoc(commissionRef, {
          status: status,
          updatedAt: serverTimestamp(),
          approvedBy: currentUser.email,
          approvedAt: new Date().toISOString()
        });
        
        alert(`Commission ${status} successfully!`);
        loadCommissions(); // Reload to show updated status
        
      } catch (error) {
        console.error('Error updating commission:', error);
        alert('Failed to update commission: ' + error.message);
      }
    }

    // Update summary cards
    function updateSummary(commissions) {
      // For admin with user filter, show filtered summary
      // For regular user, show their own summary from all commissions
      let summaryCommissions = allCommissions;
      
      if (isAdmin && currentUserFilter !== 'all') {
        summaryCommissions = allCommissions.filter(comm => 
          comm.userEmail?.toLowerCase() === currentUserFilter.toLowerCase()
        );
      } else if (!isAdmin) {
        summaryCommissions = allCommissions.filter(comm => 
          comm.userEmail?.toLowerCase() === currentUser.email.toLowerCase() || 
          comm.userId === currentUser.uid
        );
      }
      
      const totalCommission = summaryCommissions.reduce((sum, comm) => sum + comm.amount, 0);
      const pendingCommission = summaryCommissions
        .filter(comm => comm.status === 'pending')
        .reduce((sum, comm) => sum + comm.amount, 0);
      const paidCommission = summaryCommissions
        .filter(comm => comm.status === 'paid')
        .reduce((sum, comm) => sum + comm.amount, 0);
      
      totalCommissionEl.textContent = `$${totalCommission.toFixed(2)}`;
      pendingCommissionEl.textContent = `$${pendingCommission.toFixed(2)}`;
      paidCommissionEl.textContent = `$${paidCommission.toFixed(2)}`;
      totalSalesEl.textContent = summaryCommissions.length;
    }

    // Status filter buttons
    statusButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        statusButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentStatusFilter = btn.dataset.status;
        renderCommissions();
      });
    });

    // User filter (admin only)
    userFilter?.addEventListener('change', () => {
      currentUserFilter = userFilter.value;
      renderCommissions();
    });

    // Search input (admin only)
    searchInput?.addEventListener('input', (e) => {
      searchTerm = e.target.value.trim();
      renderCommissions();
    });

    // Clear search (admin only)
    btnClearSearch?.addEventListener('click', () => {
      searchInput.value = '';
      searchTerm = '';
      renderCommissions();
    });

    // Approve all pending (admin only)
    btnApproveAllPending?.addEventListener('click', async () => {
      const pendingCommissions = allCommissions.filter(comm => comm.status === 'pending');
      
      if (pendingCommissions.length === 0) {
        alert('No pending commissions to approve.');
        return;
      }
      
      if (confirm(`Approve all ${pendingCommissions.length} pending commissions?\nTotal amount: $${pendingCommissions.reduce((sum, comm) => sum + comm.amount, 0).toFixed(2)}`)) {
        try {
          const batch = writeBatch(db);
          
          for (const commission of pendingCommissions) {
            const commissionRef = doc(db, 'commissions', commission.id);
            batch.update(commissionRef, {
              status: 'paid',
              updatedAt: serverTimestamp(),
              approvedBy: currentUser.email,
              approvedAt: new Date().toISOString()
            });
          }
          
          await batch.commit();
          alert(`Approved ${pendingCommissions.length} commissions successfully!`);
          loadCommissions();
          
        } catch (error) {
          console.error('Error approving all commissions:', error);
          alert('Failed to approve commissions: ' + error.message);
        }
      }
    });

    // Refresh button
    btnRefresh.addEventListener('click', () => {
      loadCommissions();
      if (isAdmin) loadUsers();
    });

    // Logout
    btnLogout.addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        try {
          await signOut(auth);
          window.location.href = 'index.html';
        } catch (error) {
          alert('Logout failed');
        }
      }
    });

  </script>
</body>
</html>