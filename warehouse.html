<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Warehouse Inventory</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: Arial, sans-serif; 
    background:#1e1e2f; 
    color:#fff; 
    margin:0; 
    padding:10px; 
    font-size: 14px;
  }
  h2 { 
    text-align:center; 
    color:#ffcc00; 
    margin-bottom:12px; 
    font-size:1.3rem; 
  }
  .header-buttons {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .buttons { 
    display:flex; 
    justify-content:center; 
    flex-wrap:wrap; 
    gap:6px; 
    margin-bottom:8px; 
  }
  input { 
    padding:8px; 
    border-radius:6px; 
    border:none; 
    margin:3px; 
    width:100%; 
    background:#2c2c44; 
    color:#fff; 
    font-size:0.9rem; 
  }
  button { 
    padding:8px 12px; 
    border-radius:6px; 
    border:none; 
    cursor:pointer; 
    background:#ffcc00; 
    color:#1e1e2f; 
    font-weight:600; 
    font-size:0.9rem; 
    margin:2px;
    flex: 1;
    min-width: 120px;
  }
  button:hover { background:#e6b800; }
  button:disabled { background: #666; color: #999; cursor: not-allowed; }
  table { width:100%; border-collapse:collapse; margin-top:8px; font-size:0.85rem; }
  th, td { padding:8px 6px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.1); }
  th { color:#ffcc00; font-weight:600; font-size:0.85rem; }
  tbody tr:nth-child(even) { background:#2c2c44; }
  tbody tr:nth-child(odd) { background:#1f1f33; }
  .form-container { display:none; flex-direction:column; align-items:center; gap:6px; margin-bottom:8px; }
  .total-value { text-align:center; margin-top:10px; font-weight:bold; font-size:0.9rem; color:#ffcc00; padding: 8px; }
  .modal { 
    display: none; 
    position: fixed; 
    z-index: 100; 
    left: 0; 
    top: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(0,0,0,0.8); 
    overflow: auto;
    padding: 10px;
  }
  .modal-content { 
    background-color: #2c2c44; 
    margin: 15% auto; 
    padding: 15px; 
    border-radius: 8px; 
    width: 100%;
    max-width: 400px;
  }
  .close { 
    color: #aaa; 
    float: right; 
    font-size: 24px; 
    font-weight: bold; 
    cursor: pointer; 
    margin-top: -10px;
  }
  .close:hover { color: #fff; }
  .password-strength { margin-top: 5px; font-size: 0.8rem; }
  .strength-weak { color: #ff4757; }
  .strength-medium { color: #ffa502; }
  .strength-strong { color: #2ed573; }
  .modal-title {
    text-align: center;
    color: #ffcc00;
    margin-top: 0;
    margin-bottom: 15px;
  }
  .modal-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 15px;
  }
  .modal-input {
    width: 100%;
    margin-bottom: 10px;
  }
  .btn-delete {
    background: #dc3545;
    color: white;
  }
  .btn-delete:hover {
    background: #c82333;
  }
  @media (max-width: 480px) {
    body { padding: 8px; font-size: 13px; }
    button { padding: 8px 10px; font-size: 0.85rem; min-width: 100px; }
    th, td { padding: 6px 4px; }
    .modal-content { padding: 12px; margin: 20% auto; }
  }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
  authDomain: "trismart-online-app.firebaseapp.com",
  projectId: "trismart-online-app",
  storageBucket: "trismart-online-app.firebasestorage.app",
  messagingSenderId: "867677912389",
  appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
  measurementId: "G-KEWDREKNDB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let currentUserUID;
let inventory = [];
let isAdding = false;
let userPassword = null;

function listenInventory() {
  const inventoryRef = collection(db, "users", currentUserUID, "inventory");
  onSnapshot(inventoryRef, snapshot => {
    inventory = [];
    snapshot.forEach(docSnap => inventory.push({ id: docSnap.id, ...docSnap.data() }));
    renderTable();
  });
}

onAuthStateChanged(auth, async user => {
  if(!user){ window.location.href="index.html"; return; }
  currentUserUID = user.uid;
  
  // Check if user has a password set
  const passwordDoc = await getDoc(doc(db, "users", currentUserUID, "preferences", "password"));
  if (passwordDoc.exists()) {
    userPassword = passwordDoc.data().value;
  } else {
    // Show password setup modal for new users
    showModal('passwordSetupModal');
  }
  
  listenInventory();
});

function renderTable(){
  const tbody = document.querySelector('#inventoryTable tbody');
  tbody.innerHTML='';
  if(inventory.length===0){
    tbody.innerHTML='<tr><td colspan="6" style="text-align:center;">No inventory yet</td></tr>';
    updateTotalValue();
    return;
  }
  inventory.forEach(item=>{
    const row = document.createElement('tr');
    row.innerHTML=`
      <td>${item.code}</td>
      <td>${item.name}</td>
      <td>${item.price.toFixed(2)}</td>
      <td>${item.stock}</td>
      <td>${item.sold || 0}</td>
      <td><button onclick="showEditOptions('${item.id}')">Edit</button></td>
    `;
    tbody.appendChild(row);
  });
  updateTotalValue();
}

function updateTotalValue(){
  const total = inventory.reduce((acc,i)=>acc + (i.stock*i.price),0).toFixed(2);
  document.querySelector('.total-value').textContent=`Total Stock Value: ZMW ${total}`;
}

function searchInventory(){
  const filter = document.getElementById('searchInput').value.toLowerCase();
  const tbody = document.querySelector('#inventoryTable tbody');
  Array.from(tbody.rows).forEach(row=>{
    const code=row.cells[0].innerText.toLowerCase();
    const name=row.cells[1].innerText.toLowerCase();
    row.style.display=(code.includes(filter) || name.includes(filter))?'':'none';
  });
}

async function editItem(itemId){
  // If no password is set, allow editing without password
  if (!userPassword) {
    alert("No password set. Please set a password first.");
    showModal('passwordSetupModal');
    return;
  }
  
  const password = prompt("Enter password to edit:");
  if(password !== userPassword) return alert("Wrong password!");
  
  const item = inventory.find(i=>i.id===itemId);
  if(!item) return alert("Item not found!");
  const newName = prompt("Enter new name:", item.name);
  const newPrice = parseFloat(prompt("Enter new price:", item.price));
  const newStock = parseInt(prompt("Enter new stock:", item.stock));
  if(!newName || isNaN(newPrice) || isNaN(newStock)) return alert("Invalid input!");
  await updateDoc(doc(db, "users", currentUserUID, "inventory", itemId), { name:newName, price:newPrice, stock:newStock });
  alert("Item updated successfully!");
}

function toggleAddForm(){
  const form=document.querySelector('.form-container');
  form.style.display=form.style.display==='flex'?'none':'flex';
}

async function addItem(event){
  event.preventDefault();
  
  // Prevent multiple submissions
  if (isAdding) {
    alert("Please wait, item is being added...");
    return;
  }
  
  const code = document.getElementById('addCode').value.trim();
  const name = document.getElementById('addName').value.trim();
  const price = parseFloat(document.getElementById('addPrice').value);
  const stock = parseInt(document.getElementById('addStock').value);
  
  if(!code || !name || isNaN(price) || isNaN(stock)) return alert("Fill all fields!");
  
  // Check if product code already exists
  const existingItem = inventory.find(item => item.code === code);
  if (existingItem) {
    alert(`Product with code "${code}" already exists!`);
    return;
  }
  
  // Set flag to prevent multiple submissions
  isAdding = true;
  const addButton = document.querySelector('#addForm button[type="submit"]');
  const originalText = addButton.textContent;
  addButton.textContent = "Adding...";
  addButton.disabled = true;
  
  try {
    await addDoc(collection(db, "users", currentUserUID, "inventory"), { code, name, price, stock, sold:0 });
    document.getElementById('addForm').reset();
    toggleAddForm();
    alert("Item added successfully!");
  } catch (error) {
    console.error("Error adding item:", error);
    alert("Error adding item. Please try again.");
  } finally {
    // Reset button state regardless of success or failure
    isAdding = false;
    addButton.textContent = originalText;
    addButton.disabled = false;
  }
}

// Password strength checker
function checkPasswordStrength(password) {
  const strengthIndicator = document.getElementById('passwordStrength');
  
  if (!password) {
    strengthIndicator.textContent = '';
    return;
  }
  
  // Check password strength
  let strength = 0;
  if (password.length >= 8) strength++;
  if (password.match(/([a-z].*[A-Z])|([A-Z].*[a-z])/)) strength++;
  if (password.match(/([0-9])/)) strength++;
  if (password.match(/([!,@,#,$,%,^,&,*,?,_,~])/)) strength++;
  
  // Display strength
  if (strength < 2) {
    strengthIndicator.textContent = 'Weak';
    strengthIndicator.className = 'password-strength strength-weak';
  } else if (strength === 2 || strength === 3) {
    strengthIndicator.textContent = 'Medium';
    strengthIndicator.className = 'password-strength strength-medium';
  } else {
    strengthIndicator.textContent = 'Strong';
    strengthIndicator.className = 'password-strength strength-strong';
  }
}

// Set up password for the first time
async function setupPassword() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (!newPassword) {
    alert("Please enter a password");
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert("Passwords don't match");
    return;
  }
  
  if (newPassword.length < 4) {
    alert("Password should be at least 4 characters long");
    return;
  }
  
  try {
    // Save password to Firestore
    await setDoc(doc(db, "users", currentUserUID, "preferences", "password"), {
      value: newPassword,
      createdAt: new Date()
    });
    
    userPassword = newPassword;
    alert("Password set successfully!");
    closeModal('passwordSetupModal');
  } catch (error) {
    console.error("Error setting password:", error);
    alert("Error setting password. Please try again.");
  }
}

// Reset password with security question
async function resetPassword() {
  const securityAnswer = document.getElementById('securityAnswer').value;
  const newPassword = document.getElementById('resetNewPassword').value;
  const confirmPassword = document.getElementById('resetConfirmPassword').value;
  
  if (!securityAnswer) {
    alert("Please answer the security question");
    return;
  }
  
  if (!newPassword) {
    alert("Please enter a new password");
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert("New passwords don't match");
    return;
  }
  
  // Get security question and answer from Firestore
  try {
    const securityDoc = await getDoc(doc(db, "users", currentUserUID, "preferences", "security"));
    
    if (!securityDoc.exists()) {
      alert("No security question set up. Please set up a security question first.");
      return;
    }
    
    const securityData = securityDoc.data();
    
    if (securityAnswer.toLowerCase() !== securityData.answer.toLowerCase()) {
      alert("Incorrect answer to security question");
      return;
    }
    
    // Update password
    await setDoc(doc(db, "users", currentUserUID, "preferences", "password"), {
      value: newPassword,
      updatedAt: new Date()
    });
    
    userPassword = newPassword;
    alert("Password reset successfully!");
    closeModal('resetPasswordModal');
  } catch (error) {
    console.error("Error resetting password:", error);
    alert("Error resetting password. Please try again.");
  }
}

// Set up security question
async function setupSecurityQuestion() {
  const question = document.getElementById('securityQuestion').value;
  const answer = document.getElementById('securityAnswerSetup').value;
  
  if (!question || !answer) {
    alert("Please provide both question and answer");
    return;
  }
  
  try {
    await setDoc(doc(db, "users", currentUserUID, "preferences", "security"), {
      question: question,
      answer: answer,
      createdAt: new Date()
    });
    
    alert("Security question set up successfully!");
    closeModal('securitySetupModal');
  } catch (error) {
    console.error("Error setting security question:", error);
    alert("Error setting security question. Please try again.");
  }
}

// Show edit options when edit button is clicked
function showEditOptions(itemId) {
  document.getElementById('editItemId').value = itemId;
  showModal('editOptionsModal');
}

// Handle edit after password verification
async function handleEditWithPassword() {
  const itemId = document.getElementById('editItemId').value;
  const password = document.getElementById('editPassword').value;
  
  if (!password) {
    alert("Please enter your password");
    return;
  }
  
  if (password !== userPassword) {
    alert("Wrong password!");
    return;
  }
  
  closeModal('editOptionsModal');
  editItem(itemId);
}

// Delete item after password verification
async function handleDeleteItem() {
  const itemId = document.getElementById('editItemId').value;
  const password = document.getElementById('editPassword').value;
  
  if (!password) {
    alert("Please enter your password");
    return;
  }
  
  if (password !== userPassword) {
    alert("Wrong password!");
    return;
  }
  
  if (!confirm("Are you sure you want to delete this item? This action cannot be undone.")) {
    return;
  }
  
  try {
    await deleteDoc(doc(db, "users", currentUserUID, "inventory", itemId));
    alert("Item deleted successfully!");
    closeModal('editOptionsModal');
  } catch (error) {
    console.error("Error deleting item:", error);
    alert("Error deleting item. Please try again.");
  }
}

// Modal functions
function showModal(modalId) {
  document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  // Clear input fields when closing modals
  if (modalId === 'editOptionsModal') {
    document.getElementById('editPassword').value = '';
  }
}

// Close modals when clicking on X
document.querySelectorAll('.close').forEach(closeBtn => {
  closeBtn.onclick = function() {
    this.closest('.modal').style.display = 'none';
  };
});

// Close modals when clicking outside
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
};

window.editItem = editItem;
window.searchInventory = searchInventory;
window.toggleAddForm = toggleAddForm;
window.addItem = addItem;
window.setupPassword = setupPassword;
window.resetPassword = resetPassword;
window.setupSecurityQuestion = setupSecurityQuestion;
window.checkPasswordStrength = checkPasswordStrength;
window.showModal = showModal;
window.closeModal = closeModal;
window.showEditOptions = showEditOptions;
window.handleEditWithPassword = handleEditWithPassword;
window.handleDeleteItem = handleDeleteItem;
</script>
</head>
<body>
<h2>Warehouse Inventory</h2>

<div class="header-buttons">
  <button onclick="showModal('passwordSetupModal')">Set Password</button>
  <button onclick="window.location.href='Restock.html'">Restock</button>
</div>

<div class="buttons">
  <input type="text" id="searchInput" placeholder="Search by code or name" onkeyup="searchInventory()" autocomplete="off">
  <button onclick="toggleAddForm()">Add Item</button><button onclick="window.location.href='Dashboard.html'">Back to Dashboard</button>
</div>

<div class="form-container">
  <form id="addForm" onsubmit="addItem(event)">
    <input type="text" id="addCode" placeholder="Product Code" required autocomplete="off">
    <input type="text" id="addName" placeholder="Product Name" required autocomplete="off">
    <input type="number" id="addPrice" placeholder="Price" step="0.01" required autocomplete="off">
    <input type="number" id="addStock" placeholder="Stock" required autocomplete="off">
    <button type="submit">Add Product</button>
  </form>
</div>

<table id="inventoryTable">
  <thead>
    <tr>
      <th>Code</th>
      <th>Name</th>
      <th>Price</th>
      <th>Stock</th>
      <th>Sold</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="6" style="text-align:center;">No inventory yet</td></tr>
  </tbody>
</table>

<div class="total-value">Total Stock Value: ZMW 0.00</div>

<!-- Password Setup Modal -->
<div id="passwordSetupModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 class="modal-title">Set Up Your Password</h3>
    <p>Please set a password to secure your inventory data.</p>
    <input type="password" id="newPassword" placeholder="New Password" onkeyup="checkPasswordStrength(this.value)" class="modal-input" autocomplete="new-password">
    <div id="passwordStrength" class="password-strength"></div>
    <input type="password" id="confirmPassword" placeholder="Confirm Password" class="modal-input" autocomplete="new-password">
    <div class="modal-buttons">
      <button onclick="setupPassword()">Set Password</button>
      <button onclick="showModal('securitySetupModal')">Set Security Question</button>
    </div>
  </div>
</div>

<!-- Edit Options Modal -->
<div id="editOptionsModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 class="modal-title">Edit Options</h3>
    <input type="hidden" id="editItemId">
    <input type="password" id="editPassword" placeholder="Enter Password" class="modal-input" autocomplete="off">
    <div class="modal-buttons">
      <button onclick="handleEditWithPassword()">Edit Item</button>
      <button class="btn-delete" onclick="handleDeleteItem()">Delete Item</button>
      <button onclick="showModal('resetPasswordModal')">Reset Password</button>
      <button onclick="showModal('securitySetupModal')">Change Security</button>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 class="modal-title">Reset Password</h3>
    <p id="securityQuestionDisplay">No security question set up. Please set up a security question first.</p>
    <input type="text" id="securityAnswer" placeholder="Your Answer" class="modal-input" autocomplete="off">
    <input type="password" id="resetNewPassword" placeholder="New Password" class="modal-input" autocomplete="new-password">
    <input type="password" id="resetConfirmPassword" placeholder="Confirm New Password" class="modal-input" autocomplete="new-password">
    <div class="modal-buttons">
      <button onclick="resetPassword()">Reset Password</button>
    </div>
  </div>
</div>

<!-- Security Question Setup Modal -->
<div id="securitySetupModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 class="modal-title">Set Up Security Question</h3>
    <p>This will be used to reset your password if you forget it.</p>
    <input type="text" id="securityQuestion" placeholder="Security Question (e.g., What's your pet's name?)" class="modal-input" autocomplete="off">
    <input type="text" id="securityAnswerSetup" placeholder="Your Answer" class="modal-input" autocomplete="off">
    <div class="modal-buttons">
      <button onclick="setupSecurityQuestion()">Save Security Question</button>
    </div>
  </div>
</div>

<script>
// Load security question when reset modal is shown
document.getElementById('resetPasswordModal').addEventListener('click', async function() {
  try {
    const securityDoc = await getDoc(doc(db, "users", currentUserUID, "preferences", "security"));
    if (securityDoc.exists()) {
      document.getElementById('securityQuestionDisplay').textContent = securityDoc.data().question;
    }
  } catch (error) {
    console.error("Error loading security question:", error);
  }
});

// Clear search input on page load
window.addEventListener('load', function() {
  document.getElementById('searchInput').value = '';
});
</script>
</body>
</html>

