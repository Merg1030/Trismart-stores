<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trismart - Login</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1e1e2f;
      --secondary: #2c2c44;
      --accent: #ffcc00;
      --accent-hover: #e6b800;
      --text: #ffffff;
      --text-secondary: #b8b8cc;
      --card-bg: #27293d;
      --success: #4caf50;
      --danger: #f44336;
      --border-radius: 12px;
      --transition: all 0.25s ease;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, #2d2d47 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .auth-container {
      width: 100%;
      max-width: 450px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }
    .auth-header {
      padding: 28px;
      background: linear-gradient(135deg, var(--secondary), #3a3a5e);
      text-align: center;
    }
    .logo { display:flex; gap:12px; align-items:center; justify-content:center; color:var(--accent); font-weight:700; font-size:1.6rem; }
    .logo i { font-size:1.9rem; }
    .auth-content { padding:30px; }
    .form-group { margin-bottom:20px; }
    label { display:block; color:var(--text-secondary); margin-bottom:8px; font-weight:600; font-size:0.95rem; }
    .input-with-icon { position:relative; }
    .input-with-icon i { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--text-secondary); }
    input[type="email"], input[type="password"] {
      width:100%; padding:14px 14px 14px 44px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); 
      background:rgba(0,0,0,0.18); color:var(--text); font-size:1rem;
    }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:14px; 
      border-radius:8px; cursor:pointer; font-weight:700; border:none; font-size:1rem; }
    .btn-primary { background:var(--accent); color:#111; }
    .btn-primary:hover { background:var(--accent-hover); }
    .alert { padding:12px 14px; border-radius:8px; margin-bottom:15px; display:none; font-weight:600; }
    .alert-success { background: rgba(76,175,80,0.14); border:1px solid var(--success); color:#c8e6c9; }
    .alert-error { background: rgba(244,67,54,0.12); border:1px solid var(--danger); color:#ffbdb0; }
    .error-message { color:var(--danger); font-size:0.85rem; margin-top:6px; display:none; }
    .reset-link { text-align:center; margin-top:15px; }
    .reset-link a { color:var(--accent); text-decoration:none; font-size:0.9rem; }
    .admin-contact { text-align:center; margin-top:20px; color:var(--text-secondary); font-size:0.85rem; }
    .admin-contact a { color:var(--accent); text-decoration:none; }
  </style>
</head>
<body>
  <div class="auth-container" role="main">
    <header class="auth-header">
      <div class="logo"><i class="fas fa-chart-line"></i><span>Trismart</span></div>
      <p style="color:var(--text-secondary); margin-top:5px">Business Management Platform</p>
    </header>

    <section class="auth-content">
      <div id="alertBox" class="alert" role="alert"></div>

      <h3 style="text-align:center; margin-bottom:25px; color:var(--accent)">Login to Your Account</h3>

      <!-- Login Form -->
      <div class="form-group">
        <label for="loginEmail">Email Address</label>
        <div class="input-with-icon">
          <i class="fas fa-envelope"></i>
          <input id="loginEmail" type="email" placeholder="Enter your email" />
        </div>
        <div id="loginEmailError" class="error-message"></div>
      </div>

      <div class="form-group">
        <label for="loginPassword">Password</label>
        <div class="input-with-icon">
          <i class="fas fa-lock"></i>
          <input id="loginPassword" type="password" placeholder="Enter your password" />
        </div>
        <div id="loginPasswordError" class="error-message"></div>
      </div>

      <button class="btn btn-primary" id="btnLogin">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>

      <div class="reset-link">
        <a href="#" id="btnShowReset">Forgot Password?</a>
      </div>

      <!-- Password Reset Form (hidden by default) -->
      <div id="resetSection" style="display:none; margin-top:25px; padding-top:25px; border-top:1px solid rgba(255,255,255,0.06);">
        <h4 style="margin-bottom:15px; color:var(--accent)">Reset Password</h4>
        <div class="form-group">
          <label for="resetEmail">Enter your email</label>
          <div class="input-with-icon">
            <i class="fas fa-envelope"></i>
            <input id="resetEmail" type="email" placeholder="Email address" />
          </div>
          <div id="resetEmailError" class="error-message"></div>
        </div>
        <button class="btn btn-primary" id="btnReset" style="margin-bottom:15px">
          <i class="fas fa-paper-plane"></i> Send Reset Link
        </button>
        <button class="btn" id="btnCancelReset" style="background:transparent; color:var(--text-secondary); border:1px solid rgba(255,255,255,0.06);">
          Cancel
        </button>
      </div>

      <div class="admin-contact">
        <p>Need an account? Contact administrator</p>
        <p><i class="fas fa-envelope"></i> chrischishe@gmail.com</p>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
      authDomain: "trismart-online-app.firebaseapp.com",
      projectId: "trismart-online-app",
      storageBucket: "trismart-online-app.firebasestorage.app",
      messagingSenderId: "867677912389",
      appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
      measurementId: "G-KEWDREKNDB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI Elements
    const alertBox = document.getElementById('alertBox');
    const loginEmailEl = document.getElementById('loginEmail');
    const loginPasswordEl = document.getElementById('loginPassword');
    const resetEmailEl = document.getElementById('resetEmail');
    const resetSection = document.getElementById('resetSection');
    const btnLogin = document.getElementById('btnLogin');
    const btnReset = document.getElementById('btnReset');
    const btnShowReset = document.getElementById('btnShowReset');
    const btnCancelReset = document.getElementById('btnCancelReset');

    // Basic validators
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    // Helpers
    function showAlert(msg, type = 'success') {
      alertBox.textContent = msg;
      alertBox.className = `alert ${type === 'success' ? 'alert-success' : 'alert-error'}`;
      alertBox.style.display = 'block';
      setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
    }

    function setFieldError(id, message) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = message;
      el.style.display = 'block';
    }

    function clearFieldError(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = '';
      el.style.display = 'none';
    }

    // Show/hide reset section
    btnShowReset.addEventListener('click', (e) => {
      e.preventDefault();
      resetSection.style.display = 'block';
      btnShowReset.style.display = 'none';
    });

    btnCancelReset.addEventListener('click', () => {
      resetSection.style.display = 'none';
      btnShowReset.style.display = 'block';
      resetEmailEl.value = '';
      clearFieldError('resetEmailError');
    });

    // LOGIN - FIXED VERSION
    btnLogin.addEventListener('click', async () => {
      const email = loginEmailEl.value.trim().toLowerCase();
      const password = loginPasswordEl.value;

      if (!email || !emailRe.test(email)) { 
        setFieldError('loginEmailError', 'Enter a valid email'); 
        showAlert('Please enter a valid email', 'error'); 
        return; 
      } else { 
        clearFieldError('loginEmailError'); 
      }
      
      if (!password) { 
        setFieldError('loginPasswordError', 'Password required'); 
        showAlert('Please enter your password', 'error'); 
        return; 
      } else { 
        clearFieldError('loginPasswordError'); 
      }

      try {
        // First, try to login with Firebase Authentication
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;

        // Now find the user document in Firestore by email (not by UID as document ID)
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('email', '==', email));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          // User exists in Authentication but not in Firestore
          // This shouldn't happen if admin created account properly
          console.log('User authenticated but not found in Firestore');
          
          // For now, allow login and redirect to sales-dashboard page
          showAlert('Login successful!', 'success');
          setTimeout(() => {
            window.location.href = 'sales-dashboard.html';
          }, 1000);
          return;
        }

        // User found in Firestore
        let userData = null;
        querySnapshot.forEach(doc => {
          userData = doc.data();
        });

        if (!userData) {
          await auth.signOut();
          showAlert('User data not found. Please contact administrator.', 'error');
          return;
        }

        // Check if account is disabled
        if (userData.disabled) {
          await auth.signOut();
          showAlert('Account disabled. Please contact administrator.', 'error');
          return;
        }

        // Check if account is approved (for non-admin users)
        if (!userData.approved && userData.role !== 'admin') {
          await auth.signOut();
          showAlert('Account pending approval. Please contact administrator.', 'error');
          return;
        }

        // Successful login - ALL users redirect to sales-dashboard.html
        showAlert('Login successful!', 'success');
        
        setTimeout(() => {
          // FIXED: All authenticated users go to sales-dashboard.html
          window.location.href = 'sales-dashboard.html';
        }, 1000);

      } catch (err) {
        console.error('Login error:', err);
        let msg = 'Login failed';
        
        if (err.code === 'auth/user-not-found') {
          msg = 'No account found with this email. Contact administrator.';
        } else if (err.code === 'auth/wrong-password') {
          msg = 'Incorrect password.';
        } else if (err.code === 'auth/invalid-email') {
          msg = 'Invalid email address.';
        } else if (err.code === 'auth/too-many-requests') {
          msg = 'Too many failed attempts. Try again later.';
        } else if (err.code === 'auth/network-request-failed') {
          msg = 'Network error. Check your connection.';
        } else {
          msg = 'Login failed: ' + (err.message || 'Unknown error');
        }
        
        showAlert(msg, 'error');
      }
    });

    // RESET PASSWORD
    btnReset.addEventListener('click', async () => {
      const email = resetEmailEl.value.trim().toLowerCase();
      
      if (!email || !emailRe.test(email)) { 
        setFieldError('resetEmailError', 'Enter a valid email'); 
        showAlert('Please enter a valid email', 'error'); 
        return; 
      } else { 
        clearFieldError('resetEmailError'); 
      }

      try {
        await sendPasswordResetEmail(auth, email);
        showAlert('Password reset email sent. Check your inbox.', 'success');
        resetEmailEl.value = '';
        resetSection.style.display = 'none';
        btnShowReset.style.display = 'block';
        
      } catch (err) {
        console.error('Reset error:', err);
        let msg = 'Unable to send reset email';
        if (err.code === 'auth/user-not-found') msg = 'No account found with this email.';
        else if (err.code === 'auth/invalid-email') msg = 'Invalid email address.';
        else msg = err.message || msg;
        showAlert(msg, 'error');
      }
    });

    // Enter key to login
    document.querySelectorAll('input').forEach(input => {
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          if (resetSection.style.display === 'block') {
            btnReset.click();
          } else {
            btnLogin.click();
          }
        }
      });
    });

    // Auto-focus on email field
    window.addEventListener('DOMContentLoaded', () => {
      loginEmailEl.focus();
    });
  </script>
</body>
</html>