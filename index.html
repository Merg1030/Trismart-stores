<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>trismart · scroll both ways</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* clean white background like the example */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }

        body {
            background: #ffffff;
            padding: 1rem;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* main container - scrolls both ways just like the example */
        .showroom {
            max-width: 100%;
            height: 100%;
            margin: 0 auto;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 0.5rem;
            -webkit-overflow-scrolling: touch;
        }

        /* custom scrollbar like the example */
        .showroom::-webkit-scrollbar {
            width: 8px;
        }
        .showroom::-webkit-scrollbar-track {
            background: #eef3f8;
            border-radius: 20px;
        }
        .showroom::-webkit-scrollbar-thumb {
            background: #b0c4de;
            border-radius: 20px;
        }

        /* header - trismart name nice */
        .tri-header {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 0 0.25rem;
        }
        .tri-header h1 {
            font-size: 2.2rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            background: linear-gradient(145deg, #1e2b3c, #2c3e50);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }
        .tri-header span {
            font-size: 1rem;
            font-weight: 300;
            color: #4a5f73;
            margin-left: 0.5rem;
            font-style: italic;
        }
        .tri-header .pill {
            background: #f0f3f7;
            color: #1e2b3c;
            padding: 0.2rem 1rem;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: auto;
            border: 1px solid #d0dcec;
        }

        /* categories filter */
        .categories-section {
            margin: 1rem 0;
            background: white;
            padding: 0.8rem;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            border: 1px solid #f0f5fc;
        }
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .filter-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #3a3a3c;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        .filter-toggle {
            display: none;
            background: #e5e5ea;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 13px;
            color: #000;
        }
        @media (max-width: 768px) { 
            .filter-toggle { display: flex; align-items: center; justify-content: center; } 
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
                max-height: 0;
                overflow: hidden;
                opacity: 0;
                transition: all 0.2s;
            }
            .tabs.active {
                max-height: 200px;
                opacity: 1;
                padding: 6px 0 0;
            }
        }
        .tab-btn {
            padding: 4px 12px;
            background: white;
            border: 1px solid #d1d1d6;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            color: #3a3a3c;
            white-space: nowrap;
            cursor: pointer;
        }
        .tab-btn.active, .tab-btn:hover {
            background: #5a5a5e;
            color: white;
            border-color: #5a5a5e;
        }

        /* search bar */
        .search-container {
            max-width: 280px;
            margin: 0 auto 1rem;
            position: relative;
        }
        .search-bar {
            width: 100%;
            padding: 8px 12px 8px 32px;
            border: 1px solid #d1d1d6;
            border-radius: 40px;
            font-size: 14px;
            background: white;
            outline: none;
        }
        .search-bar:focus {
            border-color: #7c7c82;
        }
        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #8e8e93;
            font-size: 14px;
        }
        .clear-search {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #8e8e93;
            font-size: 12px;
            display: none;
            cursor: pointer;
        }

        /* promo filter */
        .promotion-filter {
            margin: 1rem 0;
            text-align: center;
        }
        .promo-btn {
            background: #636366;
            color: white;
            padding: 6px 16px;
            border-radius: 40px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        /* scroll hint like the example */
        .scroll-hint {
            display: flex;
            gap: 1.5rem;
            margin: 0.5rem 0 1rem 0;
            color: #4d667c;
            font-weight: 400;
            font-size: 0.85rem;
            align-items: center;
        }
        .scroll-hint .arrow-set {
            display: flex;
            gap: 0.2rem;
            background: #f1f6fc;
            padding: 0.3rem 1rem;
            border-radius: 40px;
        }
        .scroll-hint span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        /* MAIN GRID - scrolls horizontally AND vertically like the example! */
        .goods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            padding: 0.5rem 0.25rem 2rem 0.25rem;
            width: 100%;
        }

        /* product card - nice like the example */
        .product-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 0.8rem 0.6rem 1rem 0.6rem;
            box-shadow: 0 8px 20px -8px rgba(0, 20, 30, 0.08), 0 2px 6px rgba(0,0,0,0.02);
            transition: transform 0.2s ease, box-shadow 0.25s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid #f0f5fc;
            cursor: pointer;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 28px -12px rgba(30, 43, 60, 0.15);
            border-color: #dbe7f3;
        }

        /* image wrapper */
        .pic-frame {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 16px;
            background: #f8fafd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.8rem;
            overflow: hidden;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.02), 0 6px 12px -8px #cddcee;
        }

        .pic-frame img {
            width: 85%;
            height: 85%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .product-card:hover .pic-frame img {
            transform: scale(1.05);
        }

        /* product tag */
        .product-tag {
            background: #eaf1fa;
            align-self: flex-start;
            padding: 0.15rem 0.8rem;
            border-radius: 30px;
            font-size: 0.65rem;
            font-weight: 600;
            color: #2d4b6e;
            margin: 0.2rem 0 0.3rem 0;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        /* product description */
        .product-description {
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2c3a;
            line-height: 1.3;
            margin-bottom: 0.2rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 2.3rem;
        }

        /* product price */
        .product-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e3b4f;
            margin-top: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.2rem;
            flex-wrap: wrap;
        }
        .product-price small {
            font-size: 0.75rem;
            font-weight: 400;
            color: #62748b;
        }
        .old-price {
            font-size: 0.8rem;
            font-weight: 400;
            color: #9eafc2;
            text-decoration: line-through;
            margin-left: 0.3rem;
        }

        /* promotion badge */
        .promotion-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #5a5a5e;
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.65rem;
            font-weight: 600;
            z-index: 2;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        /* bottom note like the example */
        .bottom-note {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            color: #59748f;
            font-weight: 300;
            font-size: 0.85rem;
            border-top: 1px dashed #c7d9e9;
            padding-top: 1.2rem;
            padding-bottom: 1rem;
            text-align: center;
        }

        /* modal styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 12px;
        }
        .modal-overlay.active { display: flex; }
        .product-modal {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 360px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .image-slider {
            position: relative;
            height: 200px;
            background: #f2f2f6;
            border-radius: 20px 20px 0 0;
            overflow: hidden;
        }
        .slider-images {
            display: flex;
            height: 100%;
            transition: transform 0.2s ease;
        }
        .slider-image {
            min-width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 10px;
            background: white;
        }
        .slider-nav {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 8px;
            transform: translateY(-50%);
        }
        .slider-btn {
            background: rgba(90,90,94,0.7);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 30px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .slider-dots {
            position: absolute;
            bottom: 10px;
            left: 0; right: 0;
            display: flex;
            justify-content: center;
            gap: 6px;
        }
        .slider-dot {
            width: 5px; height: 5px;
            border-radius: 5px;
            background: rgba(255,255,255,0.6);
            border: none;
            padding: 0;
            cursor: pointer;
            transition: 0.2s;
        }
        .slider-dot.active { background: white; width: 12px; }
        .modal-content { padding: 16px; }
        .modal-category { font-size: 10px; color: #6c6c70; letter-spacing: 0.5px; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .modal-description { font-size: 12px; color: #3a3a3c; margin-bottom: 12px; line-height: 1.4; }
        .modal-price { font-size: 18px; font-weight: 700; }
        .whatsapp-btn {
            background: #25D366; color: white; padding: 12px; border-radius: 12px;
            text-decoration: none; font-size: 14px; display: flex; gap: 6px; justify-content: center;
            margin-top: 12px;
        }
        .close-modal {
            position: absolute; top: 12px; right: 12px;
            background: rgba(90,90,94,0.8); color: white; border: none;
            width: 34px; height: 34px; border-radius: 30px; font-size: 22px; z-index: 10001;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .whatsapp-float {
            position: fixed; bottom: 15px; right: 15px; background: #25D366;
            width: 48px; height: 48px; border-radius: 48px; display: flex;
            align-items: center; justify-content: center; color: white; font-size: 22px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1); z-index: 999;
            text-decoration: none;
        }
        .no-products { 
            grid-column: 1/-1; 
            text-align: center; 
            padding: 40px 10px; 
            color: #666; 
            font-size: 13px;
            background: white;
            border-radius: 10px;
        }
        .loader { 
            border: 3px solid #eee; 
            border-top: 3px solid #5a5a5e; 
            width: 30px; 
            height: 30px; 
            animation: spin 0.8s linear infinite; 
            margin: 10px auto; 
            border-radius: 50%; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* micro thumb modal */
        .micro-thumb-overlay {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: none;
            justify-content: center;
            align-items: flex-end;
            z-index: 10002;
            pointer-events: none;
        }
        .micro-thumb-modal {
            background: rgba(20,20,22,0.85);
            backdrop-filter: blur(16px);
            border-radius: 28px;
            padding: 12px 8px;
            margin: 0 12px;
            max-width: 94%;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .micro-thumb-modal::-webkit-scrollbar { display: none; }
        .thumb-scroll-wrapper {
            display: flex;
            gap: 8px;
            padding: 2px;
            flex: 1;
        }
        .micro-thumb-item {
            flex: 0 0 auto;
            width: 54px;
            height: 54px;
            border-radius: 10px;
            overflow: hidden;
            background: #1c1c1e;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .micro-thumb-item.active { border-color: white; }
        .micro-thumb-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .close-micro-thumb {
            flex: 0 0 auto;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="showroom">
    <div class="tri-header">
        <h1>tri<span style="font-weight:300;">smart</span></h1>
        <span>· scroll both ways ·</span>
        <div class="pill" id="productCount">⚡ loading...</div>
    </div>

    <!-- search bar -->
    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-bar" id="searchInput" placeholder="find products...">
        <button class="clear-search" id="clearSearch"><i class="fas fa-times"></i></button>
    </div>

    <!-- categories filter -->
    <div class="categories-section">
        <div class="filter-header">
            <span class="filter-title">categories</span>
            <button class="filter-toggle" id="filterToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="tabs" id="categoryTabs">
            <button class="tab-btn active" data-category="all">all</button>
            <button class="tab-btn" data-category="phone-accessories">phone</button>
            <button class="tab-btn" data-category="computers-accessories">computer</button>
            <button class="tab-btn" data-category="general-electronics">electronics</button>
        </div>
    </div>

    <!-- promo filter -->
    <div class="promotion-filter">
        <button class="promo-btn" id="promotionFilter">
            <i class="fas fa-tag"></i> offers only
        </button>
    </div>

    <!-- scroll hint like the example -->
    <div class="scroll-hint">
        <div class="arrow-set">← → &nbsp; scroll left / right</div>
        <span>↓ &nbsp; vertical scroll for more</span>
    </div>

    <!-- MAIN GRID - scrolls both ways automatically! -->
    <div class="goods-grid" id="productsGrid"></div>

    <!-- bottom note -->
    <div class="bottom-note" id="bottomNote">
        ⬇️  keep scrolling · more smart goods below  ⬇️
    </div>
</div> <!-- end showroom -->

<!-- modals (same as before) -->
<div class="modal-overlay" id="productModal">
    <button class="close-modal" id="closeModal">×</button>
    <div class="product-modal">
        <div class="image-slider" id="imageSlider">
            <div class="slider-images" id="sliderImages"></div>
            <div class="slider-nav">
                <button class="slider-btn" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
                <button class="slider-btn" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="slider-dots" id="sliderDots"></div>
        </div>
        <div class="modal-content">
            <div class="modal-category" id="modalCategory"></div>
            <h2 class="modal-title" id="modalTitle"></h2>
            <p class="modal-description" id="modalDescription"></p>
            <div class="modal-price">
                <span id="modalOldPrice" class="old-price" style="display:none;"></span>
                <span id="modalPrice"></span>
            </div>
            <div id="modalPromotion" style="display:none; font-size:11px; margin-bottom:8px;"><i class="fas fa-tag"></i> <span id="promotionText"></span></div>
            <div class="modal-stock" id="modalStock" style="font-size:12px; margin-bottom:12px;"></div>
            <a href="#" class="whatsapp-btn" id="whatsappInquiry" target="_blank">
                <i class="fab fa-whatsapp"></i> inquire
            </a>
        </div>
    </div>
</div>

<!-- micro thumb modal -->
<div class="micro-thumb-overlay" id="microThumbOverlay">
    <div class="micro-thumb-modal" id="microThumbModal">
        <div class="thumb-scroll-wrapper" id="thumbScrollWrapper"></div>
        <button class="close-micro-thumb" id="closeMicroThumb"><i class="fas fa-times"></i></button>
    </div>
</div>

<!-- whatsapp float -->
<a href="https://wa.me/260775390905" class="whatsapp-float" target="_blank">
    <i class="fab fa-whatsapp"></i>
</a>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA8fSfsDB0J81iM0FWwbl233nHafBorKV4",
        authDomain: "chris-89177.firebaseapp.com",
        projectId: "chris-89177",
        storageBucket: "chris-89177.firebasestorage.app",
        messagingSenderId: "2833785676",
        appId: "1:2833785676:web:d934ffdbaf64c2f5f5a5e9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const productsCollection = collection(db, "products");

    // DOM
    const productsGrid = document.getElementById('productsGrid');
    const productCount = document.getElementById('productCount');
    const categoryTabs = document.getElementById('categoryTabs');
    const filterToggle = document.getElementById('filterToggle');
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const promotionFilter = document.getElementById('promotionFilter');
    const bottomNote = document.getElementById('bottomNote');
    
    // Modal elements
    const productModal = document.getElementById('productModal');
    const closeModal = document.getElementById('closeModal');
    const modalCategory = document.getElementById('modalCategory');
    const modalTitle = document.getElementById('modalTitle');
    const modalDescription = document.getElementById('modalDescription');
    const modalPrice = document.getElementById('modalPrice');
    const modalOldPrice = document.getElementById('modalOldPrice');
    const modalStock = document.getElementById('modalStock');
    const whatsappInquiry = document.getElementById('whatsappInquiry');
    const modalPromotion = document.getElementById('modalPromotion');
    const promotionText = document.getElementById('promotionText');
    const sliderImages = document.getElementById('sliderImages');
    const sliderDots = document.getElementById('sliderDots');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    // Micro thumb modal
    const microThumbOverlay = document.getElementById('microThumbOverlay');
    const thumbScrollWrapper = document.getElementById('thumbScrollWrapper');
    const closeMicroThumb = document.getElementById('closeMicroThumb');

    // State
    let currentCategory = 'all';
    let currentProducts = [];
    let showPromotionsOnly = false;
    let searchQuery = '';
    let isFilterOpen = false;
    let currentProductImages = [];
    let currentSliderIndex = 0;
    let currentProduct = null;

    // Close micro thumb
    closeMicroThumb.addEventListener('click', () => {
        microThumbOverlay.style.display = 'none';
    });

    // Search
    searchInput.addEventListener('input', (e) => {
        searchQuery = e.target.value.toLowerCase().trim();
        clearSearch.style.display = searchQuery ? 'block' : 'none';
        filterAndDisplayProducts();
    });

    clearSearch.addEventListener('click', () => {
        searchInput.value = '';
        searchQuery = '';
        clearSearch.style.display = 'none';
        filterAndDisplayProducts();
        searchInput.focus();
    });

    // Filter toggle
    filterToggle.addEventListener('click', () => {
        isFilterOpen = !isFilterOpen;
        categoryTabs.classList.toggle('active');
        filterToggle.querySelector('i').className = isFilterOpen ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
    });

    // Promo filter
    promotionFilter.addEventListener('click', () => {
        showPromotionsOnly = !showPromotionsOnly;
        promotionFilter.innerHTML = showPromotionsOnly ? 
            '<i class="fas fa-times"></i> show all' : 
            '<i class="fas fa-tag"></i> offers only';
        filterAndDisplayProducts();
    });

    // Categories
    categoryTabs.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-btn')) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            currentCategory = e.target.dataset.category;
            if (window.innerWidth <= 768) {
                isFilterOpen = false;
                categoryTabs.classList.remove('active');
                filterToggle.querySelector('i').className = 'fas fa-chevron-down';
            }
            filterAndDisplayProducts();
        }
    });

    // Modal functions
    function openProductModal(product) {
        currentProduct = product;
        currentProductImages = product.images && product.images.length ? [...product.images] : [];
        if (product.image) currentProductImages.unshift(product.image);
        if (!currentProductImages.length) currentProductImages = ['https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=200'];

        sliderImages.innerHTML = '';
        sliderDots.innerHTML = '';
        currentSliderIndex = 0;

        currentProductImages.forEach((src, idx) => {
            const img = document.createElement('img');
            img.src = src;
            img.className = 'slider-image';
            img.onerror = () => img.src = 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=200';
            sliderImages.appendChild(img);

            const dot = document.createElement('button');
            dot.className = `slider-dot ${idx === 0 ? 'active' : ''}`;
            dot.addEventListener('click', () => goToSlide(idx));
            sliderDots.appendChild(dot);
        });
        updateSlider();

        modalCategory.textContent = product.category?.replace('-', ' ').toUpperCase() || 'ITEM';
        modalTitle.textContent = product.name || '';
        modalDescription.textContent = product.description || 'No description available';

        if (product.promotion && product.oldPrice) {
            modalOldPrice.style.display = 'inline';
            modalOldPrice.textContent = `ZMW ${Number(product.oldPrice).toLocaleString()}`;
            modalPrice.textContent = `ZMW ${Number(product.price).toLocaleString()}`;
        } else {
            modalOldPrice.style.display = 'none';
            modalPrice.textContent = `ZMW ${Number(product.price || 0).toLocaleString()}`;
        }

        if (product.promotion) {
            modalPromotion.style.display = 'block';
            promotionText.textContent = product.promotion;
        } else modalPromotion.style.display = 'none';

        const stock = product.stock ?? 0;
        if (stock > 5) modalStock.textContent = `✅ in stock (${stock})`;
        else if (stock > 0) modalStock.textContent = `⚠️ low stock (${stock})`;
        else modalStock.textContent = '❌ out of stock';

        const msg = `Hi! I'm interested in: ${product.name} – ZMW ${product.price}`;
        whatsappInquiry.href = `https://wa.me/260775390905?text=${encodeURIComponent(msg)}`;

        productModal.classList.add('active');

        // Setup thumbnails
        thumbScrollWrapper.innerHTML = '';
        currentProductImages.forEach((imgSrc, idx) => {
            const thumbWrap = document.createElement('div');
            thumbWrap.className = `micro-thumb-item ${idx === currentSliderIndex ? 'active' : ''}`;
            const thumbImg = document.createElement('img');
            thumbImg.src = imgSrc;
            thumbImg.className = 'micro-thumb-img';
            thumbImg.onerror = () => thumbImg.src = 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=100';
            thumbWrap.appendChild(thumbImg);
            thumbWrap.addEventListener('click', () => goToSlide(idx));
            thumbScrollWrapper.appendChild(thumbWrap);
        });

        microThumbOverlay.style.display = 'flex';
    }

    function goToSlide(index) {
        if (index >= 0 && index < currentProductImages.length) {
            currentSliderIndex = index;
            updateSlider();
            document.querySelectorAll('.slider-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
            const thumbs = thumbScrollWrapper.querySelectorAll('.micro-thumb-item');
            thumbs.forEach((t, i) => t.classList.toggle('active', i === index));
        }
    }

    function updateSlider() {
        sliderImages.style.transform = `translateX(-${currentSliderIndex * 100}%)`;
    }

    prevBtn.addEventListener('click', () => {
        currentSliderIndex = (currentSliderIndex - 1 + currentProductImages.length) % currentProductImages.length;
        goToSlide(currentSliderIndex);
    });

    nextBtn.addEventListener('click', () => {
        currentSliderIndex = (currentSliderIndex + 1) % currentProductImages.length;
        goToSlide(currentSliderIndex);
    });

    closeModal.addEventListener('click', () => {
        productModal.classList.remove('active');
        microThumbOverlay.style.display = 'none';
    });

    productModal.addEventListener('click', (e) => {
        if (e.target === productModal) {
            productModal.classList.remove('active');
            microThumbOverlay.style.display = 'none';
        }
    });

    // Filter products
    function getFilteredProducts() {
        return currentProducts.filter(p => {
            if (currentCategory !== 'all' && p.category !== currentCategory) return false;
            if (showPromotionsOnly && !p.promotion) return false;
            if (searchQuery) {
                const nameMatch = p.name?.toLowerCase().includes(searchQuery);
                const descMatch = p.description?.toLowerCase().includes(searchQuery);
                const catMatch = p.category?.toLowerCase().includes(searchQuery);
                if (!nameMatch && !descMatch && !catMatch) return false;
            }
            return true;
        });
    }

    // Create product card
    function createProductCard(product) {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        const imgSrc = (product.images && product.images[0]) || product.image || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=200';
        const badge = product.promotion ? `<div class="promotion-badge">${product.promotion.slice(0,10)}</div>` : '';
        const category = product.category?.replace('-', ' ').slice(0,15) || 'item';
        const oldPriceHtml = product.promotion && product.oldPrice ? 
            `<span class="old-price">ZMW ${product.oldPrice}</span>` : '';
        
        card.innerHTML = `
            ${badge}
            <div class="pic-frame">
                <img src="${imgSrc}" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=200'">
            </div>
            <div class="product-tag">${category}</div>
            <div class="product-description">${product.name?.slice(0,40) || ''}</div>
            <div class="product-price">
                ${oldPriceHtml}
                ZMW ${product.price ?? 0}<small>.00</small>
            </div>
        `;
        
        card.addEventListener('click', () => openProductModal(product));
        return card;
    }

    // Display products - simple grid that scrolls both ways!
    function filterAndDisplayProducts() {
        const filtered = getFilteredProducts();
        
        // Update product count
        productCount.innerHTML = `⚡ ${filtered.length} items`;
        
        // Update bottom note
        if (filtered.length > 12) {
            bottomNote.innerHTML = '⬇️  keep scrolling · more smart goods below  ⬇️';
        } else {
            bottomNote.innerHTML = '⬇️  end of collection  ⬇️';
        }
        
        // Clear and repopulate grid
        productsGrid.innerHTML = '';
        
        if (filtered.length === 0) {
            productsGrid.innerHTML = '<div class="no-products">no products found</div>';
            return;
        }
        
        filtered.forEach(product => {
            productsGrid.appendChild(createProductCard(product));
        });
    }

    // Load data from Firestore
    onSnapshot(productsCollection, (snap) => {
        currentProducts = [];
        snap.forEach(doc => {
            let data = doc.data();
            data.id = doc.id;
            currentProducts.push(data);
        });
        
        // Sort by newest first
        currentProducts.sort((a,b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return new Date(b.createdAt) - new Date(a.createdAt);
        });
        
        filterAndDisplayProducts();
    }, (err) => {
        console.error("Firestore error:", err);
        productsGrid.innerHTML = `<div class="no-products">⚠️ error loading products</div>`;
    });
</script>
</body>
</html>
