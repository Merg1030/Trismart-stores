<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trismart Accounts - Dashboard</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Firebase (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    :root{
      --sidebar-width:260px;
      --primary:#1e3c72;
      --accent:#2a5298;
      --muted:#666;
      --surface:#ffffff;
      --shadow: 0 6px 18px rgba(16,24,40,0.05);
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:#f5f7fb;color:#222;min-height:100vh}

    /* Sidebar (uniform look across app) */
    .sidebar{
      position:fixed;left:0;top:0;bottom:0;width:var(--sidebar-width);padding:22px;
      display:flex;flex-direction:column;gap:20px;background:linear-gradient(180deg,var(--primary) 0%,var(--accent) 100%);color:#fff;z-index:60;
      box-shadow:6px 0 30px rgba(16,24,40,0.12);transition:transform .28s ease, width .28s ease;overflow:auto;
    }
    .sidebar.hidden{transform:translateX(-120%)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand i{font-size:1.6rem;background:rgba(255,255,255,0.07);padding:10px;border-radius:8px}
    .brand .title{font-weight:700;font-size:1.05rem}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .nav a{display:flex;gap:12px;align-items:center;padding:10px;border-radius:8px;color:rgba(255,255,255,0.95);text-decoration:none}
    .nav a:hover{background:rgba(255,255,255,0.06);transform:translateX(4px)}
    .nav a.active{background:rgba(255,255,255,0.10);border-right:4px solid rgba(255,255,255,0.12)}
    .sidebar .footer{margin-top:auto;font-size:.9rem;opacity:.95}

    /* Main layout */
    .main{margin-left:var(--sidebar-width);transition:margin-left .28s ease;padding-bottom:60px;min-height:100vh}
    .main.sidebar-hidden{margin-left:0}

    .header{background:var(--surface);padding:12px 20px;box-shadow:0 2px 10px rgba(0,0,0,0.06);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:30}
    .header-left{display:flex;align-items:center;gap:12px}
    .sidebar-toggle{width:40px;height:40px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .logo-text{font-weight:700;color:var(--primary)}
    .avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;font-weight:700}

    .container{padding:22px;max-width:1200px;margin:18px auto}

    /* Cards */
    .card{background:var(--surface);border-radius:10px;box-shadow:var(--shadow);overflow:hidden;margin-bottom:16px}
    .card-header{padding:14px 18px;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .card-body{padding:12px 18px;overflow:auto}
    .form-control{padding:10px;border-radius:8px;border:1px solid #e6edf3;width:100%}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#fff}

    /* Account Cards Grid */
    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .account-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      border-left: 5px solid var(--primary);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .account-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .account-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
    }

    .account-name {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .account-type {
      display: inline-block;
      padding: 4px 12px;
      background: #f0f5ff;
      color: var(--primary);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .account-balance {
      font-size: 1.8rem;
      font-weight: 700;
      color: #2c3e50;
      margin: 10px 0;
    }

    .account-currency {
      font-size: 0.9rem;
      color: #666;
      font-weight: 500;
    }

    .account-notes {
      color: #666;
      font-size: 0.9rem;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      line-height: 1.4;
    }

    .no-accounts {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .no-accounts i {
      font-size: 3rem;
      color: #ddd;
      margin-bottom: 20px;
    }

    .no-accounts h3 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: #444;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* Modal styles */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:200;align-items:center;justify-content:center;padding:16px}
    .modal.active{display:flex}
    .modal-card{background:white;border-radius:8px;max-width:520px;width:100%;overflow:hidden}
    .modal-head{background:var(--primary);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:14px}
    .modal-footer{padding:12px;background:#f8fafc;display:flex;justify-content:flex-end;gap:8px}

    @media (max-width: 900px){
      .sidebar{transform:translateX(-110%);position:fixed}
      .sidebar.open{transform:translateX(0)}
      .main{margin-left:0;padding:16px}
      .accounts-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }

    @media (max-width: 600px){
      .accounts-grid {
        grid-template-columns: 1fr;
      }
      .account-card {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <i class="fas fa-hand-holding-usd"></i>
      <div class="title">TRI<span style="color: rgba(255,255,255,0.95)">SMART</span></div>
    </div>

    <nav class="nav">
      <a class="menu-item" href="dashboard.html"><i class="fas fa-chart-pie"></i><span>Dashboard</span></a>
      <a class="menu-item" href="customers.html"><i class="fas fa-users"></i><span>Customers</span></a>
      <a class="menu-item" href="loans.html"><i class="fas fa-file-invoice-dollar"></i><span>Loans</span></a>
      <a class="menu-item active" href="accounts.html"><i class="fas fa-book"></i><span>Accounts</span></a>
      <a class="menu-item" href="reports.html"><i class="fas fa-chart-line"></i><span>Reports</span></a>
      <a class="menu-item" id="sidebarLogout" href="#"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
    </nav>

    <div style="margin-top:auto;font-size:.9rem;opacity:.95;">
      <div style="font-weight:700;">Welcome, <span id="sidebarName">Chris</span></div>
      <div class="small-muted">Account management</div>
    </div>
  </aside>

  <main class="main" id="main">
    <header class="header">
      <div class="header-left">
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar"><i class="fas fa-bars"></i></button>
        <div class="logo-text">TRI SMART ACCOUNTS</div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="avatar" id="userAvatar">C</div>
      </div>
    </header>

    <div class="container">
      <div id="errorBox" style="display:none"></div>

      <!-- Create account / filters -->
      <div class="card">
        <div class="card-header">
          <strong>Accounts</strong>
          <div style="display:flex;gap:10px;align-items:center">
            <input id="search" placeholder="Search by name or type..." class="form-control" style="width:260px">
            <select id="filterType" class="form-control" style="width:160px">
              <option value="all">All types</option>
              <option value="cash">Cash book</option>
              <option value="interest">Interest account</option>
              <option value="asset">Asset</option>
              <option value="liability">Liability</option>
              <option value="equity">Equity</option>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>

            <button id="openCreateBtn" class="btn btn-primary">Create Account</button>
          </div>
        </div>

        <div class="card-body" id="accountsContainer">
          <div style="text-align:center;padding:18px;color:#666" id="loadingAccounts">
            <i class="fas fa-spinner fa-spin"></i>
            <div style="margin-top:8px">Loading accounts...</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Create account modal -->
  <div class="modal" id="createModal">
    <div class="modal-card">
      <div class="modal-head"><div>Create Account</div><button class="dots-btn" id="closeCreate">âœ•</button></div>
      <div class="modal-body">
        <div style="margin-bottom:10px">
          <label style="display:block;margin-bottom:6px">Account Name</label>
          <input id="acctName" class="form-control" type="text" placeholder="e.g., Cash Book, Interest Receivable">
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
          <div>
            <label style="display:block;margin-bottom:6px">Type</label>
            <select id="acctType" class="form-control">
              <option value="cash">Cash book</option>
              <option value="interest">Interest account</option>
              <option value="asset">Asset</option>
              <option value="liability">Liability</option>
              <option value="equity">Equity</option>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
          </div>

          <div>
            <label style="display:block;margin-bottom:6px">Opening Balance (ZMW)</label>
            <input id="acctBalance" class="form-control" type="number" step="0.01" value="0">
          </div>
        </div>

        <div style="margin-bottom:10px">
          <label style="display:block;margin-bottom:6px">Notes (optional)</label>
          <input id="acctNotes" class="form-control" type="text" placeholder="Notes">
        </div>

        <div class="small-muted">Accounts are stored in the "accounts" collection. Currency is ZMW.</div>
      </div>
      <div class="modal-footer">
        <button id="cancelCreate" class="btn">Cancel</button>
        <button id="saveCreate" class="btn btn-primary">Create</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config (same as your other pages)
    const firebaseConfig = {
      apiKey: "AIzaSyB-lm7Y3r1F6VvY8PKvY8glLabZDbJsHM1k",
      authDomain: "trismartstores.firebaseapp.com",
      projectId: "trismartstores",
      storageBucket: "trismartstores.appspot.com",
      messagingSenderId: "416692703333",
      appId: "1:416692703333:web:d4b60292621435c748f68c",
      measurementId: "G-NJPQ7L3QWJ"
    };

    // Init Firebase safely
    let app, db;
    try { 
      app = firebase.initializeApp(firebaseConfig); 
      db = firebase.firestore(); 
      console.log('Firebase initialized successfully');
    } catch(e) { 
      console.warn('Firebase init', e); 
      if (firebase.apps && firebase.apps.length) { 
        app = firebase.app(); 
        db = firebase.firestore(); 
      }
    }

    const currentUser = localStorage.getItem('username') || 'Chris';
    document.getElementById('sidebarName').textContent = currentUser;
    document.getElementById('userAvatar').textContent = currentUser.charAt(0).toUpperCase();

    // DOM elements
    const sidebar = document.getElementById('sidebar');
    const main = document.getElementById('main');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const openCreateBtn = document.getElementById('openCreateBtn');
    const createModal = document.getElementById('createModal');
    const closeCreate = document.getElementById('closeCreate');
    const cancelCreate = document.getElementById('cancelCreate');
    const saveCreate = document.getElementById('saveCreate');
    const acctName = document.getElementById('acctName');
    const acctType = document.getElementById('acctType');
    const acctBalance = document.getElementById('acctBalance');
    const acctNotes = document.getElementById('acctNotes');
    const accountsContainer = document.getElementById('accountsContainer');
    const loadingAccounts = document.getElementById('loadingAccounts');
    const searchInput = document.getElementById('search');
    const filterType = document.getElementById('filterType');
    const errorBox = document.getElementById('errorBox');

    // Variables
    let allAccounts = [];
    let createModalMode = 'create';
    let editAccountId = null;

    // Helper functions
    function escapeHtml(s){ 
      if(s===undefined||s===null) return ''; 
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;'); 
    }

    function showError(msg){ 
      errorBox.style.display = 'block'; 
      errorBox.innerHTML = `<div class="error-box">${escapeHtml(msg)}</div>`; 
    }

    function clearError(){ 
      errorBox.style.display = 'none'; 
      errorBox.innerHTML = ''; 
    }

    function formatCurrency(amount) {
      return Number(amount).toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // Sidebar toggle
    sidebarToggle.addEventListener('click', () => {
      if (window.innerWidth < 900) sidebar.classList.toggle('open');
      else { sidebar.classList.toggle('hidden'); main.classList.toggle('sidebar-hidden'); }
    });

    document.querySelectorAll('.nav a').forEach(a => a.addEventListener('click', () => {
      if (window.innerWidth < 900) sidebar.classList.remove('open');
    }));

    document.getElementById('sidebarLogout').addEventListener('click', () => {
      localStorage.removeItem('isLoggedIn'); 
      localStorage.removeItem('username'); 
      window.location.href='index.html';
    });

    // Filter handling
    const ACC_FILTER_KEY = 'accountsFilterType';
    const persisted = localStorage.getItem(ACC_FILTER_KEY) || 'all';
    filterType.value = persisted;

    filterType.addEventListener('change', () => {
      localStorage.setItem(ACC_FILTER_KEY, filterType.value);
      renderAccounts();
    });

    searchInput.addEventListener('input', () => renderAccounts());

    // Modal handling
    openCreateBtn.addEventListener('click', () => {
      acctName.value = ''; 
      acctType.value = 'cash'; 
      acctBalance.value = '0'; 
      acctNotes.value = '';
      createModalMode = 'create';
      editAccountId = null;
      createModal.classList.add('active');
    });
    
    closeCreate.addEventListener('click', () => createModal.classList.remove('active'));
    cancelCreate.addEventListener('click', () => createModal.classList.remove('active'));

    // Create/Edit account
    saveCreate.addEventListener('click', async () => {
      const name = (acctName.value || '').trim();
      const type = acctType.value || 'cash';
      const opening = parseFloat(acctBalance.value || 0) || 0;
      const notes = acctNotes.value || '';
      
      if (!name) return alert('Enter account name');
      
      saveCreate.disabled = true;
      saveCreate.textContent = 'Saving...';
      
      try {
        if (createModalMode === 'create') {
          const data = {
            name,
            type,
            balance: Number(opening),
            currency: 'ZMW',
            notes,
            createdBy: currentUser,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          await db.collection('accounts').add(data);
          alert('Account created');
        } else {
          // edit existing account
          await db.collection('accounts').doc(editAccountId).update({
            name,
            type,
            balance: Number(opening),
            notes,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('Account updated');
        }
        
        createModal.classList.remove('active');
        await loadAccounts();
      } catch (err) {
        console.error('save account', err);
        alert('Error saving account: ' + (err.message || err));
      } finally {
        saveCreate.disabled = false;
        saveCreate.textContent = 'Create';
      }
    });

    // Load accounts
    async function loadAccounts() {
      loadingAccounts.style.display = 'block';
      accountsContainer.innerHTML = '';
      clearError();
      
      try {
        console.log('Loading accounts for user:', currentUser);
        
        // Try different queries to find accounts
        let docs = [];
        try {
          const q = await db.collection('accounts').where('createdBy', '==', currentUser).get();
          docs = q.docs;
          console.log(`Found ${docs.length} accounts by createdBy`);
        } catch (e1) {
          console.log('createdBy query failed, trying userId:', e1);
          try {
            const q2 = await db.collection('accounts').where('userId', '==', currentUser).get();
            docs = q2.docs;
            console.log(`Found ${docs.length} accounts by userId`);
          } catch (e2) {
            console.log('userId query failed, getting all accounts:', e2);
            const all = await db.collection('accounts').get();
            docs = all.docs;
            console.log(`Found ${docs.length} total accounts`);
          }
        }

        // Process accounts
        allAccounts = [];
        for (const doc of docs) {
          const data = doc.data();
          
          // Filter by user if we got all accounts
          if (data.createdBy !== currentUser && data.userId !== currentUser) {
            continue;
          }
          
          allAccounts.push({
            id: doc.id,
            name: data.name || '',
            type: data.type || '',
            balance: Number(data.balance || 0),
            currency: data.currency || 'ZMW',
            notes: data.notes || '',
            createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt)) : new Date()
          });
        }
        
        console.log(`Processed ${allAccounts.length} accounts for display`);
        renderAccounts();
      } catch (err) {
        console.error('loadAccounts error:', err);
        showError('Failed to load accounts: ' + (err.message || err));
        accountsContainer.innerHTML = `
          <div class="no-accounts">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error loading accounts</h3>
            <p>Check console for details</p>
          </div>
        `;
      } finally {
        loadingAccounts.style.display = 'none';
      }
    }

    // Render accounts as cards
    function renderAccounts() {
      if (!allAccounts || allAccounts.length === 0) {
        accountsContainer.innerHTML = `
          <div class="no-accounts">
            <i class="fas fa-book"></i>
            <h3>No accounts yet</h3>
            <p>Click "Create Account" to add your first account</p>
          </div>
        `;
        return;
      }

      const term = (searchInput.value || '').toLowerCase().trim();
      const selType = filterType.value || 'all';
      
      // Apply filters
      let filtered = allAccounts.slice();
      
      if (selType !== 'all') {
        filtered = filtered.filter(a => a.type === selType);
      }
      
      if (term) {
        filtered = filtered.filter(a => 
          (a.name || '').toLowerCase().includes(term) || 
          (a.type || '').toLowerCase().includes(term) || 
          (a.id || '').toLowerCase().includes(term)
        );
      }
      
      if (!filtered.length) {
        accountsContainer.innerHTML = `
          <div class="no-accounts">
            <i class="fas fa-search"></i>
            <h3>No matching accounts</h3>
            <p>Try adjusting your search or filter</p>
          </div>
        `;
        return;
      }
      
      // Sort by name
      filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      
      // Create grid container
      const grid = document.createElement('div');
      grid.className = 'accounts-grid';
      
      // Add cards to grid
      filtered.forEach(account => {
        const card = document.createElement('div');
        card.className = 'account-card';
        card.onclick = () => {
          // Navigate to journal page with account ID
          window.location.href = `journal.html?accountId=${encodeURIComponent(account.id)}`;
        };
        
        // Determine card color based on account type
        let typeColor = '#1e3c72'; // default primary
        switch(account.type) {
          case 'cash': typeColor = '#27ae60'; break;
          case 'asset': typeColor = '#2980b9'; break;
          case 'liability': typeColor = '#e74c3c'; break;
          case 'equity': typeColor = '#9b59b6'; break;
          case 'income': typeColor = '#f39c12'; break;
          case 'expense': typeColor = '#d35400'; break;
          case 'interest': typeColor = '#16a085'; break;
        }
        
        card.style.borderLeftColor = typeColor;
        
        // Create card content
        card.innerHTML = `
          <div class="account-name">${escapeHtml(account.name)}</div>
          <div class="account-type" style="background: ${typeColor}20; color: ${typeColor}">
            ${escapeHtml(account.type)}
          </div>
          <div class="account-balance">
            ${formatCurrency(account.balance)}
            <span class="account-currency">${escapeHtml(account.currency)}</span>
          </div>
          ${account.notes ? `<div class="account-notes">${escapeHtml(account.notes)}</div>` : ''}
          <div style="margin-top: 15px; font-size: 0.8rem; color: #888;">
            Click to view journal
          </div>
        `;
        
        grid.appendChild(card);
      });
      
      // Clear container and add grid
      accountsContainer.innerHTML = '';
      accountsContainer.appendChild(grid);
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Accounts page loaded, initializing...');
      loadAccounts();
    });
  </script>
</body>
</html>