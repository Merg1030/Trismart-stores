<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Manage Users</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #0f1220; color: white; padding: 20px; }
.container { max-width: 1200px; margin: 0 auto; }

.header { 
  text-align: center; 
  margin-bottom: 20px; 
  padding-bottom: 15px; 
  border-bottom: 1px solid #27293d; 
}
.header h1 { color: #ffcc00; font-size: 24px; }

.controls { 
  background: #191b2a; 
  padding: 15px; 
  border-radius: 10px; 
  margin-bottom: 20px; 
  display: flex; 
  gap: 15px; 
  align-items: center;
}

.btn { 
  padding: 10px 15px; 
  background: #ffcc00; 
  color: #000; 
  border: none; 
  border-radius: 6px; 
  cursor: pointer; 
  font-weight: bold; 
  display: flex; 
  align-items: center; 
  gap: 8px; 
}
.btn:hover { background: #e6b800; }

.search-box { flex: 1; }
.search-input { 
  width: 100%; 
  padding: 10px; 
  background: transparent; 
  border: 1px solid #27293d; 
  border-radius: 6px; 
  color: white; 
}

.table-container { 
  background: #191b2a; 
  border-radius: 10px; 
  overflow: hidden; 
  overflow-x: auto; 
}
.user-table { 
  width: 100%; 
  border-collapse: collapse; 
  min-width: 800px; 
}
.user-table th { 
  background: #27293d; 
  padding: 15px; 
  text-align: left; 
  color: #ffcc00; 
  font-weight: bold; 
}
.user-table td { 
  padding: 15px; 
  border-bottom: 1px solid #27293d; 
}
.user-table tr:hover { background: rgba(255,255,255,0.05); }

.badge { 
  padding: 5px 10px; 
  border-radius: 4px; 
  font-size: 12px; 
  font-weight: bold; 
}
.badge-active { background: rgba(76,175,80,0.2); color: #4caf50; }
.badge-inactive { background: rgba(244,67,54,0.2); color: #f44336; }
.badge-pending { background: rgba(255,152,0,0.2); color: #ff9800; }
.badge-admin { background: rgba(255,152,0,0.2); color: #ff9800; }
.badge-sales { background: rgba(33,150,243,0.2); color: #2196f3; }

.action-btn { 
  padding: 5px 10px; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  font-size: 12px; 
  margin-right: 5px; 
}
.approve-btn { background: rgba(76,175,80,0.2); color: #4caf50; }
.disable-btn { background: rgba(244,67,54,0.2); color: #f44336; }
.enable-btn { background: rgba(33,150,243,0.2); color: #2196f3; }

.loading { text-align: center; padding: 40px; color: #b8b8cc; }
.empty { text-align: center; padding: 40px; color: #b8b8cc; }

/* Modal */
.modal { 
  display: none; 
  position: fixed; 
  top: 0; left: 0; 
  width: 100%; height: 100%; 
  background: rgba(0,0,0,0.8); 
  justify-content: center; 
  align-items: center; 
  z-index: 1000; 
}
.modal.show { display: flex; }
.modal-content { 
  background: #191b2a; 
  padding: 20px; 
  border-radius: 10px; 
  width: 90%; 
  max-width: 500px; 
  max-height: 90vh; 
  overflow-y: auto; 
}
.modal-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 20px; 
  padding-bottom: 15px; 
  border-bottom: 1px solid #27293d; 
}
.modal-header h3 { color: #ffcc00; }
.close-btn { 
  background: none; 
  border: none; 
  color: #b8b8cc; 
  font-size: 20px; 
  cursor: pointer; 
}

.form-group { margin-bottom: 15px; }
.form-group label { 
  display: block; 
  color: #b8b8cc; 
  margin-bottom: 5px; 
  font-size: 14px; 
}
.form-control { 
  width: 100%; 
  padding: 10px; 
  background: transparent; 
  border: 1px solid #27293d; 
  border-radius: 6px; 
  color: white; 
}

.alert { 
  padding: 10px; 
  border-radius: 6px; 
  margin-bottom: 15px; 
  display: none; 
}
.alert-success { background: rgba(76,175,80,0.2); color: #4caf50; border: 1px solid #4caf50; }
.alert-error { background: rgba(244,67,54,0.2); color: #f44336; border: 1px solid #f44336; }

.password-info {
  font-size: 12px;
  color: #b8b8cc;
  margin-top: 5px;
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1><i class="fas fa-users"></i> User Management</h1>
    <p style="color: #b8b8cc; margin-top: 10px;">Create user accounts with custom passwords</p>
  </div>
  
  <div id="alertBox" class="alert"></div>
  
  <div class="controls">
    <div class="search-box">
      <input type="text" id="searchInput" class="search-input" placeholder="Search users...">
    </div>
    <button class="btn" id="createUserBtn">
      <i class="fas fa-user-plus"></i> Create User
    </button>
    <button class="btn" id="refreshBtn">
      <i class="fas fa-sync"></i> Refresh
    </button>
  </div>
  
  <div class="table-container">
    <table class="user-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Role</th>
          <th>Status</th>
          <th>Account</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTable">
        <tr><td colspan="7" class="loading">Loading users...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Create User Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-user-plus"></i> Create New User</h3>
      <button class="close-btn" id="closeModal">&times;</button>
    </div>
    
    <div class="form-group">
      <label>First Name *</label>
      <input type="text" id="firstName" class="form-control" placeholder="John" required>
    </div>
    
    <div class="form-group">
      <label>Last Name *</label>
      <input type="text" id="lastName" class="form-control" placeholder="Doe" required>
    </div>
    
    <div class="form-group">
      <label>Email Address *</label>
      <input type="email" id="userEmail" class="form-control" placeholder="john@example.com" required>
    </div>
    
    <div class="form-group">
      <label>Phone Number *</label>
      <input type="tel" id="userPhone" class="form-control" placeholder="0987654321" required>
    </div>
    
    <div class="form-group">
      <label>Password *</label>
      <input type="text" id="userPassword" class="form-control" placeholder="Enter password" required>
      <div class="password-info">
        <i class="fas fa-info-circle"></i> Enter the password for this user (minimum 6 characters)
      </div>
    </div>
    
    <div class="form-group">
      <label>Confirm Password *</label>
      <input type="text" id="confirmPassword" class="form-control" placeholder="Confirm password" required>
    </div>
    
    <div class="form-group">
      <label>Role *</label>
      <select id="userRole" class="form-control">
        <option value="sales">Sales Agent</option>
        <option value="admin">Administrator</option>
      </select>
    </div>
    
    <button class="btn" id="createBtn" style="width: 100%; margin-top: 10px;">
      <i class="fas fa-user-plus"></i> Create User Account
    </button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged,
  createUserWithEmailAndPassword 
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  getDocs,
  setDoc,
  doc,
  updateDoc,
  serverTimestamp,
  query,
  where 
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
  authDomain: "trismart-online-app.firebaseapp.com",
  projectId: "trismart-online-app",
  storageBucket: "trismart-online-app.firebasestorage.app",
  messagingSenderId: "867677912389",
  appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
  measurementId: "G-KEWDREKNDB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM Elements
const usersTable = document.getElementById('usersTable');
const createUserBtn = document.getElementById('createUserBtn');
const refreshBtn = document.getElementById('refreshBtn');
const alertBox = document.getElementById('alertBox');
const userModal = document.getElementById('userModal');
const closeModal = document.getElementById('closeModal');
const createBtn = document.getElementById('createBtn');

// Simple functions
function showAlert(message, type = 'success') {
  alertBox.textContent = message;
  alertBox.className = `alert alert-${type}`;
  alertBox.style.display = 'block';
  setTimeout(() => {
    alertBox.style.display = 'none';
  }, 5000);
}

// Load users
async function loadUsers() {
  try {
    const usersRef = collection(db, "users");
    const snapshot = await getDocs(usersRef);
    
    if (snapshot.empty) {
      usersTable.innerHTML = '<tr><td colspan="7" class="empty">No users yet. Create your first user!</td></tr>';
      return;
    }
    
    let html = '';
    snapshot.forEach(docSnap => {
      const user = docSnap.data();
      
      const statusBadge = user.disabled ? 
        '<span class="badge badge-inactive">Inactive</span>' : 
        '<span class="badge badge-active">Active</span>';
      
      const accountBadge = user.approved ? 
        '<span class="badge badge-active">Approved</span>' : 
        '<span class="badge badge-pending">Pending</span>';
      
      const roleBadge = user.role === 'admin' ? 
        '<span class="badge badge-admin">Admin</span>' : 
        '<span class="badge badge-sales">Sales</span>';
      
      const fullName = user.fullName || `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'N/A';
      
      let actionBtn = '';
      if (!user.approved && user.role !== 'admin') {
        actionBtn = `<button class="action-btn approve-btn" onclick="approveUser('${docSnap.id}')">Approve</button>`;
      } else if (!user.disabled) {
        actionBtn = `<button class="action-btn disable-btn" onclick="disableUser('${docSnap.id}')">Disable</button>`;
      } else {
        actionBtn = `<button class="action-btn enable-btn" onclick="enableUser('${docSnap.id}')">Enable</button>`;
      }
      
      html += `
        <tr>
          <td>${fullName}</td>
          <td>${user.email || 'N/A'}</td>
          <td>${user.phone || 'N/A'}</td>
          <td>${roleBadge}</td>
          <td>${statusBadge}</td>
          <td>${accountBadge}</td>
          <td>${actionBtn}</td>
        </tr>
      `;
    });
    
    usersTable.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading users:', error);
    usersTable.innerHTML = '<tr><td colspan="7" class="empty">Error loading users</td></tr>';
  }
}

// User actions
window.approveUser = async (userId) => {
  try {
    const userRef = doc(db, "users", userId);
    await updateDoc(userRef, {
      approved: true,
      disabled: false
    });
    showAlert('User approved successfully!');
    loadUsers();
  } catch (error) {
    showAlert('Error: ' + error.message, 'error');
  }
}

window.disableUser = async (userId) => {
  if (!confirm('Disable this user?')) return;
  try {
    const userRef = doc(db, "users", userId);
    await updateDoc(userRef, { disabled: true });
    showAlert('User disabled!');
    loadUsers();
  } catch (error) {
    showAlert('Error: ' + error.message, 'error');
  }
}

window.enableUser = async (userId) => {
  try {
    const userRef = doc(db, "users", userId);
    await updateDoc(userRef, { disabled: false });
    showAlert('User enabled!');
    loadUsers();
  } catch (error) {
    showAlert('Error: ' + error.message, 'error');
  }
}

// Modal functions
createUserBtn.addEventListener('click', () => {
  resetForm();
  userModal.classList.add('show');
});

closeModal.addEventListener('click', () => {
  userModal.classList.remove('show');
});

function resetForm() {
  document.getElementById('firstName').value = '';
  document.getElementById('lastName').value = '';
  document.getElementById('userEmail').value = '';
  document.getElementById('userPhone').value = '';
  document.getElementById('userPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  document.getElementById('userRole').value = 'sales';
}

// Create user - FIXED VERSION
createBtn.addEventListener('click', async () => {
  const firstName = document.getElementById('firstName').value.trim();
  const lastName = document.getElementById('lastName').value.trim();
  const email = document.getElementById('userEmail').value.trim().toLowerCase();
  const phone = document.getElementById('userPhone').value.trim();
  const password = document.getElementById('userPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const role = document.getElementById('userRole').value;
  
  // Validation
  if (!firstName || !lastName) {
    showAlert('Please enter first and last name', 'error');
    return;
  }
  
  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    showAlert('Please enter a valid email address', 'error');
    return;
  }
  
  if (!phone) {
    showAlert('Please enter phone number', 'error');
    return;
  }
  
  if (!password || password.length < 6) {
    showAlert('Password must be at least 6 characters', 'error');
    return;
  }
  
  if (password !== confirmPassword) {
    showAlert('Passwords do not match', 'error');
    return;
  }
  
  try {
    // Check if user exists by email
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("email", "==", email));
    const snapshot = await getDocs(q);
    
    if (!snapshot.empty) {
      showAlert('A user with this email already exists', 'error');
      return;
    }
    
    // Create user in Firebase Authentication with YOUR password
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const uid = userCredential.user.uid;
    
    // IMPORTANT: Use setDoc with uid as document ID, not addDoc
    // This makes sure the document ID matches the Firebase Auth UID
    await setDoc(doc(db, "users", uid), {
      uid: uid,
      firstName: firstName,
      lastName: lastName,
      fullName: `${firstName} ${lastName}`,
      email: email,
      phone: phone,
      role: role,
      approved: role === 'admin',
      disabled: false,
      accountType: role === 'admin' ? 'admin' : 'sales',
      createdAt: serverTimestamp()
    });
    
    // Success!
    showAlert(`User account created successfully! User can login with email: ${email} and the password you set.`, 'success');
    
    // Clear form
    resetForm();
    
    // Close modal
    userModal.classList.remove('show');
    
    // Refresh user list
    loadUsers();
    
  } catch (error) {
    console.error('Error creating user:', error);
    let message = 'Error creating account: ';
    
    if (error.code === 'auth/email-already-in-use') {
      message = 'This email is already registered in Firebase Authentication';
    } else if (error.code === 'auth/invalid-email') {
      message = 'Invalid email address';
    } else if (error.code === 'auth/weak-password') {
      message = 'Password is too weak. Use at least 6 characters';
    } else {
      message += error.message;
    }
    
    showAlert(message, 'error');
  }
});

// Search functionality
searchInput.addEventListener('input', (e) => {
  // Simple search - will filter in loadUsers function if needed
  const searchTerm = e.target.value.toLowerCase();
  // For now just reload all users
  // You can add filtering here if needed
});

// Refresh
refreshBtn.addEventListener('click', () => {
  loadUsers();
  showAlert('User list refreshed', 'success');
});

// Check if user is admin
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  
  // Simple admin check
  const adminEmails = ['chrischishe@gmail.com', 'admin@gmail.com'];
  if (!adminEmails.includes(user.email.toLowerCase())) {
    alert('Access denied. Admin only.');
    window.location.href = 'sales.html';
    return;
  }
  
  // Load users
  loadUsers();
});

// Close modal when clicking outside
window.addEventListener('click', (event) => {
  if (event.target === userModal) {
    userModal.classList.remove('show');
  }
});

// Enter key to create user
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && userModal.classList.contains('show')) {
    createBtn.click();
  }
});
</script>

</body>
</html>