<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cash Flow Account</title>
<style>
  body { font-family: Arial, sans-serif; background: #1e1e2f; color: #fff; margin: 0; padding: 20px; }
  h2 { text-align: center; color: #ffcc00; margin-bottom: 15px; font-size: 1.5rem; }
  .buttons { text-align: center; margin-bottom: 15px; }
  input, select { padding: 8px; margin: 5px; border-radius: 6px; border: none; width: 200px; background: #2c2c44; color: #fff; font-size: 0.9rem; }
  button { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; background: #ffcc00; color: #1e1e2f; margin: 5px; font-weight: 600; font-size: 0.9rem; }
  button:hover { background: #e6b800; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
  th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
  th { color: #ffcc00; font-weight: 600; }
  tbody tr:nth-child(even) { background: #2c2c44; }
  tbody tr:nth-child(odd) { background: #1f1f33; }
  .form-container { display: none; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px; }

  /* Responsive table */
  @media(max-width:768px){
    input, select, button { width: 90%; max-width: 250px; font-size: 0.85rem; }
    table, thead, tbody, th, td, tr { display: block; }
    th { display: none; }
    td { text-align: right; padding-left: 50%; position: relative; }
    td::before { content: attr(data-label); position: absolute; left: 15px; font-weight: 600; color: #ffcc00; text-transform: capitalize; }
  }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
  authDomain: "trismart-online-app.firebaseapp.com",
  projectId: "trismart-online-app",
  storageBucket: "trismart-online-app.firebasestorage.app",
  messagingSenderId: "867677912389",
  appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
  measurementId: "G-KEWDREKNDB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let currentUserUID;
let cashflow = [];

onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "index.html"; return; }
  currentUserUID = user.uid;
  listenCashflow();
});

function listenCashflow() {
  const cashRef = collection(db, "users", currentUserUID, "cashflow");
  const q = query(cashRef, orderBy("date", "asc"));
  onSnapshot(q, snapshot => {
    cashflow = [];
    snapshot.forEach(docSnap => cashflow.push({ id: docSnap.id, ...docSnap.data() }));
    renderTable();
  });
}

function renderTable() {
  const tbody = document.querySelector('#cashflowTable tbody');
  tbody.innerHTML = '';
  let balance = 0;
  if(cashflow.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No entries yet</td></tr>';
    return;
  }
  cashflow.forEach(entry => {
    balance += entry.type === 'Inflow' ? entry.amount : -entry.amount;
    const row = document.createElement('tr');
    row.innerHTML = `
      <td data-label="Date">${new Date(entry.date).toLocaleDateString()}</td>
      <td data-label="Description">${entry.description}</td>
      <td data-label="Type">${entry.type}</td>
      <td data-label="Amount">${entry.amount.toFixed(2)}</td>
      <td data-label="Balance">${balance.toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });
}

function toggleForm() {
  const form = document.querySelector('.form-container');
  form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
}

async function addEntry(event) {
  event.preventDefault();
  const date = document.getElementById('entryDate').value;
  const description = document.getElementById('description').value.trim();
  const type = document.getElementById('type').value;
  const amount = parseFloat(document.getElementById('amount').value);

  if (!date || !description || isNaN(amount)) return alert("Fill all fields correctly!");
  await addDoc(collection(db, "users", currentUserUID, "cashflow"), { date, description, type, amount });
  document.getElementById('cashflowForm').reset();
  toggleForm();
}

window.toggleForm = toggleForm;
window.addEntry = addEntry;
</script>
</head>
<body>
<h2>Cash Flow Account</h2>
<div class="buttons">
  <button onclick="toggleForm()">Add Entry</button>
</div>
<div class="form-container">
  <form id="cashflowForm" onsubmit="addEntry(event)">
    <input type="date" id="entryDate" required>
    <input type="text" id="description" placeholder="Description" required>
    <select id="type" required>
      <option value="Inflow">Inflow</option>
      <option value="Outflow">Outflow</option>
    </select>
    <input type="number" id="amount" step="0.01" placeholder="Amount" required>
    <button type="submit">Add Entry</button>
  </form>
</div>
<table id="cashflowTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Type</th>
      <th>Amount</th>
      <th>Balance</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="5" style="text-align:center;">No entries yet</td></tr>
  </tbody>
</table>
</body>
</html>
