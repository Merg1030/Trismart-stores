<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cash Flow Account</title>
<style>
  body { font-family: Arial, sans-serif; background: #1e1e2f; color: #fff; margin: 0; padding: 15px; }
  h2 { text-align: center; color: #ffcc00; margin-bottom: 15px; font-size: 1.4rem; }
  .buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  input, select { padding: 8px; border-radius: 6px; border: none; margin: 5px; width: 150px; background: #2c2c44; color: #fff; font-size: 0.85rem; }
  button { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; background: #ffcc00; color: #1e1e2f; font-weight: 600; font-size: 0.85rem; margin: 5px; }
  button:hover { background: #e6b800; }
  button:disabled { background: #666; color: #999; cursor: not-allowed; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.8rem; }
  th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
  th { color: #ffcc00; font-weight: 600; }
  tbody tr:nth-child(even) { background: #2c2c44; }
  tbody tr:nth-child(odd) { background: #1f1f33; }
  .form-container { display: none; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 15px; }
  .inflow { color: #4caf50; }
  .outflow { color: #f44336; }
  .total-balance { text-align: center; margin-top: 15px; font-weight: bold; color: #ffcc00; font-size: 1rem; }
  
  /* Responsive table for mobile */
  @media(max-width:768px){
    input, select, button { width: 90%; max-width: 250px; }
    table { width: 100%; font-size: 0.75rem; }
    th, td { padding: 6px 4px; }
    
    /* Make table fit screen */
    table { 
      display: block;
      overflow-x: auto;
    }
    
    th:nth-child(1), td:nth-child(1) { width: 20%; } /* Date */
    th:nth-child(2), td:nth-child(2) { width: 25%; } /* Description */
    th:nth-child(3), td:nth-child(3) { width: 15%; } /* Type */
    th:nth-child(4), td:nth-child(4) { width: 20%; } /* Amount */
    th:nth-child(5), td:nth-child(5) { width: 20%; } /* Balance */
    
    th, td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
  authDomain: "trismart-online-app.firebaseapp.com",
  projectId: "trismart-online-app",
  storageBucket: "trismart-online-app.firebasestorage.app",
  messagingSenderId: "867677912389",
  appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
  measurementId: "G-KEWDREKNDB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
let currentUserUID;
let cashflow = [];
let isProcessing = false;

onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "index.html"; return; }
  currentUserUID = user.uid;
  listenCashflow();
});

function listenCashflow() {
  const cashRef = collection(db, "users", currentUserUID, "cashflow");
  const q = query(cashRef, orderBy("date", "desc"));
  onSnapshot(q, snapshot => {
    cashflow = [];
    snapshot.forEach(docSnap => cashflow.push({ id: docSnap.id, ...docSnap.data() }));
    renderTable();
  });
}

function renderTable() {
  const tbody = document.querySelector('#cashflowTable tbody');
  const totalBalance = document.querySelector('.total-balance');
  tbody.innerHTML = '';
  let balance = 0;
  
  if(cashflow.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No entries yet</td></tr>';
    totalBalance.textContent = "Current Balance: ZMW 0.00";
    return;
  }
  
  cashflow.forEach(entry => {
    balance += entry.type === 'Inflow' ? entry.amount : -entry.amount;
    const row = document.createElement('tr');
    
    row.innerHTML = `
      <td>${new Date(entry.date).toLocaleDateString()}</td>
      <td>${entry.description}</td>
      <td class="${entry.type.toLowerCase()}">${entry.type}</td>
      <td>ZMW ${entry.amount.toFixed(2)}</td>
      <td>ZMW ${balance.toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });
  
  totalBalance.textContent = `Current Balance: ZMW ${balance.toFixed(2)}`;
}

function toggleForm() {
  const form = document.querySelector('.form-container');
  form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
  
  const toggleBtn = document.querySelector('.buttons button:first-child');
  toggleBtn.textContent = form.style.display === 'flex' ? 'Hide Form' : 'Add Entry';
}

async function addEntry(event) {
  event.preventDefault();
  
  if (isProcessing) {
    alert("Please wait, processing your request...");
    return;
  }
  
  const date = document.getElementById('entryDate').value;
  const description = document.getElementById('description').value.trim();
  const type = document.getElementById('type').value;
  const amount = parseFloat(document.getElementById('amount').value);

  if (!date || !description || isNaN(amount) || amount <= 0) 
    return alert("Fill all fields correctly!");

  isProcessing = true;
  const addButton = document.querySelector('#cashflowForm button[type="submit"]');
  const originalText = addButton.textContent;
  addButton.textContent = "Processing...";
  addButton.disabled = true;

  try {
    await addDoc(collection(db, "users", currentUserUID, "cashflow"), { date, description, type, amount });
    document.getElementById('cashflowForm').reset();
    toggleForm();
    alert("Entry added successfully!");
  } catch (error) {
    console.error("Error adding entry:", error);
    alert("Error adding entry. Please try again.");
  } finally {
    isProcessing = false;
    addButton.textContent = originalText;
    addButton.disabled = false;
  }
}

// Set today's date as default
function setTodayDate() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('entryDate').value = today;
}

window.toggleForm = toggleForm;
window.addEntry = addEntry;
window.onload = setTodayDate;

     // -------------------------------
  // 1️⃣ Redirect after 15 minutes of inactivity
  // -------------------------------
  let inactivityTime = function () {
    let timer;
    const maxInactivity = 15 * 60 * 1000; // 15 minutes in milliseconds

    function resetTimer() {
      clearTimeout(timer);
      timer = setTimeout(() => {
       
        window.location.href = "index.html";
      }, maxInactivity);
    }

    // Listen to user events
    window.onload = resetTimer;
    document.onmousemove = resetTimer;
    document.onkeydown = resetTimer;
    document.onclick = resetTimer;
    document.onscroll = resetTimer;
  };

  inactivityTime();

  // -------------------------------
  // 2️⃣ Disable right-click
  // -------------------------------
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    
  });

  // -------------------------------
  // 3️⃣ Disable Ctrl+C, Ctrl+X, Ctrl+V
  // -------------------------------
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && (e.key === 'c' || e.key === 'x' || e.key === 'v')) {
      e.preventDefault();
      
    }
  });
</script>
</head>
<body>
<h2>Cash Flow Account</h2>

<div class="buttons">
  <button onclick="toggleForm()">Add Entry</button>
  <button onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
</div>

<div class="form-container">
  <form id="cashflowForm" onsubmit="addEntry(event)">
    <input type="date" id="entryDate" required>
    <input type="text" id="description" placeholder="Description" required>
    <select id="type" required>
      <option value="Inflow">Inflow</option>
      <option value="Outflow">Outflow</option>
    </select>
    <input type="number" id="amount" step="0.01" placeholder="Amount" min="0.01" required>
    <button type="submit">Add Entry</button>
  </form>
</div>

<table id="cashflowTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Type</th>
      <th>Amount</th>
      <th>Balance</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="5" style="text-align:center;">No entries yet</td></tr>
  </tbody>
</table>

<div class="total-balance">Current Balance: ZMW 0.00</div>
</body>
</html>

