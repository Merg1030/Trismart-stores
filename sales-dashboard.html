<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trismart — Sales Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#0f1220;
      --panel:#191b2a;
      --accent:#ffcc00;
      --muted:#b8b8cc;
      --card:#27293d;
      --radius:12px;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--bg) 0%, #23263b 100%);
      color:#fff;
      display:flex;
    }

    .sidebar{
      width:260px;
      background:linear-gradient(180deg,var(--panel), #151622);
      padding:22px;
      display:flex;
      flex-direction:column;
      gap:18px;
      border-right:1px solid rgba(255,255,255,0.04);
      min-height:100vh;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      color:var(--accent);
      font-weight:700;
      font-size:1.25rem;
    }
    .brand i{font-size:1.6rem}

    nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav-link{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px 12px;
      border-radius:10px;
      color:var(--muted);
      text-decoration:none;
      transition:all .18s ease;
      font-weight:600;
    }
    .nav-link:hover{background:var(--glass); color:#fff; transform:translateX(6px)}
    .nav-link.active{background:rgba(255,204,0,0.12); color:var(--accent)}

    .main {
      flex:1;
      padding:26px;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:18px;
    }
    .header .title{font-size:1.35rem;font-weight:700}
    .header .actions{display:flex;gap:8px;align-items:center}

    .card-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:12px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
      padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
    }
    .card h3{margin:0 0 8px 0;font-size:0.95rem;color:var(--muted)}
    .card .value{font-size:1.6rem;font-weight:700;color:var(--accent)}
    .card .muted{color:var(--muted);margin-top:6px;font-size:0.9rem}

    .link-row{margin-top:18px;display:flex;gap:8px;flex-wrap:wrap}

    .btn{
      padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
      background:var(--accent); color:#111;
    }
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--muted)}

    .hidden{display:none !important}

    @media (max-width:840px){
      .sidebar{display:none}
      body{flex-direction:column}
      .main{padding:16px}
    }
  </style>
</head>
<body>
  <aside class="sidebar" aria-label="Sidebar navigation">
    <div class="brand"><i class="fas fa-chart-line"></i><span>Trismart</span></div>

    <div id="profileBox" style="margin-top:6px">
      <div style="font-weight:700" id="fullName">—</div>
      <div style="color:var(--muted);font-size:0.95rem" id="email">—</div>
    </div>

    <nav aria-label="Main navigation" id="mainNav">
      <a class="nav-link active" id="navDashboard" href="sales-dashboard.html"><i class="fas fa-house"></i><span>Dashboard</span></a>
      <a class="nav-link" id="navCommission" href="commission.html"><i class="fas fa-wallet"></i><span>Commission</span></a>
      <a class="nav-link" id="navSales" href="sales.html"><i class="fas fa-hand-holding-dollar"></i><span>Sales</span></a>
      <a class="nav-link" id="navAvailable" href="available-stock.html"><i class="fas fa-boxes"></i><span>Available Stock in HQ</span></a>
      <a class="nav-link" id="navAssigned" href="assigned-stock.html"><i class="fas fa-dolly"></i><span>Assigned Stock</span></a>
      <a class="nav-link" id="navCustomers" href="customers.html"><i class="fas fa-users"></i><span>Customers</span></a>

      <!-- Users link present in markup but will be removed for non-admins at runtime -->
      <a class="nav-link" id="navUsers" href="users.html"><i class="fas fa-user-shield"></i><span>Users</span></a>
       <a class="nav-link" id="navUsers" href="Analysis.html"><i class="fas fa-user-shield"></i><span>Analysis</span></a>
    </nav>

    <div style="margin-top:auto;display:flex;flex-direction:column;gap:8px">
      <button class="btn" id="btnCreateLead"><i class="fas fa-plus"></i> New Lead</button>
      <button class="ghost" id="btnSignOut" style="margin-top:6px"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
    </div>
  </aside>

  <main class="main" role="main" aria-labelledby="dashboardTitle">
    <header class="header">
      <div>
        <div class="title" id="dashboardTitle">Sales Dashboard</div>
        <div style="color:var(--muted);margin-top:6px" id="welcomeText">Quick overview of your sales activity</div>
      </div>

      <div class="actions">
        <div style="text-align:right">
          <div id="roleBadge" style="font-weight:700;color:var(--muted)">—</div>
        </div>
      </div>
    </header>

    <section class="card-row" aria-label="Overview cards">
      <article class="card">
        <h3>Commission</h3>
        <div class="value" id="commissionVal">—</div>
        <div class="muted">Total commission earned (placeholder)</div>
      </article>

      <article class="card">
        <h3>Sales</h3>
        <div class="value" id="salesVal">—</div>
        <div class="muted">Total sales today</div>
      </article>

      <article class="card admin-only">
        <h3>Available Stock in HQ</h3>
        <div class="value" id="availableVal">—</div>
        <div class="muted">HQ inventory snapshot</div>
      </article>

      <article class="card">
        <h3>Assigned Stock</h3>
        <div class="value" id="assignedVal">—</div>
        <div class="muted">Stock assigned to you</div>
      </article>

      <article class="card">
        <h3>Customers</h3>
        <div class="value" id="customersVal">—</div>
        <div class="muted">Total customers visible to you</div>
      </article>

      <article class="card admin-only">
        <h3>Pending Approvals</h3>
        <div class="value" id="pendingUsersVal">0</div>
        <div class="muted">Users awaiting approval</div>
        <div style="margin-top:10px">
          <a class="ghost" href="users.html" id="manageUsersLink">Manage Users</a>
        </div>
      </article>
    </section>

    <div class="link-row" id="linkRow">
      <a class="ghost" href="commission.html">Open Commission</a>
      <a class="ghost" href="sales.html">Open Sales</a>
      <a class="ghost" href="available-stock.html">HQ Stock</a>
      <a class="ghost" href="assigned-stock.html">Assigned Stock</a>
      <a class="ghost" href="customers.html">Customers</a>
      <a class="ghost" href="users.html" id="usersLinkFooter">Users</a>
    </div>

    <section style="margin-top:20px">
      <h3>Notes</h3>
      
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Your Firebase config (same as other pages)
    const firebaseConfig = {
      apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
      authDomain: "trismart-online-app.firebaseapp.com",
      projectId: "trismart-online-app",
      storageBucket: "trismart-online-app.firebasestorage.app",
      messagingSenderId: "867677912389",
      appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
      measurementId: "G-KEWDREKNDB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const fullNameEl = document.getElementById('fullName');
    const emailEl = document.getElementById('email');
    const roleBadge = document.getElementById('roleBadge');
    const customersVal = document.getElementById('customersVal');
    const availableVal = document.getElementById('availableVal');
    const assignedVal = document.getElementById('assignedVal');
    const salesVal = document.getElementById('salesVal');
    const commissionVal = document.getElementById('commissionVal');
    const pendingUsersVal = document.getElementById('pendingUsersVal');

    const adminOnlyEls = document.querySelectorAll('.admin-only');
    const navUsers = document.getElementById('navUsers');
    const usersLinkFooter = document.getElementById('usersLinkFooter');
    const manageUsersLink = document.getElementById('manageUsersLink');

    const btnSignOut = document.getElementById('btnSignOut');

    // Only this email is admin
    const ADMIN_EMAIL = 'chrischishe@gmail.com';

    // Utility to hide admin UI for non-admins
    function applyAdminUI(isAdmin) {
      adminOnlyEls.forEach(el => {
        if (isAdmin) el.classList.remove('hidden');
        else el.classList.add('hidden');
      });

      // Users nav link: remove entirely for non-admins to reduce exposure
      if (isAdmin) {
        if (navUsers) navUsers.classList.remove('hidden');
        if (usersLinkFooter) usersLinkFooter.classList.remove('hidden');
      } else {
        if (navUsers) navUsers.remove();
        if (usersLinkFooter) usersLinkFooter.remove();
        if (manageUsersLink) manageUsersLink.remove();
      }
    }

    // Prevent direct clicks to users.html from this page if user is not admin
    function protectUsersNavigation(isAdmin) {
      // intercept any link clicks that point to users.html
      document.querySelectorAll('a[href$="users.html"]').forEach(a => {
        a.addEventListener('click', (e) => {
          if (!isAdmin) {
            e.preventDefault();
            alert('Not authorized');
          }
        });
      });
    }

    btnSignOut.addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (err) {
        console.error('Sign out error', err);
        alert('Sign out failed');
      }
    });

    // Auth guard + load counts with role-sensitive queries
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      const email = (user.email || '').toLowerCase();
      const isAdmin = email === ADMIN_EMAIL.toLowerCase();

      // Basic profile UI
      fullNameEl.textContent = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
      emailEl.textContent = user.email;
      roleBadge.textContent = isAdmin ? 'ADMIN' : 'SALES';

      // Show or hide admin-only UI
      applyAdminUI(isAdmin);
      protectUsersNavigation(isAdmin);

      // Load counts and placeholders
      try {
        // Customers count (admin sees all)
        let customersQuery;
        if (isAdmin) {
          customersQuery = query(collection(db, 'customers'), orderBy('createdAt','desc'));
        } else {
          customersQuery = query(collection(db, 'customers'), where('createdBy','==', user.uid));
        }
        const custSnap = await getDocs(customersQuery);
        customersVal.textContent = custSnap.size;

        // Pending users count (admin only) or user approval status
        if (isAdmin) {
          const pendingQ = query(collection(db, 'users'), where('approved', '==', false));
          const pendingSnap = await getDocs(pendingQ);
          pendingUsersVal.textContent = pendingSnap.size;
        } else {
          // show own approval status if available
          try {
            const userDocRef = collection(db, 'users');
            // try to get their Firestore user doc by querying uid (safer than assuming existence)
            const userQuery = query(collection(db, 'users'), where('uid','==', user.uid));
            const userSnap = await getDocs(userQuery);
            if (!userSnap.empty) {
              const docData = userSnap.docs[0].data();
              pendingUsersVal.textContent = docData.approved ? 'Approved' : 'Pending';
            } else {
              pendingUsersVal.textContent = 'Unknown';
            }
          } catch (e) {
            pendingUsersVal.textContent = '—';
          }
        }

        // Placeholder summary values (can be wired to actual fields later)
        salesVal.textContent = '—';
        commissionVal.textContent = '—';
        assignedVal.textContent = '—';
        availableVal.textContent = isAdmin ? '—' : '—';
      } catch (err) {
        console.error('Error loading dashboard counts:', err);
      }
    });
  </script>
</body>
</html>