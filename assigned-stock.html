<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Warehouse</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: #0f1220;
      color:#fff;
      min-height:100vh;
      padding:20px;
    }
    
    .table-wrap{
      width:100%;
      overflow:auto;
      max-height:calc(100vh - 40px);
    }
    
    table{
      width:100%;
      border-collapse:collapse;
    }
    
    th{
      background:#191b2a;
      padding:12px;
      text-align:left;
      color:#b8b8cc;
      border-bottom:2px solid #27293d;
      position:sticky;
      top:0;
    }
    
    td{
      padding:12px;
      border-bottom:1px solid #27293d;
    }
    
    tr:hover{
      background:rgba(255,255,255,0.02);
    }
    
    .empty{
      text-align:center;
      padding:40px;
      color:#b8b8cc;
    }
    
    .stock-low{
      color:#f44336;
      font-weight:bold;
    }
    
    .stock-ok{
      color:#4caf50;
    }
    
    .price{
      color:#ffcc00;
    }
    
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
      padding-bottom:10px;
      border-bottom:1px solid #27293d;
    }
    
    .user-info{
      color:#b8b8cc;
      font-size:14px;
    }
    
    .logout-btn{
      background:#f44336;
      color:white;
      border:none;
      padding:8px 16px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1 style="margin:0;font-size:24px">My Warehouse</h1>
      <div class="user-info" id="userEmail">Loading...</div>
    </div>
    <button class="logout-btn" id="btnLogout">Logout</button>
  </div>
  
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Product Code</th>
          <th>Product Name</th>
          <th>Price</th>
          <th>Stock</th>
        </tr>
      </thead>
      <tbody id="productsBody">
        <tr><td colspan="4" class="empty">Loading products...</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      onSnapshot,
      orderBy,
      getDocs,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
      authDomain: "trismart-online-app.firebaseapp.com",
      projectId: "trismart-online-app",
      storageBucket: "trismart-online-app.firebasestorage.app",
      messagingSenderId: "867677912389",
      appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
      measurementId: "G-KEWDREKNDB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let productsUnsubscribe = null;

    // Elements
    const userEmailEl = document.getElementById('userEmail');
    const btnLogout = document.getElementById('btnLogout');
    const productsBody = document.getElementById('productsBody');

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = user;
      userEmailEl.textContent = user.email;
      loadUserWarehouse();
    });

    async function loadUserWarehouse() {
      if (productsUnsubscribe) {
        productsUnsubscribe();
      }

      const userEmail = currentUser.email;
      
      try {
        // Try to load from userWarehouse collection first (most accurate)
        const userWarehouseQuery = query(
          collection(db, 'userWarehouse'),
          where('userEmail', '==', userEmail)
        );
        
        productsUnsubscribe = onSnapshot(userWarehouseQuery, async (snapshot) => {
          if (!snapshot.empty) {
            // We have products in userWarehouse
            const products = [];
            
            for (const docSnap of snapshot.docs) {
              const data = docSnap.data();
              
              // Get product details from products collection
              let productDetails = {};
              try {
                const productRef = doc(db, 'products', data.productId);
                const productSnap = await getDoc(productRef);
                if (productSnap.exists()) {
                  productDetails = productSnap.data();
                }
              } catch (err) {
                console.log('Could not fetch product details:', err);
              }
              
              products.push({
                id: docSnap.id,
                code: data.productCode || productDetails.code || 'N/A',
                name: data.productName || productDetails.name || 'N/A',
                price: data.price || productDetails.price || 0,
                stock: data.warehouseStock || 0,
                lastUpdated: data.lastUpdated
              });
            }
            
            // Sort by product code
            products.sort((a, b) => (a.code || '').localeCompare(b.code || ''));
            renderProducts(products);
            
          } else {
            // No products in userWarehouse yet, check transfers
            await loadFromTransfers();
          }
        }, (error) => {
          console.log('userWarehouse collection error, checking transfers...');
          loadFromTransfers();
        });
        
      } catch (error) {
        console.error('Error loading warehouse:', error);
        loadFromTransfers();
      }
    }

    async function loadFromTransfers() {
      const userEmail = currentUser.email;
      
      try {
        const transfersQuery = query(
          collection(db, 'transfers'),
          where('toUserEmail', '==', userEmail),
          orderBy('createdAt', 'desc')
        );
        
        const transfersSnapshot = await getDocs(transfersQuery);
        
        if (transfersSnapshot.empty) {
          productsBody.innerHTML = '<tr><td colspan="4" class="empty">No products in your warehouse yet</td></tr>';
          return;
        }
        
        // Group transfers by product
        const productMap = new Map();
        
        for (const docSnap of transfersSnapshot.docs) {
          const transfer = docSnap.data();
          const productId = transfer.productId;
          
          if (!productMap.has(productId)) {
            // Get product details
            let productDetails = {};
            try {
              const productRef = doc(db, 'products', productId);
              const productSnap = await getDoc(productRef);
              if (productSnap.exists()) {
                productDetails = productSnap.data();
              }
            } catch (err) {
              console.log('Could not fetch product details:', err);
            }
            
            productMap.set(productId, {
              code: transfer.productCode || productDetails.code || 'N/A',
              name: transfer.productName || productDetails.name || 'N/A',
              price: transfer.price || productDetails.price || 0,
              stock: 0
            });
          }
          
          // Add transfer quantity to stock
          const product = productMap.get(productId);
          product.stock += transfer.quantity || 0;
        }
        
        // Convert map to array and sort
        const products = Array.from(productMap.values());
        products.sort((a, b) => (a.code || '').localeCompare(b.code || ''));
        
        renderProducts(products);
        
      } catch (error) {
        console.error('Error loading transfers:', error);
        productsBody.innerHTML = '<tr><td colspan="4" class="empty">Error loading warehouse data</td></tr>';
      }
    }

    function renderProducts(products) {
      if (products.length === 0) {
        productsBody.innerHTML = '<tr><td colspan="4" class="empty">No products in your warehouse</td></tr>';
        return;
      }
      
      productsBody.innerHTML = products.map(product => `
        <tr>
          <td><strong>${product.code || ''}</strong></td>
          <td>${product.name || ''}</td>
          <td class="price">$${(product.price || 0).toFixed(2)}</td>
          <td class="${(product.stock || 0) <= 10 ? 'stock-low' : 'stock-ok'}">
            ${product.stock || 0}
          </td>
        </tr>
      `).join('');
    }

    // Logout
    btnLogout.addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout error:', error);
        alert('Logout failed');
      }
    });

    // Auto refresh every 30 seconds to get latest transfers
    setInterval(() => {
      if (currentUser) {
        loadUserWarehouse();
      }
    }, 30000);

    // Auto logout after 15 minutes of inactivity
    let logoutTimer;
    function resetLogoutTimer() {
      clearTimeout(logoutTimer);
      logoutTimer = setTimeout(() => {
        signOut(auth);
        window.location.href = 'index.html';
      }, 15 * 60 * 1000); // 15 minutes
    }

    // Reset timer on user activity
    document.addEventListener('mousemove', resetLogoutTimer);
    document.addEventListener('keypress', resetLogoutTimer);
    resetLogoutTimer();

  </script>
</body>
</html>