<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trismart — Customers</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#0f1220;
      --panel:#191b2a;
      --accent:#ffcc00;
      --muted:#b8b8cc;
      --card:#27293d;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--bg) 0%, #23263b 100%);
      color:#fff;
      padding:24px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    .container{
      width:100%;
      max-width:1100px;
      background:var(--panel);
      border-radius:var(--radius);
      padding:18px;
      border:1px solid rgba(255,255,255,0.04);
      position:relative;
    }

    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    h1{margin:0;font-size:1.2rem}
    .small{color:var(--muted);font-size:0.95rem}

    /* layout: left = form, right = list
       When .form-hidden is active on .layout the grid becomes single column (form removed)
    */
    .layout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
      margin-top:16px;
      align-items:start;
      transition: grid-template-columns 220ms ease;
    }
    .layout.form-hidden{
      grid-template-columns: 1fr;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.03);
    }

    /* hide form panel when collapsed */
    aside.panel.form-hidden{
      display:none;
    }

    /* floating quick-add button shown when form is hidden */
    #quickAddBtn{
      display:none;
      position:fixed;
      right:28px;
      bottom:28px;
      width:56px;
      height:56px;
      border-radius:50%;
      background:var(--accent);
      color:#111;
      border:none;
      font-size:20px;
      box-shadow:0 6px 18px rgba(0,0,0,0.4);
      cursor:pointer;
      align-items:center;
      justify-content:center;
      z-index:80;
    }
    #quickAddBtn.show{ display:flex; }

    /* top controls (toggle form button) */
    .controls{ display:flex; gap:8px; align-items:center; }

    label{display:block;margin-top:8px;color:var(--muted);font-size:0.9rem}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;margin-top:6px}
    input[type="tel"]{-webkit-appearance:textfield}
    .row{display:flex;gap:8px}
    .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:var(--accent);color:#111}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn.danger{background:#f44336;color:#fff}
    .btn.view{background:#4CAF50;color:#fff}
    .btn.disabled{opacity:0.5;cursor:not-allowed;}
    .btn.small{padding:8px 10px;font-size:0.9rem;border-radius:8px}
    .toggleBtn{ background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04); padding:8px 10px; border-radius:8px; cursor:pointer }

    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03)}
    th{color:var(--muted);font-size:0.85rem}
    .actions button{margin-right:8px}
    .searchRow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .smallMuted{color:var(--muted);font-size:0.95rem}
    .hidden{display:none !important}
    .error{color:#ff6b6b;padding:8px;background:rgba(255,107,107,0.1);border-radius:8px;margin:8px 0;}
    .success{color:#4CAF50;padding:8px;background:rgba(76,175,80,0.1);border-radius:8px;margin:8px 0;}
    @media (max-width:980px){
      .layout{grid-template-columns:1fr; }
      /* on small screens show quickAdd as well */
      #quickAddBtn{ right:18px; bottom:18px; }
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-labelledby="customersTitle">
    <div class="top">
      <div style="display:flex;gap:12px;align-items:center">
        <a href="sales-dashboard.html" title="Back" style="color:var(--muted);text-decoration:none"><i class="fas fa-arrow-left"></i></a>
        <h1 id="customersTitle">Customers</h1>
        <div class="small" id="formStateLabel" style="color:var(--muted);font-size:0.85rem"></div>
      </div>

      <div style="display:flex;gap:8px;align-items:center" class="controls">
        <button id="btnToggleForm" class="toggleBtn" aria-pressed="true" title="Show or hide add customer form"><i class="fas fa-columns"></i> Toggle Form</button>
        <div id="currentUser" class="small" style="color:var(--muted)">—</div>
        <button class="btn" id="btnSignOut">Sign Out</button>
      </div>
    </div>

    <div id="mainLayout" class="layout">
      <!-- Add / Edit form -->
      <aside id="customerForm" class="panel" aria-label="Customer form">
        <h3 id="formHeading">Add Customer</h3>
        <div class="smallMuted" id="formDescription">Name, address and phone number</div>

        <label for="custName">Name</label>
        <input id="custName" placeholder="Customer full name" />

        <label for="custAddress">Address</label>
        <textarea id="custAddress" rows="3" placeholder="Street, city, ..."></textarea>

        <label for="custPhone">Phone</label>
        <input id="custPhone" placeholder="e.g. 0977123456" />

        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn" id="btnSave">Save Customer</button>
          <button class="btn ghost" id="btnCancel">Clear</button>
        </div>
      </aside>

      <!-- List -->
      <section class="panel" aria-label="Customer list">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Customers</strong>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="searchInput" placeholder="Search name, phone, address" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff" />
            <select id="filterSelect" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff">
              <option value="mine">My customers</option>
              <option value="all">All customers (admin only)</option>
            </select>
            <select id="userFilter" class="hidden" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff">
              <option value="">All users</option>
            </select>
            <button class="btn ghost" id="btnRefresh">Refresh</button>
          </div>
        </div>

        <div id="messageContainer" class="hidden"></div>

        <div style="margin-top:8px;overflow:auto;max-height:520px">
          <table aria-label="Customers table">
            <thead>
              <tr id="tableHead">
                <th>Name</th>
                <th>Address</th>
                <th>Phone</th>
                <th class="adminCol hidden">Added by</th>
                <th style="width:180px">Actions</th>
              </tr>
            </thead>
            <tbody id="customersBody">
              <tr><td colspan="5" style="color:var(--muted)">Loading customers...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Quick floating add button (shown when form is hidden) -->
    <button id="quickAddBtn" title="Open add customer form" aria-hidden="true"><i class="fas fa-plus"></i></button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      orderBy,
      onSnapshot,
      doc,
      updateDoc,
      deleteDoc,
      serverTimestamp,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
      authDomain: "trismart-online-app.firebaseapp.com",
      projectId: "trismart-online-app",
      storageBucket: "trismart-online-app.firebasestorage.app",
      messagingSenderId: "867677912389",
      appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
      measurementId: "G-KEWDREKNDB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const custName = document.getElementById('custName');
    const custAddress = document.getElementById('custAddress');
    const custPhone = document.getElementById('custPhone');
    const btnSave = document.getElementById('btnSave');
    const btnCancel = document.getElementById('btnCancel');
    const customersBody = document.getElementById('customersBody');
    const searchInput = document.getElementById('searchInput');
    const btnRefresh = document.getElementById('btnRefresh');
    const formHeading = document.getElementById('formHeading');
    const formDescription = document.getElementById('formDescription');
    const currentUserEl = document.getElementById('currentUser');
    const filterSelect = document.getElementById('filterSelect');
    const userFilter = document.getElementById('userFilter');
    const adminColEls = document.querySelectorAll('.adminCol');
    const btnSignOut = document.getElementById('btnSignOut');
    const messageContainer = document.getElementById('messageContainer');

    // New elements for form visibility
    const btnToggleForm = document.getElementById('btnToggleForm');
    const mainLayout = document.getElementById('mainLayout');
    const customerForm = document.getElementById('customerForm');
    const quickAddBtn = document.getElementById('quickAddBtn');
    const formStateLabel = document.getElementById('formStateLabel');

    let currentUser = null;
    let editingId = null;
    let customersUnsub = null;
    let customersCache = [];
    let usersCache = [];

    const ADMIN_EMAIL = 'chrischishe@gmail.com';
    const LS_KEY_FORM_VISIBLE = 'trismart.custFormVisible';

    // --- Form visibility helpers (persisted in localStorage) ---
    function isFormVisibleStored() {
      try {
        const v = localStorage.getItem(LS_KEY_FORM_VISIBLE);
        if (v === null) return true; // default visible
        return v === '1';
      } catch (e) {
        return true;
      }
    }
    function setFormVisibleStored(visible) {
      try {
        localStorage.setItem(LS_KEY_FORM_VISIBLE, visible ? '1' : '0');
      } catch (e) { /* ignore private mode */ }
    }

    function applyFormVisibility(visible, skipFocus = false) {
      if (visible) {
        mainLayout.classList.remove('form-hidden');
        customerForm.classList.remove('form-hidden');
        btnToggleForm.setAttribute('aria-pressed', 'true');
        btnToggleForm.innerHTML = '<i class="fas fa-columns"></i> Hide Form';
        quickAddBtn.classList.remove('show');
        formStateLabel.textContent = 'Form: shown';
        quickAddBtn.setAttribute('aria-hidden', 'true');
      } else {
        mainLayout.classList.add('form-hidden');
        customerForm.classList.add('form-hidden');
        btnToggleForm.setAttribute('aria-pressed', 'false');
        btnToggleForm.innerHTML = '<i class="fas fa-columns"></i> Show Form';
        quickAddBtn.classList.add('show');
        formStateLabel.textContent = 'Form: hidden';
        quickAddBtn.setAttribute('aria-hidden', 'false');
        if (!skipFocus) {
          // focus the list search so keyboard users can continue
          searchInput.focus();
        }
      }
      setFormVisibleStored(visible);
    }

    // Apply persisted preference early (on script run)
    try {
      const initialVisible = isFormVisibleStored();
      applyFormVisibility(initialVisible, true);
    } catch (err) {
      // ignore
    }

    function showMessage(message, type = 'info') {
      messageContainer.textContent = message;
      messageContainer.className = type + ' ' + (type === 'error' ? 'error' : 'success');
      messageContainer.classList.remove('hidden');
      
      if (type !== 'error') {
        setTimeout(() => {
          messageContainer.classList.add('hidden');
        }, 3000);
      }
    }

    function hideMessage() {
      messageContainer.classList.add('hidden');
      messageContainer.textContent = '';
    }

    function validatePhone(phone) {
      return /^\d{7,15}$/.test(phone.replace(/\s+/g,'')); // accept 7-15 digits
    }

    function clearForm() {
      custName.value = '';
      custAddress.value = '';
      custPhone.value = '';
      editingId = null;
      formHeading.textContent = 'Add Customer';
      formDescription.textContent = 'Name, address and phone number';
      btnSave.textContent = 'Save Customer';
      btnSave.disabled = false;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }

    async function loadUsersList() {
      try {
        usersCache = [];
        const snaps = await getDocs(query(collection(db, 'users')));
        usersCache = snaps.docs.map(d => ({ 
          id: d.id, 
          uid: d.data().uid || d.id, 
          email: d.data().email || '', 
          name: d.data().fullName || `${d.data().firstName||''} ${d.data().lastName||''}`.trim() || d.data().email || 'Unknown User'
        }));
        userFilter.innerHTML = '<option value="">All users</option>';
        usersCache.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.uid || u.id;
          opt.textContent = u.name || u.email || u.uid;
          userFilter.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading users list', err);
      }
    }

    function attachCustomersListener() {
      if (!currentUser) return;
      if (customersUnsub) customersUnsub();
      
      hideMessage();

      const isAdmin = (currentUser.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase();
      const filterMode = filterSelect.value; // 'mine' or 'all'
      const specificUserUid = userFilter.value; // when admin picks a specific user

      try {
        let q;
        if (isAdmin && filterMode === 'all') {
          // Admin viewing all customers
          if (specificUserUid) {
            // Admin filtered by specific user
            q = query(collection(db, 'customers'), 
                     where('createdBy', '==', specificUserUid));
          } else {
            // Admin viewing all customers
            q = query(collection(db, 'customers'));
          }
        } else {
          // Regular user OR admin viewing their own customers
          q = query(collection(db, 'customers'), 
                   where('createdBy', '==', currentUser.uid));
        }

        customersUnsub = onSnapshot(q, (snap) => {
          hideMessage();
          customersCache = snap.docs.map(d => ({ 
            id: d.id, 
            ...d.data(),
            createdAt: d.data().createdAt ? d.data().createdAt.toDate() : null,
            updatedAt: d.data().updatedAt ? d.data().updatedAt.toDate() : null
          }));
          
          // Sort by creation date (newest first)
          customersCache.sort((a, b) => {
            return (b.createdAt || 0) - (a.createdAt || 0);
          });
          
          renderCustomers(customersCache);
        }, (err) => {
          console.error('Firestore error:', err);
          showMessage(`Error loading customers: ${err.message}`, 'error');
          
          // Fallback loading
          loadCustomersFallback();
        });
        
      } catch (err) {
        console.error('Query setup error:', err);
        showMessage(`Setup error: ${err.message}`, 'error');
        loadCustomersFallback();
      }
    }

    async function loadCustomersFallback() {
      try {
        hideMessage();
        const querySnapshot = await getDocs(collection(db, 'customers'));
        customersCache = querySnapshot.docs.map(d => ({ 
          id: d.id, 
          ...d.data(),
          createdAt: d.data().createdAt ? d.data().createdAt.toDate() : null,
          updatedAt: d.data().updatedAt ? d.data().updatedAt.toDate() : null
        }));
        
        // Filter based on user permissions
        const isAdmin = (currentUser.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase();
        const filterMode = filterSelect.value;
        const specificUserUid = userFilter.value;
        
        if (!isAdmin || filterMode !== 'all') {
          // Show only current user's customers
          customersCache = customersCache.filter(c => c.createdBy === currentUser.uid);
        } else if (specificUserUid) {
          // Admin filtered by specific user
          customersCache = customersCache.filter(c => c.createdBy === specificUserUid);
        }
        // Admin viewing all - keep all customers
        
        customersCache.sort((a, b) => {
          return (b.createdAt || 0) - (a.createdAt || 0);
        });
        
        renderCustomers(customersCache);
      } catch (err) {
        console.error('Fallback load error:', err);
        showMessage('Failed to load customers. Please check your connection.', 'error');
      }
    }

    function renderCustomers(rows) {
      const filterText = (searchInput.value || '').trim().toLowerCase();
      const isAdmin = (currentUser && (currentUser.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase());

      const filtered = rows.filter(r => {
        if (!filterText) return true;
        return (r.name || '').toLowerCase().includes(filterText) ||
               (r.phone || '').toLowerCase().includes(filterText) ||
               (r.address || '').toLowerCase().includes(filterText);
      });

      if (filtered.length === 0) {
        const colspan = (isAdmin ? 5 : 4);
        customersBody.innerHTML = `<tr><td colspan="${colspan}" style="color:var(--muted); text-align:center; padding:20px;">
          No customers found. ${!isAdmin && rows.length === 0 ? 'Add your first customer using the form (toggle it if hidden).' : ''}
        </td></tr>`;
        return;
      }

      customersBody.innerHTML = '';
      filtered.forEach(c => {
        const tr = document.createElement('tr');
        const addedByName = c.createdByName || c.createdByEmail || c.createdBy || 'Unknown';
        const isOwner = currentUser && c.createdBy === currentUser.uid;
        
        // REGULAR USERS CAN ONLY VIEW, ADMIN CAN DO EVERYTHING
        const canEditDelete = isAdmin; // Only admin can edit/delete
        const canView = true; // Everyone can view
        
        let actionsHtml = '';
        
        if (canEditDelete) {
          // Admin actions
          actionsHtml = `
            <button class="btn ghost" data-action="edit" data-id="${c.id}" title="Edit customer">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn danger" data-action="delete" data-id="${c.id}" title="Delete customer">
              <i class="fas fa-trash"></i> Delete
            </button>
          `;
        } else if (canView) {
          // Regular user - view only
          actionsHtml = `
            <button class="btn view disabled" title="Only admin can edit">
              <i class="fas fa-eye"></i> View Only
            </button>
          `;
        }

        tr.innerHTML = `
          <td>${escapeHtml(c.name||'')}</td>
          <td style="max-width:360px">${escapeHtml(c.address||'')}</td>
          <td>${escapeHtml(c.phone||'')}</td>
          ${isAdmin ? `<td class="adminCol">${escapeHtml(addedByName)}</td>` : ''}
          <td class="actions">${actionsHtml}</td>
        `;
        customersBody.appendChild(tr);
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      currentUserEl.textContent = user.email;

      const isAdmin = (user.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase();

      // Show/hide admin columns
      adminColEls.forEach(el => {
        if (isAdmin) el.classList.remove('hidden'); 
        else el.classList.add('hidden');
      });

      // Update form description based on role
      if (isAdmin) {
        formDescription.innerHTML = 'Name, address and phone number<br><small style="color:var(--accent)">You have admin privileges</small>';
      } else {
        formDescription.innerHTML = 'Name, address and phone number<br><small style="color:#ff6b6"></small>';
      }

      // Admin specific setup
      if (isAdmin) {
        userFilter.classList.remove('hidden');
        await loadUsersList();
      } else {
        userFilter.classList.add('hidden');
        filterSelect.value = 'mine';
        // Disable "All customers" option for non-admins
        Array.from(filterSelect.options).forEach(o => { 
          if (o.value === 'all') o.disabled = true; 
        });
      }

      attachCustomersListener();
    });

    // Save / Update customer
    btnSave.addEventListener('click', async () => {
      const name = custName.value.trim();
      const address = custAddress.value.trim();
      const phone = custPhone.value.trim();

      if (!name) { alert('Name is required'); return; }
      if (!phone) { alert('Phone is required'); return; }
      if (!validatePhone(phone)) { alert('Phone must be digits (7-15 characters)'); return; }

      try {
        hideMessage();
        const isAdmin = (currentUser.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase();
        const createdByName = currentUser.displayName || currentUser.email || 'Unknown';

        if (editingId) {
          // Only admin can edit
          if (!isAdmin) {
            alert('Only admin can edit customers. Please contact Chris.');
            return;
          }
          
          const ref = doc(db, 'customers', editingId);
          await updateDoc(ref, {
            name, address, phone, updatedAt: serverTimestamp()
          });
          clearForm();
          showMessage('Customer updated successfully!', 'success');
        } else {
          // Anyone can add new customers
          await addDoc(collection(db, 'customers'), {
            name,
            address,
            phone,
            createdBy: currentUser.uid,
            createdByName: currentUser.email || createdByName,
            createdByEmail: currentUser.email,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          clearForm();
          showMessage('Customer added successfully!', 'success');
        }
      } catch (err) {
        console.error('Save customer error', err);
        showMessage(`Error: ${err.message}`, 'error');
      }
    });

    btnCancel.addEventListener('click', clearForm);

    customersBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      if (!action || !id) return;

      try {
        const isAdmin = (currentUser.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase();
        
        // Regular users cannot edit or delete
        if (!isAdmin) {
          alert('Only admin Chris can edit or delete customers. Please contact Chris for changes.');
          return;
        }

        if (action === 'edit') {
          // Find customer in cache
          const customer = customersCache.find(c => c.id === id);
          if (!customer) return;
          
          custName.value = customer.name || '';
          custAddress.value = customer.address || '';
          custPhone.value = customer.phone || '';
          editingId = id;
          formHeading.textContent = 'Edit Customer';
          formDescription.innerHTML = 'Editing customer<br><small style="color:var(--accent)">Admin Edit Mode</small>';
          btnSave.textContent = 'Update Customer';
          // Ensure form visible when editing
          applyFormVisibility(true);
          window.scrollTo({ top: 0, behavior: 'smooth' });
          
        } else if (action === 'delete') {
          // Find customer in cache
          const customer = customersCache.find(c => c.id === id);
          if (!customer) return;
          
          const userName = customer.createdByName || customer.createdByEmail || 'Unknown User';
          if (!confirm(`Are you sure you want to delete this customer added by ${userName}?\n\nCustomer: ${customer.name}\nThis action cannot be undone.`)) return;
          
          const ref = doc(db, 'customers', id);
          await deleteDoc(ref);
          showMessage('Customer deleted successfully!', 'success');
        }
      } catch (err) {
        console.error('Customer action error', err);
        showMessage(`Error: ${err.message}`, 'error');
      }
    });

    btnRefresh.addEventListener('click', () => {
      attachCustomersListener();
      if (currentUser && (currentUser.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
        loadUsersList();
      }
    });
    
    searchInput.addEventListener('input', () => renderCustomers(customersCache));
    
    filterSelect.addEventListener('change', () => {
      const isAdmin = (currentUser && (currentUser.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase());
      if (!isAdmin && filterSelect.value === 'all') {
        filterSelect.value = 'mine';
        alert('Only admin Chris can view all customers.');
        return;
      }
      attachCustomersListener();
    });
    
    userFilter.addEventListener('change', () => {
      attachCustomersListener();
    });

    btnSignOut.addEventListener('click', async () => {
      try { 
        await signOut(auth); 
        window.location.href = "index.html"; 
      } catch (e) { 
        console.error(e); 
        alert('Sign out failed'); 
      }
    });

    // --- Handlers for toggling form visibility ---
    btnToggleForm.addEventListener('click', () => {
      const currentlyVisible = !mainLayout.classList.contains('form-hidden');
      applyFormVisibility(!currentlyVisible);
    });

    // Quick floating add button: opens form and focuses name field
    quickAddBtn.addEventListener('click', () => {
      applyFormVisibility(true);
      setTimeout(() => {
        custName.focus();
      }, 80);
    });

    // keyboard shortcut: "f" toggles form (when not focused on input)
    window.addEventListener('keydown', (e) => {
      const tag = document.activeElement && document.activeElement.tagName;
      if (e.key === 'f' && tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'SELECT') {
        e.preventDefault();
        const currentlyVisible = !mainLayout.classList.contains('form-hidden');
        applyFormVisibility(!currentlyVisible);
      }
    });

    window.addEventListener('beforeunload', () => { 
      if (customersUnsub) customersUnsub(); 
    });
  </script>
</body>
</html>