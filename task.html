<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Task Material & Employee Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7fafd;
      margin: 0;
      padding: 0;
    }

    .panel {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(44,62,80,0.06);
      margin: 40px auto;
      padding: 30px;
      max-width: 1800px;
    }

    .panel-heading {
      background: #1976d2;
      color: #fff;
      padding: 18px 24px;
      font-size: 1.25rem;
      font-weight: bold;
      border-radius: 8px 8px 0 0;
      margin: -30px -30px 24px -30px;
      letter-spacing: 0.08em;
    }

    .filter-bar {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      background: #f8fafc;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }

    label { 
      font-weight: 600; 
      margin-right: 7px; 
      color: #2d3748;
      font-size: 0.9rem;
    }

    input[type="text"], select {
      padding: 6px 14px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #aaa;
    }

    button {
      padding: 7px 18px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover { background: #125195; }
    #download-pdf-btn { margin-left: 7px; background: #4CAF50; }
    #download-pdf-btn:hover { background: #2E7D32; }

    /* ================= PDF-SPECIFIC STYLES ================= */
    @media print {
      body {
        background: #fff !important;
        margin: 0;
        padding: 0;
        font-size: 10pt !important;
      }
      
      .panel {
        box-shadow: none;
        border-radius: 0;
        margin: 0;
        padding: 10px;
        width: 100%;
        max-width: 100%;
      }
      
      .panel-heading {
        margin: 0 0 15px 0;
        border-radius: 0;
        font-size: 16pt;
        page-break-after: avoid;
      }
      
      .filter-bar {
        display: none !important;
      }
      
      .pdf-section {
        margin-bottom: 15px;
        page-break-inside: avoid !important;
        width: 100% !important;
      }
      
      .pdf-heading {
        margin-top: 10px;
        margin-bottom: 8px;
        page-break-after: avoid !important;
        font-size: 12pt !important;
      }
      
      table, tr, td, th, tbody, thead {
        page-break-inside: avoid !important;
      }
      
      h2, h3, h4 {
        page-break-after: avoid !important;
      }
      
      @page {
        size: landscape;
        margin: 0.5cm;
      }
    }

    /* ================= NEW LAYOUT STYLES ================= */
    .task-info-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin: 25px 0;
    }

    .full-width-section {
      width: 100%;
      margin: 25px 0;
    }

    .section-box {
      background: white;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      width: 100%;
      box-sizing: border-box;
    }

    .section-header {
      font-size: 1.2rem;
      color: #1976d2;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }

    /* Table Styles */
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 0.80rem;
      table-layout: auto;
      word-break: break-word;
    }

    .report-table th, .report-table td {
      text-align: left;
      padding: 6px 6px;
      border: 1px solid #ddd;
      vertical-align: top;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
    }

    .report-table th {
      color: #222;
      font-weight: bold;
      background: #f1f7fe;
    }

    .report-table tr:nth-child(even) {
      background: #f9fbfd;
    }

    .currency { font-weight: 500; color: #1976d2; }

    .total-row td {
      font-weight: bold;
      border-top: 2px solid #d1e4fc;
      color: #1976d2;
      background: #f1f7fe;
    }

    .cost-cell {
      text-align: right;
      font-family: 'Courier New', monospace;
      font-weight: 500;
    }

    /* Task List Styles */
    .task-list-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      margin: 10px 0;
      padding: 10px;
      background: #f8fafc;
    }

    .task-item {
      padding: 12px 15px;
      margin: 5px 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-item:hover {
      background: #e3f2fd;
      border-color: #1976d2;
    }

    .task-id {
      font-weight: bold;
      font-family: 'Courier New', monospace;
    }

    .task-desc {
      flex: 1;
      margin-left: 15px;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-completed {
      background: #e8f5e9;
      color: #2E7D32;
    }

    .status-ongoing {
      background: #e3f2fd;
      color: #1976d2;
    }

    .status-pending {
      background: #fff3e0;
      color: #EF6C00;
    }

    /* Material List Styles */
    .material-item {
      padding: 15px;
      margin: 10px 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      display: grid;
      grid-template-columns: 3fr 1fr 1fr 1fr;
      gap: 20px;
      align-items: center;
      width: 100%;
      box-sizing: border-box;
    }

    .material-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .material-name {
      font-weight: 600;
      color: #2d3748;
      font-size: 1rem;
    }

    .material-details {
      font-size: 0.85rem;
      color: #64748b;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .material-quantity, .material-price, .material-total {
      font-weight: 500;
      font-family: 'Courier New', monospace;
      text-align: right;
      font-size: 1rem;
      white-space: nowrap;
    }

    .material-total {
      font-weight: bold;
      color: #1b5e20;
      font-size: 1.1rem;
    }

    /* Employee List Styles - UPDATED */
    .employee-item {
      padding: 15px;
      margin: 10px 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      display: grid;
      grid-template-columns: 2fr 2fr 1fr 1fr;
      gap: 15px;
      align-items: center;
      width: 100%;
      box-sizing: border-box;
    }

    .employee-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .employee-name {
      font-weight: 600;
      color: #2d3748;
      font-size: 1rem;
    }

    .employee-dates {
      font-size: 0.85rem;
      color: #64748b;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .works-done {
      font-size: 0.9rem;
      color: #2d3748;
      line-height: 1.4;
    }

    .employee-hours {
      font-weight: 500;
      color: #1976d2;
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      text-align: right;
    }

    /* Allowance Display */
    .allowance-details {
      background: #fff8e1;
      border: 1px solid #ffd54f;
      border-radius: 6px;
      padding: 10px 15px;
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .allowance-label {
      font-weight: 600;
      color: #ff8f00;
    }

    .allowance-value {
      font-weight: bold;
      color: #e65100;
      font-family: 'Courier New', monospace;
      font-size: 1rem;
    }

    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .summary-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #1976d2;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      text-align: center;
    }

    .summary-card.allowance {
      border-left-color: #ff9800;
      background: linear-gradient(135deg, #fff8e1 0%, #fff3e0 100%);
    }

    .summary-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #1a237e;
      margin-bottom: 5px;
    }

    .summary-label {
      color: #64748b;
      font-size: 0.85rem;
    }

    /* Material Grid */
    .materials-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    /* Date Display Styles */
    .date-display {
      display: flex;
      gap: 20px;
      margin: 10px 0;
      padding: 10px;
      background: #f8fafc;
      border-radius: 6px;
    }

    .date-item {
      display: flex;
      flex-direction: column;
    }

    .date-label {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 4px;
    }

    .date-value {
      font-weight: 600;
      color: #2d3748;
      font-size: 1rem;
    }

    /* Loading Spinner */
    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1976d2;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .task-info-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .filter-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .material-item {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 12px;
      }
      
      .employee-item {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 12px;
      }
      
      .material-quantity, .material-price, .material-total {
        text-align: left;
        padding-left: 10px;
      }
      
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .panel {
        padding: 10px;
        margin: 10px;
      }
      
      .report-table {
        font-size: 0.7rem;
      }
      
      .report-table th, .report-table td {
        padding: 4px 2px;
      }
    }

    /* PDF-specific responsive overrides */
    @media print and (max-width: 900px) {
      .material-item {
        grid-template-columns: 3fr 1fr 1fr 1fr !important;
      }
      
      .employee-item {
        grid-template-columns: 2fr 2fr 1fr 1fr !important;
      }
    }

    /* For PDF to use consistent font sizes */
    .pdf-font-size {
      font-size: 9pt !important;
    }

    /* Force consistent styling for PDF */
    .pdf-force-styles * {
      font-family: Arial, Helvetica, sans-serif !important;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="panel">
    <div class="panel-heading">
      <a href="dashboard.html" style="color: white; text-decoration: none; background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 5px;">← Dashboard</a>
      Task Material & Employee Report
      <span style="font-size: 0.9rem; opacity: 0.9;">(With Start/End Dates & Works Done)</span>
    </div>
    
    <div class="filter-bar">
      <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; width: 100%;">
        <div>
          <label for="project-select">Project:</label>
          <select id="project-select">
            <option value="">Select a project...</option>
          </select>
        </div>
        
        <div>
          <label for="task-select">Task:</label>
          <select id="task-select">
            <option value="">All tasks from project</option>
          </select>
        </div>
        
        <div>
          <label for="show-all-toggle">View:</label>
          <select id="show-all-toggle">
            <option value="single">Single Task</option>
            <option value="all">All Tasks</option>
          </select>
        </div>

        <div>
          <label for="allowance-source">Allowance:</label>
          <select id="allowance-source">
            <option value="from-file">From Personnel Expenses</option>
            <option value="fixed-rate">Fixed Daily Rate</option>
          </select>
        </div>
        
        <button id="load-tasks-btn">Load Project Tasks</button>
        <button id="generate-report-btn">Generate Report</button>
        <button id="download-pdf-btn" disabled>Download as PDF</button>
      </div>
    </div>

    <!-- Summary Cards -->
    <div id="summary-cards" class="summary-cards" style="display: none;"></div>

    <!-- Main Report Output Area -->
    <div id="report-output">
      <div class="loading" id="initial-loading">
        <div class="spinner"></div>
        <p>Loading data...</p>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDXhhy94Aqmaav6X0UsfMcmsBT539-aheU",
  authDomain: "project-task-588c4.firebaseapp.com",
  projectId: "project-task-588c4",
  storageBucket: "project-task-588c4.appspot.com",
  messagingSenderId: "411882772509",
  appId: "1:411882772509:web:08d613186c101a99f38ef4",
  measurementId: "G-JMFLFYEM0F"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM Elements
const projectSelect = document.getElementById('project-select');
const taskSelect = document.getElementById('task-select');
const showAllToggle = document.getElementById('show-all-toggle');
const allowanceSource = document.getElementById('allowance-source');
const loadTasksBtn = document.getElementById('load-tasks-btn');
const generateBtn = document.getElementById('generate-report-btn');
const downloadPdfBtn = document.getElementById('download-pdf-btn');
const reportOutput = document.getElementById('report-output');
const summaryCards = document.getElementById('summary-cards');
const initialLoading = document.getElementById('initial-loading');

// Global Data Storage
let projectsData = [];
let allTasksData = [];
let allMaterialsData = [];
let allEmployeesData = [];
let personnelExpensesData = [];
let selectedProjectTasks = [];
let selectedTaskMaterials = [];
let selectedTaskEmployees = [];
let currentProjectId = null;

// Constants
const LABOUR_COST_PER_HOUR = 20;
const FIXED_LUNCH_ALLOWANCE = 50;
const FIXED_TRANSPORT_ALLOWANCE = 30;

// Store last report for PDF export
let lastReportHTML = '';

// Initialize Application
async function initializeAppData() {
  try {
    // Load all projects
    const projectsSnapshot = await getDocs(collection(db, "projectDashboard"));
    projectsData = projectsSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    // Populate project dropdown
    projectsData.forEach(project => {
      const option = document.createElement('option');
      option.value = project.id;
      option.textContent = project.name || project.id;
      projectSelect.appendChild(option);
    });

    // Load all materials
    const materialsSnapshot = await getDocs(collection(db, "materialsUsage"));
    allMaterialsData = materialsSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    // Load all employees
    const employeesSnapshot = await getDocs(collection(db, "employees"));
    allEmployeesData = employeesSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    // Load personnel expenses data
    const expensesSnapshot = await getDocs(collection(db, "PersonnelExpenses"));
    personnelExpensesData = expensesSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));

    console.log('Initial data loaded:', {
      projects: projectsData.length,
      materials: allMaterialsData.length,
      employees: allEmployeesData.length,
      expenses: personnelExpensesData.length
    });

    initialLoading.style.display = 'none';

  } catch (error) {
    console.error('Error loading initial data:', error);
    initialLoading.innerHTML = `<div style="color: red; text-align: center;">Error loading data: ${error.message}</div>`;
  }
}

// Load tasks for selected project
async function loadProjectTasks() {
  const projectId = projectSelect.value;
  if (!projectId) {
    alert('Please select a project first');
    return;
  }

  currentProjectId = projectId;
  loadTasksBtn.disabled = true;
  loadTasksBtn.textContent = 'Loading...';

  try {
    // Clear task dropdown
    taskSelect.innerHTML = '<option value="">All tasks from project</option>';
    selectedProjectTasks = [];

    // Get project name
    const projectDoc = await getDoc(doc(db, "projectDashboard", projectId));
    const projectData = projectDoc.exists() ? projectDoc.data() : {};
    const projectName = projectData.name || 'Unknown Project';
    const projectStartDate = projectData.startDate ? 
      (projectData.startDate.toDate ? projectData.startDate.toDate().toLocaleDateString() : projectData.startDate) : 'Not set';
    const projectEndDate = projectData.endDate ? 
      (projectData.endDate.toDate ? projectData.endDate.toDate().toLocaleDateString() : projectData.endDate) : 'Not set';

    // Get main tasks for this project
    const tasksQuery = query(
      collection(db, "projectTasks"),
      where("projectId", "==", projectId)
    );
    
    const tasksSnapshot = await getDocs(tasksQuery);
    
    for (const taskDoc of tasksSnapshot.docs) {
      const taskData = taskDoc.data();
      const taskId = taskData.taskId || taskDoc.id;
      
      // Get subtasks
      const subtasksSnapshot = await getDocs(
        collection(db, "projectTasks", taskDoc.id, "subtasks")
      );
      
      // Add main task with dates
      const mainTask = {
        id: taskId,
        docId: taskDoc.id,
        isSubtask: false,
        parentTaskId: null,
        ...taskData,
        projectName: projectName,
        projectStartDate: projectStartDate,
        projectEndDate: projectEndDate,
        startDate: taskData.startDate || taskData.createdAt || projectStartDate,
        endDate: taskData.endDate || taskData.deadline || projectEndDate,
        worksDone: taskData.worksDone || taskData.description || taskData.taskDescription || 'No works description'
      };
      selectedProjectTasks.push(mainTask);
      
      // Add to dropdown
      const option = document.createElement('option');
      option.value = taskId;
      option.textContent = `${taskId}: ${taskData.taskDescription || 'No description'}`;
      taskSelect.appendChild(option);
      
      // Add subtasks
      for (const subDoc of subtasksSnapshot.docs) {
        const subData = subDoc.data();
        const subTaskId = subData.taskId || subDoc.id;
        
        const subtask = {
          id: subTaskId,
          docId: subDoc.id,
          isSubtask: true,
          parentTaskId: taskId,
          ...subData,
          projectName: projectName,
          projectStartDate: projectStartDate,
          projectEndDate: projectEndDate,
          startDate: subData.startDate || subData.createdAt || taskData.startDate || projectStartDate,
          endDate: subData.endDate || subData.deadline || taskData.endDate || projectEndDate,
          worksDone: subData.worksDone || subData.description || subData.taskDescription || 'No works description'
        };
        selectedProjectTasks.push(subtask);
        
        // Add to dropdown
        const subOption = document.createElement('option');
        subOption.value = subTaskId;
        subOption.textContent = `  ↳ ${subTaskId}: ${subData.taskDescription || 'No description'}`;
        taskSelect.appendChild(subOption);
        
        // Get sub-subtasks
        const subSubSnapshot = await getDocs(
          collection(db, "projectTasks", taskDoc.id, "subtasks", subDoc.id, "subsubtasks")
        );
        
        for (const subSubDoc of subSubSnapshot.docs) {
          const subSubData = subSubDoc.data();
          const subSubTaskId = subSubData.taskId || subSubDoc.id;
          
          const subsubtask = {
            id: subSubTaskId,
            docId: subSubDoc.id,
            isSubtask: true,
            parentTaskId: subTaskId,
            ...subSubData,
            projectName: projectName,
            projectStartDate: projectStartDate,
            projectEndDate: projectEndDate,
            startDate: subSubData.startDate || subSubData.createdAt || subData.startDate || projectStartDate,
            endDate: subSubData.endDate || subSubData.deadline || subData.endDate || projectEndDate,
            worksDone: subSubData.worksDone || subSubData.description || subSubData.taskDescription || 'No works description'
          };
          selectedProjectTasks.push(subsubtask);
          
          // Add to dropdown
          const subSubOption = document.createElement('option');
          subSubOption.value = subSubTaskId;
          subSubOption.textContent = `    ↳ ${subSubTaskId}: ${subSubData.taskDescription || 'No description'}`;
          taskSelect.appendChild(subSubOption);
        }
      }
    }

    console.log(`Loaded ${selectedProjectTasks.length} tasks for project ${projectName}`);
    
    // Enable generate button if we have tasks
    if (selectedProjectTasks.length > 0) {
      generateBtn.disabled = false;
    }

  } catch (error) {
    console.error('Error loading project tasks:', error);
    alert(`Error loading tasks: ${error.message}`);
  } finally {
    loadTasksBtn.disabled = false;
    loadTasksBtn.textContent = 'Load Project Tasks';
  }
}

// Get allowance for a task
async function getAllowanceForTask(taskId) {
  const source = allowanceSource.value;
  
  if (source === 'from-file') {
    // Get from PersonnelExpenses collection
    const taskExpenses = personnelExpensesData.filter(expense => 
      expense.taskId === taskId
    );
    
    let totalLunch = 0;
    let totalTransport = 0;
    let totalAirtime = 0;
    
    taskExpenses.forEach(expense => {
      totalLunch += parseFloat(expense.lunch) || 0;
      totalTransport += parseFloat(expense.transport) || 0;
      totalAirtime += parseFloat(expense.airtime) || 0;
    });
    
    const totalAllowance = totalLunch + totalTransport + totalAirtime;
    
    return {
      lunch: totalLunch,
      transport: totalTransport,
      airtime: totalAirtime,
      total: totalAllowance,
      source: 'file',
      entries: taskExpenses,
      daysCount: taskExpenses.length
    };
  } else {
    // Fixed daily rate calculation based on employee days worked
    const employees = await getEmployeesForTask(taskId);
    
    // Count unique work days from employees
    const uniqueDays = new Set();
    
    employees.forEach(employee => {
      employee.records?.forEach(record => {
        if (record.date) {
          const dateKey = record.date.toISOString ? record.date.toISOString().split('T')[0] : record.date;
          uniqueDays.add(dateKey);
        }
      });
    });
    
    const daysCount = uniqueDays.size;
    const totalLunch = daysCount * FIXED_LUNCH_ALLOWANCE;
    const totalTransport = daysCount * FIXED_TRANSPORT_ALLOWANCE;
    const totalAllowance = totalLunch + totalTransport;
    
    return {
      lunch: totalLunch,
      transport: totalTransport,
      airtime: 0,
      total: totalAllowance,
      source: 'fixed',
      daysCount: daysCount,
      dailyRate: {
        lunch: FIXED_LUNCH_ALLOWANCE,
        transport: FIXED_TRANSPORT_ALLOWANCE
      }
    };
  }
}

// Get all materials for a specific task
async function getMaterialsForTask(taskId) {
  try {
    // Filter materials by taskId
    const taskMaterials = allMaterialsData.filter(material => 
      material.taskId === taskId && !material.reversed
    );

    // Enhance materials with additional info
    const enhancedMaterials = [];
    
    for (const material of taskMaterials) {
      let enhancedMaterial = { ...material };
      
      // Try to get material details from materials collection
      if (material.materialId) {
        try {
          const materialDoc = await getDoc(doc(db, "materials", material.materialId));
          if (materialDoc.exists()) {
            const materialData = materialDoc.data();
            enhancedMaterial.materialName = materialData.materialName || materialData.name || 'Unknown';
            enhancedMaterial.unitPrice = materialData.unitPrice || material.unitPrice || 0;
            enhancedMaterial.category = materialData.category || materialData.type || 'General';
          }
        } catch (err) {
          console.warn('Could not fetch material details:', err);
        }
      }
      
      // Calculate total if we have quantity and price
      if (enhancedMaterial.quantity && enhancedMaterial.unitPrice) {
        enhancedMaterial.totalCost = parseFloat(enhancedMaterial.quantity) * parseFloat(enhancedMaterial.unitPrice);
      } else if (enhancedMaterial.amount) {
        enhancedMaterial.totalCost = parseFloat(enhancedMaterial.amount);
        enhancedMaterial.quantity = 1;
      }
      
      enhancedMaterials.push(enhancedMaterial);
    }
    
    return enhancedMaterials;
    
  } catch (error) {
    console.error('Error getting materials for task:', error);
    return [];
  }
}

// Get all employees for a specific task with dates and works done
async function getEmployeesForTask(taskId) {
  try {
    // Get location history for this task
    const locationQuery = query(
      collection(db, "locationHistory"),
      where("taskId", "==", taskId)
    );
    
    const locationSnapshot = await getDocs(locationQuery);
    const employeeHours = {};
    
    for (const locDoc of locationSnapshot.docs) {
      const locData = locDoc.data();
      if (locData.reversed || !locData.employeeId) continue;
      
      const employeeId = locData.employeeId;
      const hours = parseFloat(locData.mh) || 0;
      
      if (!employeeHours[employeeId]) {
        employeeHours[employeeId] = {
          totalHours: 0,
          records: [],
          startDate: null,
          endDate: null,
          worksDone: []
        };
      }
      
      employeeHours[employeeId].totalHours += hours;
      
      const recordDate = locData.transferredAt?.toDate?.() || locData.date?.toDate?.() || new Date();
      
      // Track start and end dates
      if (!employeeHours[employeeId].startDate || recordDate < employeeHours[employeeId].startDate) {
        employeeHours[employeeId].startDate = recordDate;
      }
      if (!employeeHours[employeeId].endDate || recordDate > employeeHours[employeeId].endDate) {
        employeeHours[employeeId].endDate = recordDate;
      }
      
      // Track works done
      if (locData.taskDescription || locData.description) {
        const workDesc = locData.taskDescription || locData.description;
        if (!employeeHours[employeeId].worksDone.includes(workDesc)) {
          employeeHours[employeeId].worksDone.push(workDesc);
        }
      }
      
      employeeHours[employeeId].records.push({
        date: recordDate,
        hours: hours,
        description: locData.taskDescription || 'Work hours'
      });
    }
    
    // Enhance with employee details
    const enhancedEmployees = [];
    
    for (const [employeeId, data] of Object.entries(employeeHours)) {
      // Find employee in our loaded data
      const employee = allEmployeesData.find(emp => emp.id === employeeId);
      
      enhancedEmployees.push({
        id: employeeId,
        name: employee ? 
          `${employee.name || ''} ${employee.surname || ''}`.trim() || employeeId : 
          `Employee ${employeeId}`,
        totalHours: data.totalHours,
        labourCost: data.totalHours * LABOUR_COST_PER_HOUR,
        startDate: data.startDate,
        endDate: data.endDate,
        worksDone: data.worksDone,
        records: data.records,
        details: employee || null
      });
    }
    
    return enhancedEmployees;
    
  } catch (error) {
    console.error('Error getting employees for task:', error);
    return [];
  }
}

// Generate the report
async function generateReport() {
  const selectedTaskId = taskSelect.value;
  const showAll = showAllToggle.value === 'all';
  
  generateBtn.disabled = true;
  generateBtn.textContent = 'Generating...';
  
  try {
    let tasksToProcess = [];
    
    if (showAll) {
      // Process all tasks for the project
      tasksToProcess = selectedProjectTasks;
    } else if (selectedTaskId) {
      // Process only selected task
      const selectedTask = selectedProjectTasks.find(t => t.id === selectedTaskId);
      if (selectedTask) {
        tasksToProcess = [selectedTask];
      }
    } else {
      // Process all tasks from project (default)
      tasksToProcess = selectedProjectTasks;
    }
    
    if (tasksToProcess.length === 0) {
      reportOutput.innerHTML = '<div class="loading"><p>No tasks to display.</p></div>';
      return;
    }
    
    // Process each task
    const processedTasks = [];
    let totalMaterialCost = 0;
    let totalLabourCost = 0;
    let totalAllowanceCost = 0;
    let totalMaterialsCount = 0;
    let totalEmployeesCount = 0;
    let totalAllowanceDays = 0;
    
    for (const task of tasksToProcess) {
      // Get materials for this task
      const taskMaterials = await getMaterialsForTask(task.id);
      
      // Get employees for this task
      const taskEmployees = await getEmployeesForTask(task.id);
      
      // Get allowance for this task
      const taskAllowance = await getAllowanceForTask(task.id);
      
      // Calculate costs
      const materialCost = taskMaterials.reduce((sum, mat) => sum + (mat.totalCost || 0), 0);
      const labourCost = taskEmployees.reduce((sum, emp) => sum + emp.labourCost, 0);
      const allowanceCost = taskAllowance.total;
      
      processedTasks.push({
        ...task,
        materials: taskMaterials,
        employees: taskEmployees,
        allowance: taskAllowance,
        materialCost,
        labourCost,
        allowanceCost,
        totalCost: materialCost + labourCost + allowanceCost
      });
      
      totalMaterialCost += materialCost;
      totalLabourCost += labourCost;
      totalAllowanceCost += allowanceCost;
      totalMaterialsCount += taskMaterials.length;
      totalEmployeesCount += taskEmployees.length;
      totalAllowanceDays += taskAllowance.daysCount || 0;
    }
    
    // Update summary cards
    updateSummaryCards({
      tasksCount: processedTasks.length,
      materialsCount: totalMaterialsCount,
      employeesCount: totalEmployeesCount,
      materialCost: totalMaterialCost,
      labourCost: totalLabourCost,
      allowanceCost: totalAllowanceCost,
      allowanceDays: totalAllowanceDays,
      totalCost: totalMaterialCost + totalLabourCost + totalAllowanceCost
    });
    
    // Generate the report HTML
    generateReportHTML(processedTasks, showAll);
    
    // Enable download button
    downloadPdfBtn.disabled = false;
    
  } catch (error) {
    console.error('Error generating report:', error);
    reportOutput.innerHTML = `<div style="color: red; padding: 20px; text-align: center;">Error: ${error.message}</div>`;
  } finally {
    generateBtn.disabled = false;
    generateBtn.textContent = 'Generate Report';
  }
}

// Update summary cards
function updateSummaryCards(totals) {
  summaryCards.style.display = 'grid';
  summaryCards.innerHTML = `
    <div class="summary-card">
      <div class="summary-value">${totals.tasksCount}</div>
      <div class="summary-label">Tasks</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">${totals.materialsCount}</div>
      <div class="summary-label">Materials</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">${totals.employeesCount}</div>
      <div class="summary-label">Employees</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">ZMW ${totals.materialCost.toFixed(2)}</div>
      <div class="summary-label">Material Cost</div>
    </div>
    <div class="summary-card">
      <div class="summary-value">ZMW ${totals.labourCost.toFixed(2)}</div>
      <div class="summary-label">Labour Cost</div>
    </div>
    <div class="summary-card allowance">
      <div class="summary-value">ZMW ${totals.allowanceCost.toFixed(2)}</div>
      <div class="summary-label">Allowance Cost</div>
      <small style="color: #666; font-size: 0.75rem;">(${totals.allowanceDays} days)</small>
    </div>
    <div class="summary-card" style="background: #e8f5e9; border-left-color: #4CAF50;">
      <div class="summary-value">ZMW ${totals.totalCost.toFixed(2)}</div>
      <div class="summary-label">Total Cost</div>
      <small style="color: #666; font-size: 0.75rem;">(incl. allowance)</small>
    </div>
  `;
}

// Format date function
function formatDate(dateInput) {
  if (!dateInput) return 'Not set';
  
  try {
    if (dateInput.toDate) {
      const date = dateInput.toDate();
      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    } else if (dateInput instanceof Date) {
      return dateInput.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    } else if (typeof dateInput === 'string') {
      const date = new Date(dateInput);
      if (!isNaN(date.getTime())) {
        return date.toLocaleDateString('en-GB', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      }
      return dateInput;
    }
    return 'Not set';
  } catch (error) {
    console.warn('Date formatting error:', error, dateInput);
    return 'Not set';
  }
}

// Generate report HTML with PDF-specific classes
function generateReportHTML(tasks, showAll) {
  let html = '<div id="report-export-section" class="pdf-force-styles">';
  
  if (showAll) {
    // Show all tasks in the project
    html += `
      <div class="pdf-section">
        <div class="section-box">
          <h3 class="section-header pdf-heading">All Tasks in Project</h3>
          <div class="task-list-container">
    `;
    
    tasks.forEach(task => {
      const statusClass = `status-${(task.status || 'pending').toLowerCase()}`;
      const startDate = formatDate(task.startDate);
      const endDate = formatDate(task.endDate);
      
      html += `
        <div class="task-item">
          <div class="task-id">${task.id}</div>
          <div class="task-desc">
            ${task.taskDescription || 'No description'}
            <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">
              ${startDate} - ${endDate}
            </div>
          </div>
          <div class="task-status ${statusClass}">${task.status || 'Pending'}</div>
        </div>
      `;
    });
    
    html += `
          </div>
        </div>
      </div>
    `;
  }
  
  // Generate detailed view for each task
  tasks.forEach((task, index) => {
    const statusClass = `status-${(task.status || 'pending').toLowerCase()}`;
    const allowanceSourceText = task.allowance.source === 'file' ? 'From Personnel Expenses' : 'Fixed Daily Rate';
    const taskStartDate = formatDate(task.startDate);
    const taskEndDate = formatDate(task.endDate);
    const projectStartDate = formatDate(task.projectStartDate);
    const projectEndDate = formatDate(task.projectEndDate);
    
    html += `
      <!-- Task Section - PDF friendly -->
      <div class="pdf-section">
        <!-- Task Information Grid -->
        <div class="task-info-grid">
          <!-- Task Information (Left) -->
          <div class="section-box">
            <h3 class="section-header pdf-heading">Task Information</h3>
            
            <!-- Dates Display -->
            <div style="margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 6px;">
              <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                <div style="flex: 1;">
                  <div style="font-size: 0.85rem; color: #64748b;">Task Dates:</div>
                  <div style="font-weight: 600; color: #2d3748;">${taskStartDate} - ${taskEndDate}</div>
                </div>
              </div>
              <div>
                <div style="font-size: 0.85rem; color: #64748b;">Works Done:</div>
                <div style="font-weight: 500; color: #2d3748; margin-top: 5px; line-height: 1.4;">
                  ${task.worksDone || 'No works description provided'}
                </div>
              </div>
            </div>
            
            <table class="report-table pdf-font-size">
              <tr>
                <td style="width: 30%;"><strong>Task ID:</strong></td>
                <td>${task.id}</td>
              </tr>
              <tr>
                <td><strong>Description:</strong></td>
                <td>${task.taskDescription || 'No description'}</td>
              </tr>
              <tr>
                <td><strong>Project:</strong></td>
                <td>${task.projectName || 'Unknown'}</td>
              </tr>
              <tr>
                <td><strong>Status:</strong></td>
                <td><span class="task-status ${statusClass}">${task.status || 'Pending'}</span></td>
              </tr>
              <tr>
                <td><strong>Allowance Source:</strong></td>
                <td>${allowanceSourceText}</td>
              </tr>
            </table>
          </div>
          
          <!-- Cost Summary (Right) -->
          <div class="section-box">
            <h3 class="section-header pdf-heading">Cost Summary</h3>
            <table class="report-table pdf-font-size">
              <tr>
                <td><strong>Material Cost:</strong></td>
                <td class="cost-cell">ZMW ${task.materialCost.toFixed(2)}</td>
              </tr>
              <tr>
                <td><strong>Labour Cost:</strong></td>
                <td class="cost-cell">ZMW ${task.labourCost.toFixed(2)}</td>
              </tr>
              <tr style="background: #fff8e1;">
                <td><strong>Allowance Cost:</strong></td>
                <td class="cost-cell">ZMW ${task.allowanceCost.toFixed(2)}</td>
              </tr>
              <tr class="total-row">
                <td><strong>Total Cost:</strong></td>
                <td class="cost-cell">ZMW ${task.totalCost.toFixed(2)}</td>
              </tr>
            </table>
            
            <!-- Allowance Breakdown -->
            <div style="margin-top: 20px; padding: 15px; background: #fff8e1; border-radius: 6px; border: 1px solid #ffd54f;">
              <h4 style="margin: 0 0 10px 0; color: #ff8f00;">Allowance Breakdown</h4>
              <table style="width: 100%; font-size: 0.9rem;">
                <tr>
                  <td>Lunch Allowance:</td>
                  <td style="text-align: right; font-weight: bold;">ZMW ${task.allowance.lunch.toFixed(2)}</td>
                </tr>
                <tr>
                  <td>Transport Allowance:</td>
                  <td style="text-align: right; font-weight: bold;">ZMW ${task.allowance.transport.toFixed(2)}</td>
                </tr>
                ${task.allowance.airtime > 0 ? `
                <tr>
                  <td>Airtime Allowance:</td>
                  <td style="text-align: right; font-weight: bold;">ZMW ${task.allowance.airtime.toFixed(2)}</td>
                </tr>
                ` : ''}
                <tr style="border-top: 1px solid #ffd54f;">
                  <td><strong>Total Allowance:</strong></td>
                  <td style="text-align: right; font-weight: bold; color: #e65100;">ZMW ${task.allowance.total.toFixed(2)}</td>
                </tr>
                ${task.allowance.daysCount ? `
                <tr>
                  <td colspan="2" style="font-size: 0.8rem; color: #666; text-align: center;">
                    Based on ${task.allowance.daysCount} work day${task.allowance.daysCount !== 1 ? 's' : ''}
                  </td>
                </tr>
                ` : ''}
              </table>
            </div>
          </div>
        </div>
        
        <!-- Detailed Allowance Information -->
        ${task.allowance.source === 'file' && task.allowance.entries && task.allowance.entries.length > 0 ? `
        <div class="full-width-section">
          <div class="section-box">
            <h3 class="section-header pdf-heading">Allowance Details (From Personnel Expenses)</h3>
            <div style="overflow-x: auto;">
              <table class="report-table pdf-font-size">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Personnel</th>
                    <th>Purpose</th>
                    <th>Transport</th>
                    <th>Airtime</th>
                    <th>Lunch</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${task.allowance.entries.map(entry => {
                    const entryTotal = (parseFloat(entry.transport) || 0) + (parseFloat(entry.airtime) || 0) + (parseFloat(entry.lunch) || 0);
                    return `
                    <tr>
                      <td>${entry.date || '-'}</td>
                      <td>${entry.personnel || '-'}</td>
                      <td>${entry.purpose || '-'}</td>
                      <td style="text-align: right;">${entry.transport ? parseFloat(entry.transport).toFixed(2) : '0.00'}</td>
                      <td style="text-align: right;">${entry.airtime ? parseFloat(entry.airtime).toFixed(2) : '0.00'}</td>
                      <td style="text-align: right;">${entry.lunch ? parseFloat(entry.lunch).toFixed(2) : '0.00'}</td>
                      <td style="text-align: right; font-weight: bold;">${entryTotal.toFixed(2)}</td>
                    </tr>
                    `;
                  }).join('')}
                </tbody>
                <tfoot>
                  <tr style="background: #fff8e1; font-weight: bold;">
                    <td colspan="3">TOTAL ALLOWANCE</td>
                    <td style="text-align: right;">${task.allowance.transport.toFixed(2)}</td>
                    <td style="text-align: right;">${task.allowance.airtime.toFixed(2)}</td>
                    <td style="text-align: right;">${task.allowance.lunch.toFixed(2)}</td>
                    <td style="text-align: right; color: #e65100;">${task.allowance.total.toFixed(2)}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
        ` : ''}
        
        <!-- Materials Section -->
        <div class="full-width-section">
          <div class="section-box">
            <h3 class="section-header pdf-heading">Materials Assigned (${task.materials.length})</h3>
            ${task.materials.length > 0 ? `
              <div class="materials-grid">
                ${task.materials.map(material => {
                  const materialDate = material.date ? formatDate(material.date) : 'No date';
                  return `
                  <div class="material-item">
                    <div class="material-info">
                      <div class="material-name">${material.materialName || material.materialId || 'Unknown Material'}</div>
                      <div class="material-details">
                        ${material.category ? `<span>Category: ${material.category}</span>` : ''}
                        <span>Date: ${materialDate}</span>
                      </div>
                    </div>
                    <div class="material-quantity">
                      ${material.quantity || 1} ${material.unit || 'units'}
                    </div>
                    <div class="material-price">
                      ZMW ${(material.unitPrice || material.amount || 0).toFixed(2)} each
                    </div>
                    <div class="material-total">
                      ZMW ${(material.totalCost || material.amount || 0).toFixed(2)}
                    </div>
                  </div>
                  `;
                }).join('')}
              </div>
            ` : '<p style="text-align: center; color: #666; padding: 20px;">No materials assigned to this task</p>'}
          </div>
        </div>
        
        <!-- Employees Section WITH DATES AND WORKS DONE -->
        <div class="full-width-section">
          <div class="section-box">
            <h3 class="section-header pdf-heading">Employees Assigned (${task.employees.length})</h3>
            ${task.employees.length > 0 ? `
              <div style="width: 100%;">
                ${task.employees.map(employee => {
                  const empStartDate = employee.startDate ? formatDate(employee.startDate) : 'Not set';
                  const empEndDate = employee.endDate ? formatDate(employee.endDate) : 'Not set';
                  const worksDoneText = employee.worksDone && employee.worksDone.length > 0 
                    ? employee.worksDone.join(', ') 
                    : 'No specific works recorded';
                  
                  return `
                  <div class="employee-item">
                    <div class="employee-info">
                      <div class="employee-name">${employee.name}</div>
                      <div class="employee-dates">
                        <span>Start: ${empStartDate}</span>
                        <span>End: ${empEndDate}</span>
                      </div>
                    </div>
                    <div class="works-done" style="max-width: 400px;">
                      ${worksDoneText}
                    </div>
                    <div class="employee-hours">
                      ${employee.totalHours.toFixed(1)} hrs
                    </div>
                    <div class="employee-hours">
                      ZMW ${employee.labourCost.toFixed(2)}
                    </div>
                  </div>
                  `;
                }).join('')}
              </div>
            ` : '<p style="text-align: center; color: #666; padding: 20px;">No employees assigned to this task</p>'}
          </div>
        </div>
      </div>
      ${index < tasks.length - 1 ? '<hr style="margin: 30px 0; border: none; border-top: 2px solid #e2e8f0; width: 100%;">' : ''}
    `;
  });
  
  html += '</div>'; // Close report-export-section
  reportOutput.innerHTML = html;
  lastReportHTML = html;
}

// Export to PDF
downloadPdfBtn.addEventListener('click', () => {
  const section = document.getElementById("report-export-section");
  
  if (!section) {
    alert('Please generate a report first');
    return;
  }
  
  // Sanitize blanks before export
  section.querySelectorAll("td, span, div").forEach(el => {
    if (!el.innerText || el.innerText === "undefined" || el.innerText === "null") {
      el.innerText = "0";
    }
  });
  
  // Enforce supported font
  section.style.fontFamily = "Arial, Helvetica, sans-serif";
  
  // PDF configuration
  const opt = {
    margin: 0.2,
    filename: `task-material-employee-report-${new Date().toISOString().split('T')[0]}.pdf`,
    image: { type: 'jpeg', quality: 1 },
    html2canvas: { 
      scale: 2, 
      scrollY: 0, 
      useCORS: true, 
      logging: false, 
      windowWidth: document.body.scrollWidth
    },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };
  
  html2pdf().from(section).set(opt).save();
});

// Event Listeners
projectSelect.addEventListener('change', () => {
  taskSelect.innerHTML = '<option value="">All tasks from project</option>';
  generateBtn.disabled = true;
  downloadPdfBtn.disabled = true;
  reportOutput.innerHTML = '<div class="loading"><p>Select a task or click "Load Project Tasks"</p></div>';
});

loadTasksBtn.addEventListener('click', loadProjectTasks);
generateBtn.addEventListener('click', generateReport);

// Initialize
document.addEventListener('DOMContentLoaded', initializeAppData);
</script>
</body>
</html>