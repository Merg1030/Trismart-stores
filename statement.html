<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trismart Loans - Statement</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Firebase (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    :root{
      --sidebar-width:260px;
      --primary:#1e3c72;
      --accent:#2a5298;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:#f5f7fb;color:#222;min-height:100vh}

    /* Sidebar (uniform look) */
    .sidebar{
      position:fixed;
      left:0;
      top:0;
      bottom:0;
      width:var(--sidebar-width);
      padding:22px;
      display:flex;
      flex-direction:column;
      gap:20px;
      background:linear-gradient(180deg,var(--primary) 0%,var(--accent) 100%);
      color:#fff;
      z-index:60;
      box-shadow:6px 0 30px rgba(16,24,40,0.12);
      transition:transform .28s ease, width .28s ease;
      overflow:auto;
    }
    .sidebar.hidden { transform: translateX(-120%); }
    .brand{display:flex;gap:12px;align-items:center}
    .brand i{font-size:1.6rem;background:rgba(255,255,255,0.07);padding:10px;border-radius:8px}
    .brand .title{font-weight:700;font-size:1.05rem}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:4px}
    .menu-item{display:flex;gap:12px;align-items:center;padding:11px;border-radius:8px;color:rgba(255,255,255,0.95);text-decoration:none}
    .menu-item:hover{background:rgba(255,255,255,0.06);transform:translateX(4px)}
    .menu-item.active{background:rgba(255,255,255,0.10);border-right:4px solid rgba(255,255,255,0.12)}

    /* Main area shifts when sidebar hidden */
    .main{margin-left:var(--sidebar-width);transition:margin-left .28s ease;padding-bottom:60px;min-height:100vh}
    .main.sidebar-hidden{margin-left:0}

    .header{background:white;padding:12px 20px;box-shadow:0 2px 10px rgba(0,0,0,0.06);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:30}
    .header-left{display:flex;align-items:center;gap:12px}
    .sidebar-toggle{width:40px;height:40px;border-radius:8px;border:none;background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .logo-text{font-weight:700;color:var(--primary)}
    .avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(135deg,var(--primary),var(--accent));font-weight:700}

    .container{padding:26px;max-width:1200px;margin:18px auto}
    .card{background:white;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.05);overflow:hidden;margin-bottom:16px}
    .card-header{padding:14px 18px;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .card-body{padding:12px 18px;overflow:auto}
    .form-control{padding:10px;border-radius:8px;border:1px solid #e6edf3;width:100%}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#fff}
    table{width:100%;border-collapse:collapse}
    thead th{padding:12px;text-align:left;background:#fafbfc;color:var(--primary);font-weight:700;border-bottom:1px solid #eef2f7}
    td{padding:12px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
    tr:hover{background:#fbfdff}
    .status-pill{padding:6px 12px;border-radius:20px;font-weight:700;font-size:.85rem;text-transform:capitalize}
    .status-active{background:#d1f7e6;color:#0a6c43}
    .status-paid{background:#d4edda;color:#155724}
    .status-overdue{background:#f8d7da;color:#721c24}

    .error-box { background: #fff0f0; color:#7a1a2b; padding:12px; border-radius:8px; border:1px solid #f5c6cb; margin-bottom:12px; }
    .success-box { background: #d4edda; color:#155724; padding:12px; border-radius:8px; border:1px solid #c3e6cb; margin-bottom:12px; }

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:200;align-items:center;justify-content:center;padding:16px}
    .modal.active{display:flex}
    .modal-card{background:white;border-radius:8px;max-width:720px;width:100%;overflow:hidden}
    .modal-head{background:var(--primary);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:14px}
    .modal-footer{padding:12px;background:#f8fafc;display:flex;justify-content:flex-end;gap:8px}

    @media(max-width:900px){.main{margin-left:0;padding:16px}.sidebar{transform:translateX(-110%);position:fixed}.sidebar.open{transform:translateX(0)}}
  </style>
</head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <i class="fas fa-hand-holding-usd"></i>
      <div class="title">TRI<span style="color: rgba(255,255,255,0.95)">SMART</span></div>
    </div>

    <nav>
      <a class="menu-item" href="index.html"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
      <a class="menu-item" href="customers.html"><i class="fas fa-users"></i><span>Customers</span></a>
      <a class="menu-item" href="loans.html"><i class="fas fa-file-invoice-dollar"></i><span>Loans</span></a>
      <a class="menu-item active" href="#"><i class="fas fa-file-alt"></i><span>Statements</span></a>
      <a class="menu-item" id="sidebarLogout" href="#"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
    </nav>

    <div style="margin-top:auto;font-size:.9rem;opacity:.95;">
      <div style="font-weight:700;">Welcome, <span id="sidebarName">Chris</span></div>
      <div style="font-size:.82rem;opacity:.9;">Statement View</div>
    </div>
  </aside>

  <div class="main" id="main">
    <header class="header">
      <div class="header-left">
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar"><i class="fas fa-bars"></i></button>
        <div class="logo-text">TRI SMART LOANS</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="avatar" id="userAvatar">C</div>
        <div style="text-align:right;">
          <div id="userName">Chris</div>
          <div style="font-size:.8rem;color:#666;">Loan Officer</div>
        </div>
      </div>
    </header>

    <div class="container">
      <div id="errorContainer"></div>
      <div id="successContainer"></div>

      <div class="card">
        <div class="card-header">
          <strong id="statementTitle">Statement</strong>
          <div>
            <a id="backToLoans" href="loans.html" class="btn" style="margin-right:8px"><i class="fas fa-arrow-left"></i> Back</a>
            <button id="refreshBtn" class="btn"><i class="fas fa-sync-alt"></i> Refresh</button>
          </div>
        </div>
        <div class="card-body">
          <div id="loanSummary" style="margin-bottom:20px; padding:15px; background:#f8fafc; border-radius:8px; border:1px solid #eef2f7;"></div>
          <div id="statementsWrap">
            <div style="text-align:center;padding:18px;color:#666" id="loadingState">
              <i class="fas fa-spinner fa-spin fa-2x"></i>
              <div style="margin-top:12px;font-size:1rem">Loading statement...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Record repayment modal -->
  <div class="modal" id="repayModal">
    <div class="modal-card">
      <div class="modal-head">
        <div><i class="fas fa-money-bill-wave"></i> <span id="repayTitle">Record Repayment </span></div>
        <button class="btn" id="closeRepay" style="background:transparent;color:#fff">✕</button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom:15px; padding:10px; background:#f0f8ff; border-radius:6px;">
          <strong id="repayLoanRef"></strong>
          <div id="currentBalanceInfo" style="font-size:0.9rem; color:#666; margin-top:5px;"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
          <div>
            <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;">Amount </label>
            <input id="repayAmount" class="form-control" type="number" placeholder="0.00" min="0.01" step="0.01" required>
          </div>
          <div>
            <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;">Date</label>
            <input id="repayDate" class="form-control" type="date" required>
          </div>
        </div>
        <div style="margin-bottom:15px">
          <label style="display:block;margin-bottom:5px;font-weight:600;color:#555;">Reference / Notes (optional)</label>
          <input id="repayNotes" class="form-control" placeholder="e.g., Cash payment, Bank transfer, etc.">
        </div>
        <div id="repayError" style="color:#dc3545;font-size:0.9rem;margin-top:10px;display:none;"></div>
      </div>
      <div class="modal-footer">
        <button id="cancelRepay" class="btn"><i class="fas fa-times"></i> Cancel</button>
        <button id="saveRepay" class="btn btn-primary"><i class="fas fa-check"></i> Save Repayment</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB-lm7Y3r1F6VvY8PKvY8glLabZDbJsHM1k",
      authDomain: "trismartstores.firebaseapp.com",
      projectId: "trismartstores",
      storageBucket: "trismartstores.appspot.com",
      messagingSenderId: "416692703333",
      appId: "1:416692703333:web:d4b60292621435c748f68c",
      measurementId: "G-NJPQ7L3QWJ"
    };

    // Init Firebase safely
    let app, db;
    try { 
      app = firebase.initializeApp(firebaseConfig); 
      db = firebase.firestore(); 
      console.log('Firebase initialized successfully');
    } catch(e) { 
      console.warn('Firebase init warning', e); 
      if (firebase.apps.length) { 
        app = firebase.app(); 
        db = firebase.firestore(); 
      } 
    }

    const currentUser = localStorage.getItem('username') || 'Chris';
    
    // Debug logging
    console.log('Current user:', currentUser);

    // DOM refs
    const query = new URLSearchParams(window.location.search);
    const loanId = query.get('loanId');
    console.log('Loan ID from URL:', loanId);
    
    const statementsWrap = document.getElementById('statementsWrap');
    const loadingState = document.getElementById('loadingState');
    const statementTitle = document.getElementById('statementTitle');
    const loanSummary = document.getElementById('loanSummary');
    const repayModal = document.getElementById('repayModal');
    const repayLoanRef = document.getElementById('repayLoanRef');
    const currentBalanceInfo = document.getElementById('currentBalanceInfo');
    const repayAmount = document.getElementById('repayAmount');
    const repayDate = document.getElementById('repayDate');
    const repayNotes = document.getElementById('repayNotes');
    const repayError = document.getElementById('repayError');
    const closeRepay = document.getElementById('closeRepay');
    const cancelRepay = document.getElementById('cancelRepay');
    const saveRepay = document.getElementById('saveRepay');
    const sidebarName = document.getElementById('sidebarName');
    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');
    const refreshBtn = document.getElementById('refreshBtn');
    const errorContainer = document.getElementById('errorContainer');
    const successContainer = document.getElementById('successContainer');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const main = document.getElementById('main');

    let loan = null;
    let currentBalance = 0;

    // Sidebar toggle
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      main.classList.toggle('sidebar-hidden');
    });

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM loaded, initializing...');
      
      userName.textContent = currentUser;
      userAvatar.textContent = currentUser.charAt(0).toUpperCase();
      sidebarName.textContent = currentUser;
      
      // Set default date to today
      const today = new Date();
      repayDate.value = today.toISOString().split('T')[0];

      if (!loanId) {
        showError('No loan selected. Please go back to loans and select a loan to view statement.');
        return;
      }

      await loadLoanAndStatements();

      // Event listeners
      refreshBtn.addEventListener('click', () => {
        console.log('Refresh button clicked');
        loadLoanAndStatements();
      });
      
      closeRepay.addEventListener('click', () => {
        repayModal.classList.remove('active');
        hideRepayError();
      });
      
      cancelRepay.addEventListener('click', () => {
        repayModal.classList.remove('active');
        hideRepayError();
      });
      
      saveRepay.addEventListener('click', handleSaveRepay);

      document.getElementById('sidebarLogout').addEventListener('click', () => {
        localStorage.removeItem('isLoggedIn'); 
        localStorage.removeItem('username'); 
        window.location.href='index.html';
      });
      
      // Enter key in repay amount
      repayAmount.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleSaveRepay();
        }
      });
    });

    function showError(message, details) {
      console.error('ERROR:', message, details || '');
      
      errorContainer.innerHTML = `
        <div class="error-box">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Error</strong>
          </div>
          <div style="margin-bottom: 8px;">${escapeHtml(message)}</div>
          ${details ? `
            <div style="font-size: 0.85rem; color: #666; background: #fff; padding: 8px; border-radius: 4px; border: 1px solid #ddd; margin-top: 8px;">
              <strong>Details:</strong> ${escapeHtml(String(details))}
            </div>
          ` : ''}
          <div style="margin-top: 12px; font-size: 0.9rem; display: flex; gap: 8px;">
            <button onclick="location.reload()" class="btn" style="padding: 6px 12px;">
              <i class="fas fa-sync-alt"></i> Retry
            </button>
            <button onclick="window.history.back()" class="btn" style="padding: 6px 12px;">
              <i class="fas fa-arrow-left"></i> Go Back
            </button>
          </div>
        </div>
      `;
      
      // Hide success message if shown
      successContainer.innerHTML = '';
    }

    function showSuccess(message) {
      successContainer.innerHTML = `
        <div class="success-box">
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-check-circle"></i>
            <strong>Success!</strong>
          </div>
          <div style="margin-top: 8px;">${escapeHtml(message)}</div>
        </div>
      `;
      
      // Clear success after 5 seconds
      setTimeout(() => {
        successContainer.innerHTML = '';
      }, 5000);
    }

    function clearError() {
      errorContainer.innerHTML = '';
    }

    function hideRepayError() {
      repayError.style.display = 'none';
      repayError.textContent = '';
    }

    function showRepayError(message) {
      repayError.textContent = message;
      repayError.style.display = 'block';
    }

    // Safely convert a Firestore Timestamp / string / number to Date
    function toDate(val) {
      if (!val) return null;
      
      // Firestore Timestamp (v8)
      if (val.toDate && typeof val.toDate === 'function') {
        return val.toDate();
      }
      
      // ISO string
      if (typeof val === 'string') {
        const d = new Date(val);
        if (!isNaN(d.getTime())) return d;
      }
      
      // numeric epoch
      if (typeof val === 'number') {
        const d = new Date(val);
        if (!isNaN(d.getTime())) return d;
      }
      
      return null;
    }

    // Format date for display (DD/MM/YYYY, HH:MM)
    function formatDate(date) {
      if (!date) return '';
      const d = toDate(date);
      if (!d) return '';
      return d.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }

    // Format date for table (DD/MM/YYYY, HH:MM)
    function formatDateTime(date) {
      if (!date) return '';
      const d = toDate(date);
      if (!d) return '';
      return d.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }

    // Format number with commas and 2 decimal places
    function fmtNum(n) {
      if (n === null || n === undefined || n === '') return '';
      return Number(n).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // Load loan and its statements with robust fallbacks
    async function loadLoanAndStatements() {
      clearError();
      successContainer.innerHTML = '';
      
      try {
        loadingState.style.display = 'block';
        statementsWrap.innerHTML = '';
        statementsWrap.appendChild(loadingState);

        console.log('Loading loan ID:', loanId);
        
        // Load loan data
        const loanDoc = await db.collection('loans').doc(loanId).get();
        console.log('Loan document exists:', loanDoc.exists);
        
        if (!loanDoc.exists) {
          showError('Loan not found. Please check the loan ID.');
          return;
        }
        
        loan = { id: loanDoc.id, ...loanDoc.data() };
        console.log('Loan loaded:', loan);
        
        // Update UI with loan info
        const loanDisplayId = loan.loanId || loan.id;
        statementTitle.textContent = `Statement - ${loanDisplayId}`;
        
        const total = Number(loan.totalAmount || 0);
        const remaining = Number(loan.remainingAmount || total);
        const paid = total - remaining;
        
        currentBalance = remaining;
        
        loanSummary.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
              <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">Customer</div>
              <div style="font-weight: 600; font-size: 1.1rem;">${escapeHtml(loan.customerName || 'N/A')}</div>
            </div>
            <div>
              <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">Total Loan Amount</div>
              <div style="font-weight: 600; font-size: 1.1rem; color: var(--primary);"> ${fmtNum(total)}</div>
            </div>
            <div>
              <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">Amount Paid</div>
              <div style="font-weight: 600; font-size: 1.1rem; color: #28a745;"> ${fmtNum(paid)}</div>
            </div>
            <div>
              <div style="font-size: 0.85rem; color: #666; margin-bottom: 4px;">Current Balance</div>
              <div style="font-weight: 600; font-size: 1.1rem; color: #dc3545;"> ${fmtNum(remaining)}</div>
            </div>
          </div>
        `;

        // Try multiple approaches to get statements
        let statements = [];
        
        // Approach 1: Try with orderBy (most efficient if index exists)
        try {
          console.log('Trying ordered query...');
          const snapshot = await db.collection('statements')
            .where('loanId', '==', loanId)
            .orderBy('date', 'asc')
            .get();
          
          snapshot.forEach(doc => {
            const data = doc.data();
            statements.push({ 
              id: doc.id, 
              ...data,
              formattedDate: formatDateTime(data.date)
            });
          });
          
          console.log(`Found ${statements.length} statements with orderBy`);
          
        } catch (orderByError) {
          console.warn('OrderBy query failed:', orderByError);
          
          // Approach 2: Try without orderBy
          try {
            console.log('Trying unordered query...');
            const snapshot = await db.collection('statements')
              .where('loanId', '==', loanId)
              .get();
            
            snapshot.forEach(doc => {
              const data = doc.data();
              statements.push({ 
                id: doc.id, 
                ...data,
                formattedDate: formatDateTime(data.date)
              });
            });
            
            // Sort client-side by date (oldest first)
            statements.sort((a, b) => {
              const dateA = toDate(a.date) || new Date(0);
              const dateB = toDate(b.date) || new Date(0);
              return dateA - dateB;
            });
            
            console.log(`Found ${statements.length} statements without orderBy`);
            
          } catch (simpleError) {
            console.error('Both queries failed:', simpleError);
            showError('Could not load statements. Please check your connection.', simpleError.message);
          }
        }

        // CRITICAL FIX: If no statements exist, create the initial loan disbursement statement
        if (statements.length === 0) {
          console.log('No statements found, checking if loan disbursement statement needs to be created...');
          
          // Check if this is a new loan that needs an initial statement
          if (loan.totalAmount && loan.totalAmount > 0) {
            console.log('Creating initial loan disbursement statement...');
            
            // Create the initial statement for loan disbursement
            const initialStatement = {
              loanId: loanId,
              date: loan.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
              reference: `Loan Disbursement - ${loanDisplayId}`,
              dr: 0,  // No debit for loan issue
              cr: Number(loan.totalAmount || 0),  // Credit for loan amount issued
              balance: Number(loan.totalAmount || 0),  // Initial balance equals total
              createdBy: currentUser,
              transactionType: 'loan_issue'
            };
            
            try {
              // Add the initial statement to Firestore
              await db.collection('statements').add(initialStatement);
              console.log('Initial loan disbursement statement created');
              
              // Reload statements after creation
              await loadLoanAndStatements();
              return;
            } catch (createError) {
              console.error('Failed to create initial statement:', createError);
              // Continue to render with empty statements
            }
          }
        }

        // Render statements
        if (statements.length === 0) {
          renderNoStatements();
        } else {
          renderStatements(statements);
        }

      } catch (err) {
        console.error('Load error:', err);
        showError('Error loading statement data. Please try again.', err.message || err);
      } finally {
        loadingState.style.display = 'none';
      }
    }

    function renderNoStatements() {
      statementsWrap.innerHTML = `
        <div style="padding: 40px; text-align: center; color: #666;">
          <i class="fas fa-file-alt fa-4x" style="margin-bottom: 20px; opacity: 0.3;"></i>
          <div style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 500;">No statement entries found</div>
          <div style="font-size: 0.95rem; margin-bottom: 25px; max-width: 400px; margin-left: auto; margin-right: auto;">
            This loan doesn't have any transactions recorded yet.
          </div>
          <button class="btn btn-primary" onclick="openRepayModal()" style="padding: 10px 20px;">
            <i class="fas fa-plus"></i> Record First Repayment
          </button>
        </div>`;
    }

    function renderStatements(statements) {
      let html = `
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Reference</th>
                <th>Transaction Type</th>
                <th>Debit </th>
                <th>Credit </th>
                <th>Balance</th>
              </tr>
            </thead>
            <tbody>`;
      
      statements.forEach((stmt, index) => {
        const isLast = index === statements.length - 1;
        const rowClass = isLast ? 'style="background-color: #f0f8ff;"' : '';
        
        // Determine transaction type
        let transactionType = 'Adjustment';
        let typeColor = '#6c757d';
        
        if (stmt.dr > 0 && stmt.cr === 0) {
          transactionType = 'Payment';
          typeColor = '#28a745';
        } else if (stmt.cr > 0 && stmt.dr === 0) {
          transactionType = 'Loan Issue';
          typeColor = 'var(--primary)';
        } else if (stmt.dr > 0 && stmt.cr > 0) {
          transactionType = 'Transfer';
          typeColor = '#ff9800';
        }
        
        // Format amounts - show blank instead of "-" for zero/empty values
        const debitAmount = stmt.dr && stmt.dr > 0 ? ` ${fmtNum(stmt.dr)}` : '';
        const creditAmount = stmt.cr && stmt.cr > 0 ? ` ${fmtNum(stmt.cr)}` : '';
        
        html += `
          <tr ${rowClass}>
            <td>${escapeHtml(stmt.formattedDate || formatDateTime(stmt.date) || '')}</td>
            <td>${escapeHtml(stmt.reference || '')}</td>
            <td><span style="color: ${typeColor}; font-weight: 500;">${transactionType}</span></td>
            <td style="color: #28a745; font-weight: 500;">${debitAmount}</td>
            <td style="color: var(--primary); font-weight: 500;">${creditAmount}</td>
            <td style="font-weight: 600; color: ${Number(stmt.balance || 0) === 0 ? '#28a745' : '#dc3545'};"> ${fmtNum(stmt.balance || 0)}</td>
          </tr>`;
      });
      
      html += `</tbody></table>
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
          <button class="btn" onclick="exportToPDF()" style="background: #6c757d;">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button class="btn btn-primary" onclick="openRepayModal()">
            <i class="fas fa-money-bill-wave"></i> Record New Repayment
          </button>
        </div>`;
      
      statementsWrap.innerHTML = html;
    }

    // Open repay modal
    function openRepayModal() {
      if (!loan) { 
        showError('Loan data not loaded. Please refresh the page.');
        return; 
      }
      
      const loanDisplayId = loan.loanId || loan.id;
      repayLoanRef.textContent = `${loanDisplayId} — ${loan.customerName || 'Customer'}`;
      currentBalanceInfo.textContent = `Current Balance:  ${fmtNum(currentBalance)}`;
      
      repayAmount.value = '';
      repayAmount.focus();
      repayDate.value = new Date().toISOString().split('T')[0];
      repayNotes.value = '';
      hideRepayError();
      
      repayModal.classList.add('active');
    }

    // Save repayment: creates payment record, statement (dr) and updates loan (ZMW)
    async function handleSaveRepay() {
      const amt = parseFloat(repayAmount.value);
      const date = repayDate.value;
      const notes = repayNotes.value.trim();
      
      // Validation
      if (!amt || amt <= 0) { 
        showRepayError('Please enter a valid amount (greater than 0).');
        return; 
      }
      
      if (amt > currentBalance) {
        showRepayError(`Amount cannot exceed current balance of ZMW ${fmtNum(currentBalance)}`);
        return;
      }
      
      if (!date) {
        showRepayError('Please select a payment date.');
        return;
      }

      saveRepay.disabled = true;
      saveRepay.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

      try {
        const newBalance = Math.max(0, currentBalance - amt);
        console.log('Processing repayment:', { amount: amt, currentBalance, newBalance });

        // Create payment record
        const payment = {
          loanId,
          amount: amt,
          paymentDate: date,
          notes: notes || '',
          createdBy: currentUser,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        console.log('Adding payment record...');
        await db.collection('payments').add(payment);

        // Create statement entry (dr for repayment)
        const stmt = {
          loanId,
          date: firebase.firestore.FieldValue.serverTimestamp(),
          reference: notes || `Payment - ${loan.loanId || loan.id}`,
          dr: Number(amt),
          cr: 0,
          balance: Number(newBalance),
          createdBy: currentUser,
          transactionType: 'repayment'
        };
        
        console.log('Adding statement record...');
        await db.collection('statements').add(stmt);

        // Update loan document
        const loanRef = db.collection('loans').doc(loanId);
        const newPaid = Number(loan.paidAmount || 0) + Number(amt);
        const newRemaining = Math.max(0, Number(loan.totalAmount || 0) - newPaid);
        const newStatus = newRemaining <= 0 ? 'paid' : 'active';
        
        console.log('Updating loan document...');
        await loanRef.update({
          paidAmount: newPaid,
          remainingAmount: newRemaining,
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update local loan object
        loan.paidAmount = newPaid;
        loan.remainingAmount = newRemaining;
        loan.status = newStatus;
        currentBalance = newRemaining;

        // Reload view
        await loadLoanAndStatements();
        
        // Close modal and show success
        repayModal.classList.remove('active');
        showSuccess(`Repayment of ${fmtNum(amt)} recorded successfully!`);
        
      } catch (err) {
        console.error('Error saving repayment:', err);
        showRepayError(`Error: ${err.message || 'Failed to save repayment. Please try again.'}`);
      } finally {
        saveRepay.disabled = false;
        saveRepay.innerHTML = '<i class="fas fa-check"></i> Save Repayment';
      }
    }

    // Export to PDF (placeholder function)
    function exportToPDF() {
      alert('PDF export feature would be implemented here. For now, you can print the page using Ctrl+P.');
      // window.print(); // Uncomment to enable printing
    }

    // Utility function to escape HTML
    function escapeHtml(text) {
      if (text === undefined || text === null) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Make functions available globally for onclick handlers
    window.openRepayModal = openRepayModal;
    window.exportToPDF = exportToPDF;
  </script>
</body>
</html>