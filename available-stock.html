<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trismart — Available Stock (HQ)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#0f1220;
      --panel:#191b2a;
      --accent:#ffcc00;
      --muted:#b8b8cc;
      --card:#27293d;
      --radius:12px;
      --glass: rgba(255,255,255,0.03);
      --danger:#f44336;
      --success:#4caf50;
      --info:#2196f3;
      --warning:#ff9800;
      --sidebar-width: 350px;
      --sidebar-collapsed: 60px;
      --transition: all 0.3s ease;
    }
    *{box-sizing:border-box; margin:0; padding:0}
    body{
      margin:0;
      min-height:100vh;
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--bg) 0%, #23263b 100%);
      color:#fff;
      display:flex;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--panel);
      border-right: 1px solid rgba(255,255,255,0.04);
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      height: 100vh;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .sidebar.collapsed {
      width: var(--sidebar-collapsed);
    }

    .sidebar-header {
      padding: 18px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 70px;
    }

    .sidebar-header h2 {
      font-size: 1.1rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      transition: var(--transition);
    }

    .sidebar.collapsed .sidebar-header h2 {
      opacity: 0;
      width: 0;
    }

    .toggle-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.06);
      color: var(--muted);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .toggle-btn:hover {
      background: rgba(255,255,255,0.05);
    }

    .sidebar-content {
      padding: 18px;
      flex: 1;
      overflow-y: auto;
      transition: var(--transition);
    }

    .sidebar.collapsed .sidebar-content {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar-footer {
      padding: 18px;
      border-top: 1px solid rgba(255,255,255,0.04);
      transition: var(--transition);
    }

    .sidebar.collapsed .sidebar-footer {
      opacity: 0;
      pointer-events: none;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      height: 100vh;
      transition: var(--transition);
    }

    .container{
      width:100%;
      max-width:1400px;
      background:var(--panel);
      border-radius:var(--radius);
      padding:18px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
      margin: 0 auto;
    }

    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px; margin-bottom: 24px;}
    h1{margin:0;font-size:1.25rem}
    .small{color:var(--muted); font-size: 0.9rem;}
    .controls{display:flex;gap:8px;align-items:center; flex-wrap: wrap;}

    .btn{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:#111;font-weight:700;cursor:pointer; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.success{background:var(--success);color:#fff}
    .btn.info{background:var(--info);color:#fff}
    .btn.warning{background:var(--warning);color:#fff}
    .input{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff; width: 100%;}

    .layout{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    label{display:block;color:var(--muted);font-size:0.9rem;margin-top:12px; margin-bottom: 4px;}
    input[type="text"], input[type="number"], select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}

    .table-wrap{overflow:auto;max-height:640px;margin-top:8px;border-radius:8px}
    table{width:100%;border-collapse:collapse;font-size:0.95rem}
    th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.04)}
    th{color:var(--muted);font-weight:700;position:sticky;top:0;background:linear-gradient(180deg,var(--panel),transparent);z-index:1}
    td.actions{display:flex;gap:8px;align-items:center; flex-wrap: wrap;}

    .badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);font-weight:700;font-size:0.8rem; display: inline-block;}
    .badge.success{background:rgba(76, 175, 80, 0.1);color:#4caf50}
    .badge.danger{background:rgba(244, 67, 54, 0.1);color:#f44336}
    .badge.info{background:rgba(33, 150, 243, 0.1);color:#2196f3}
    .badge.warning{background:rgba(255, 152, 0, 0.1);color:#ff9800}

    .empty{color:var(--muted);padding:18px;text-align:center}

    /* modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:all .18s;z-index:2000}
    .modal-overlay.show{visibility:visible;opacity:1}
    .modal{width:100%;max-width:800px;background:var(--panel);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);max-height:90vh;overflow-y:auto}
    .modal h3{margin:0 0 8px 0}

    /* Form sections */
    .form-section {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }

    .form-section h3 {
      margin: 0 0 12px 0;
      font-size: 1rem;
    }

    .transfer-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:6px;margin-bottom:4px}
    .transfer-item:hover{background:rgba(255,255,255,0.03)}

    .tab-buttons{display:flex;gap:4px;margin-bottom:12px}
    .tab-btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer; flex: 1; text-align: center;}
    .tab-btn.active{background:var(--accent);color:#111;border-color:var(--accent)}

    /* Navigation items in collapsed sidebar */
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      color: var(--muted);
      text-decoration: none;
      transition: var(--transition);
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.03);
      color: #fff;
    }

    .nav-item.active {
      background: rgba(255,255,255,0.05);
      color: var(--accent);
      border-left-color: var(--accent);
    }

    .sidebar.collapsed .nav-item {
      justify-content: center;
      padding: 12px;
    }

    .sidebar.collapsed .nav-item span {
      display: none;
    }

    .nav-item i {
      font-size: 1.1rem;
      min-width: 20px;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      
      .sidebar.collapsed {
        width: 100%;
        height: 60px;
      }
      
      .sidebar-content, .sidebar-footer {
        display: none;
      }
      
      .sidebar.collapsed .sidebar-content,
      .sidebar.collapsed .sidebar-footer {
        display: none;
      }
      
      .main-content {
        height: auto;
        padding: 16px;
      }
      
      .controls {
        justify-content: center;
      }
      
      .btn span {
        display: none;
      }
      
      .btn i {
        margin: 0;
      }
    }

    @media (max-width: 480px) {
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .btn {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Trismart HQ</h2>
      <button class="toggle-btn" id="toggleSidebar">
        <i class="fas fa-chevron-left"></i>
      </button>
    </div>
    
    <div class="sidebar-content">
      <a href="sales-dashboard.html" class="nav-item">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Dashboard</span>
      </a>
      
      <div class="form-section">
        <h3><i class="fas fa-plus-circle"></i> Add Product</h3>
        <div class="small">Add new product to HQ stock</div>
        
        <label for="p_code">Code (SKU)</label>
        <input id="p_code" type="text" placeholder="e.g. PRD-001" />
        
        <label for="p_name">Product name</label>
        <input id="p_name" type="text" placeholder="Product name" />
        
        <label for="p_qty">Quantity</label>
        <input id="p_qty" type="number" min="0" value="1" />
        
        <label for="p_price">Unit price</label>
        <input id="p_price" type="number" step="0.01" min="0" value="0.00" />
        
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="btnAddProduct"><i class="fas fa-plus-circle"></i> Add</button>
          <button class="btn ghost" id="btnClearForm">Clear</button>
        </div>
      </div>
      
      <div class="form-section">
        <h3><i class="fas fa-exchange-alt"></i> Quick Transfer</h3>
        <div class="small">Transfer to user warehouse</div>
        
        <label for="t_user">Select User</label>
        <select id="t_user" class="input">
          <option value="">-- Select User --</option>
        </select>
        
        <label for="t_product">Select Product</label>
        <select id="t_product" class="input">
          <option value="">-- Select Product --</option>
        </select>
        
        <label for="t_qty">Quantity</label>
        <input id="t_qty" type="number" min="1" value="1" />
        
        <button class="btn info full-width" id="btnQuickTransfer" style="margin-top: 12px;">
          <i class="fas fa-exchange-alt"></i> Transfer Now
        </button>
      </div>
    </div>
    
    <div class="sidebar-footer">
      <div class="small" style="text-align: center;">
        Only admin can add/edit products
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="container">
      <div class="topbar">
        <div>
          <h1>Available Stock (HQ)</h1>
          <div class="small">Manage products in HQ inventory — code, name, qty and price.</div>
        </div>
        
        <div class="controls">
          <div id="currentUser" class="small" style="margin-right:8px">–</div>
          <button class="btn ghost" id="btnExport"><i class="fas fa-file-export"></i> <span>Export</span></button>
          <button class="btn warning" id="btnOpenHistory"><i class="fas fa-history"></i> <span>History</span></button>
          <button class="btn success" id="btnOpenGRV"><i class="fas fa-boxes"></i> <span>GRV Restock</span></button>
          <button class="btn info" id="btnOpenTransfer"><i class="fas fa-exchange-alt"></i> <span>Transfer</span></button>
          <button class="btn" id="btnOpenAddModal"><i class="fas fa-plus"></i> <span>Add Product</span></button>
          <button class="btn ghost" id="btnSignOut"><i class="fas fa-sign-out-alt"></i></button>
        </div>
      </div>
      
      <!-- Products Table -->
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center; margin-bottom: 16px;">
          <strong>HQ Products</strong>
          <div style="display:flex;gap:8px;align-items:center; flex-wrap: wrap;">
            <input id="searchInput" class="input" placeholder="Search code or name" style="width: 200px;" />
            <select id="sortSelect" class="input" style="width:150px">
              <option value="code">Sort: Code</option>
              <option value="name">Sort: Name</option>
              <option value="stock_desc">Sort: Stock ↓</option>
              <option value="stock_asc">Sort: Stock ↑</option>
            </select>
          </div>
        </div>
        
        <div class="table-wrap" id="tableWrap">
          <table aria-label="Products">
            <thead>
              <tr>
                <th style="width:110px">Code</th>
                <th>Product name</th>
                <th style="width:110px">Qty</th>
                <th style="width:120px">Price</th>
                <th style="width:250px">Actions</th>
              </tr>
            </thead>
            <tbody id="productsBody">
              <tr><td colspan="5" class="empty">Loading products…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="modal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3>Edit product</h3>
      
      <label for="m_code">Code</label>
      <input id="m_code" type="text" />
      
      <label for="m_name">Name</label>
      <input id="m_name" type="text" />
      
      <label for="m_qty">Quantity</label>
      <input id="m_qty" type="number" min="0" />
      
      <label for="m_price">Unit price</label>
      <input id="m_price" type="number" step="0.01" min="0" />
      
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" id="modalCancel">Cancel</button>
        <button class="btn" id="modalSave">Save changes</button>
      </div>
    </div>
  </div>

  <!-- Quick Transfer Modal -->
  <div id="transferModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3>Bulk Transfer</h3>
      <div class="small">Transfer multiple products at once</div>
      
      <div style="margin-top: 16px;">
        <label for="bulk_t_user">Select User</label>
        <select id="bulk_t_user" class="input">
          <option value="">-- Select User --</option>
        </select>
        
        <div id="bulkTransferItems" style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; min-height: 100px;">
          <div class="empty">No products added for transfer</div>
        </div>
        
        <div style="margin-top: 12px; display: flex; gap: 8px;">
          <button class="btn info" id="btnAddBulkItem"><i class="fas fa-plus"></i> Add Product</button>
          <button class="btn ghost" id="btnClearBulk">Clear All</button>
        </div>
      </div>
      
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" id="transferModalCancel">Cancel</button>
        <button class="btn success" id="btnProcessBulkTransfer"><i class="fas fa-check"></i> Process Transfer</button>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="addModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3>Add New Product</h3>
      
      <label for="add_p_code">Code (SKU)</label>
      <input id="add_p_code" type="text" placeholder="e.g. PRD-001" />
      
      <label for="add_p_name">Product name</label>
      <input id="add_p_name" type="text" placeholder="Product name" />
      
      <label for="add_p_qty">Initial Quantity</label>
      <input id="add_p_qty" type="number" min="0" value="1" />
      
      <label for="add_p_price">Unit price</label>
      <input id="add_p_price" type="number" step="0.01" min="0" value="0.00" />
      
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" id="addModalCancel">Cancel</button>
        <button class="btn" id="btnAddProductModal"><i class="fas fa-plus-circle"></i> Add Product</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    onSnapshot,
    addDoc,
    doc,
    updateDoc,
    deleteDoc,
    runTransaction,
    serverTimestamp,
    getDocs,
    where,
    writeBatch,
    getDoc
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
    authDomain: "trismart-online-app.firebaseapp.com",
    projectId: "trismart-online-app",
    storageBucket: "trismart-online-app.firebasestorage.app",
    messagingSenderId: "867677912389",
    appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
    measurementId: "G-KEWDREKNDB"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Elements
  const sidebar = document.getElementById('sidebar');
  const toggleSidebar = document.getElementById('toggleSidebar');
  const mainContent = document.getElementById('mainContent');
  const currentUserEl = document.getElementById('currentUser');
  const btnSignOut = document.getElementById('btnSignOut');
  const btnOpenHistory = document.getElementById('btnOpenHistory');
  const btnOpenTransfer = document.getElementById('btnOpenTransfer');
  const btnOpenAddModal = document.getElementById('btnOpenAddModal');
  const btnOpenGRV = document.getElementById('btnOpenGRV'); // New GRV button
  const btnAddProduct = document.getElementById('btnAddProduct');
  const btnClearForm = document.getElementById('btnClearForm');
  const btnExport = document.getElementById('btnExport');
  const btnQuickTransfer = document.getElementById('btnQuickTransfer');
  
  // Modal elements
  const modal = document.getElementById('modal');
  const m_code = document.getElementById('m_code');
  const m_name = document.getElementById('m_name');
  const m_qty = document.getElementById('m_qty');
  const m_price = document.getElementById('m_price');
  const modalCancel = document.getElementById('modalCancel');
  const modalSave = document.getElementById('modalSave');
  
  // Add modal elements
  const addModal = document.getElementById('addModal');
  const add_p_code = document.getElementById('add_p_code');
  const add_p_name = document.getElementById('add_p_name');
  const add_p_qty = document.getElementById('add_p_qty');
  const add_p_price = document.getElementById('add_p_price');
  const addModalCancel = document.getElementById('addModalCancel');
  const btnAddProductModal = document.getElementById('btnAddProductModal');
  
  // Transfer modal elements
  const transferModal = document.getElementById('transferModal');
  const bulk_t_user = document.getElementById('bulk_t_user');
  const bulkTransferItems = document.getElementById('bulkTransferItems');
  const btnAddBulkItem = document.getElementById('btnAddBulkItem');
  const btnClearBulk = document.getElementById('btnClearBulk');
  const transferModalCancel = document.getElementById('transferModalCancel');
  const btnProcessBulkTransfer = document.getElementById('btnProcessBulkTransfer');

  // Table elements
  const productsBody = document.getElementById('productsBody');
  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');
  
  // Sidebar form elements
  const p_code = document.getElementById('p_code');
  const p_name = document.getElementById('p_name');
  const p_qty = document.getElementById('p_qty');
  const p_price = document.getElementById('p_price');
  const t_user = document.getElementById('t_user');
  const t_product = document.getElementById('t_product');
  const t_qty = document.getElementById('t_qty');

  // Admin
  const ADMIN_EMAIL = 'chrischishe@gmail.com';

  let currentUser = null;
  let isAdmin = false;
  let productsSnapshotUnsub = null;
  let productsCache = [];
  let usersCache = [];
  let bulkTransferList = [];

  // Helpers
  function formatMoney(v) { return '$' + Number(v || 0).toFixed(2); }
  function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // Toggle sidebar
  toggleSidebar.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    const icon = toggleSidebar.querySelector('i');
    if (sidebar.classList.contains('collapsed')) {
      icon.className = 'fas fa-chevron-right';
    } else {
      icon.className = 'fas fa-chevron-left';
    }
  });

  // Load users for transfer
  async function loadUsers() {
    const q = query(collection(db, 'users'), where('email', '!=', ADMIN_EMAIL));
    const snapshot = await getDocs(q);
    usersCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    
    // Clear and populate user dropdowns
    t_user.innerHTML = '<option value="">-- Select User --</option>';
    bulk_t_user.innerHTML = '<option value="">-- Select User --</option>';
    
    usersCache.forEach(user => {
      const option1 = document.createElement('option');
      option1.value = user.email;
      option1.textContent = `${user.email} (${user.displayName || 'User'})`;
      t_user.appendChild(option1);
      
      const option2 = document.createElement('option');
      option2.value = user.email;
      option2.textContent = `${user.email} (${user.displayName || 'User'})`;
      bulk_t_user.appendChild(option2);
    });
  }

  // Auth guard
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;
    currentUserEl.textContent = user.email;
    isAdmin = (user.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase();

    // Adjust UI for non-admins
    if (!isAdmin) {
      sidebar.style.display = 'none';
      document.querySelectorAll('.btn').forEach(btn => {
        if (btn.id !== 'btnSignOut' && btn.id !== 'btnOpenHistory') {
          btn.style.display = 'none';
        }
      });
    } else {
      loadUsers();
    }

    attachProductsListener();
  });

  // Attach real-time listener for products
  function attachProductsListener() {
    if (productsSnapshotUnsub) productsSnapshotUnsub();
    const q = query(collection(db, 'products'), orderBy('code'));
    productsSnapshotUnsub = onSnapshot(q, snap => {
      productsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderProducts();
      
      // Update product dropdowns
      if (isAdmin) {
        updateProductDropdown();
      }
    }, err => {
      console.error('products snapshot error', err);
      productsBody.innerHTML = `<tr><td colspan="5" class="empty">Error loading products</td></tr>`;
    });
  }

  // Update product dropdown for transfer
  function updateProductDropdown() {
    t_product.innerHTML = '<option value="">-- Select Product --</option>';
    productsCache.forEach(product => {
      if (product.stock > 0) {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.code} - ${product.name} (Stock: ${product.stock})`;
        t_product.appendChild(option);
      }
    });
  }

  // Render products table
  function renderProducts() {
    const filter = (searchInput.value || '').trim().toLowerCase();
    let list = productsCache.slice();

    // apply sort
    const sort = sortSelect.value;
    if (sort === 'name') list.sort((a,b) => (a.name||'').localeCompare(b.name||''));
    else if (sort === 'stock_desc') list.sort((a,b) => (b.stock||0) - (a.stock||0));
    else if (sort === 'stock_asc') list.sort((a,b) => (a.stock||0) - (b.stock||0));
    else list.sort((a,b) => (a.code||'').localeCompare(b.code||''));

    // apply filter
    if (filter) {
      list = list.filter(p => (p.code||'').toLowerCase().includes(filter) || (p.name||'').toLowerCase().includes(filter));
    }

    if (!list.length) {
      productsBody.innerHTML = '<tr><td colspan="5" class="empty">No products found.</td></tr>';
      return;
    }

    productsBody.innerHTML = '';
    list.forEach(p => {
      const tr = document.createElement('tr');
      let actionsHtml = '';
      if (isAdmin) {
        actionsHtml = `
          <button class="btn ghost" data-action="increase" data-id="${p.id}" title="Increase stock"><i class="fas fa-plus"></i></button>
          <button class="btn ghost" data-action="decrease" data-id="${p.id}" title="Decrease stock"><i class="fas fa-minus"></i></button>
          <button class="btn ghost" data-action="edit" data-id="${p.id}"><i class="fas fa-edit"></i> Edit</button>
          <button class="btn danger" data-action="delete" data-id="${p.id}"><i class="fas fa-trash"></i></button>
        `;
      } else {
        actionsHtml = `<span class="badge">View Only</span>`;
      }

      tr.innerHTML = `
        <td>${escapeHtml(p.code || '')}</td>
        <td>${escapeHtml(p.name || '')}</td>
        <td>${Number(p.stock || 0)}</td>
        <td>${formatMoney(p.price || 0)}</td>
        <td class="actions">${actionsHtml}</td>
      `;
      productsBody.appendChild(tr);
    });
  }

  // Table actions
  productsBody.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    if (!action || !id) return;

    if (!isAdmin) return alert('Not authorized');

    const product = productsCache.find(p => p.id === id);
    if (!product) return alert('Product not found');

    if (action === 'edit') {
      openEditModal(product);
    } else if (action === 'increase' || action === 'decrease') {
      const deltaSign = action === 'increase' ? 1 : -1;
      const qtyStr = prompt(`Change stock for ${product.name} (current: ${product.stock || 0}). Enter number to ${deltaSign>0 ? 'add' : 'subtract'}:`, '1');
      if (!qtyStr) return;
      const change = Number(qtyStr);
      if (!Number.isFinite(change) || change === 0) return alert('Invalid amount');
      await changeStock(product.id, change * deltaSign);
    } else if (action === 'delete') {
      if (!confirm(`Delete product ${product.name}? This cannot be undone.`)) return;
      try {
        await deleteDoc(doc(db, 'products', id));
        alert('Deleted');
      } catch (err) {
        console.error('delete error', err);
        alert('Delete failed. See console.');
      }
    }
  });

  // Change stock with transaction
  async function changeStock(productId, delta) {
    const ref = doc(db, 'products', productId);
    try {
      await runTransaction(db, async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists()) throw new Error('Product no longer exists');
        const cur = snap.data();
        const currentStock = Number(cur.stock || 0);
        const newStock = currentStock + Number(delta);
        if (newStock < 0) throw new Error('Resulting stock would be negative');
        tx.update(ref, { stock: newStock, updatedAt: serverTimestamp() });
      });
    } catch (err) {
      console.error('changeStock error', err);
      alert(err.message || 'Failed to change stock');
    }
  }

  // Modal functions
  function openEditModal(product) {
    if (!isAdmin) return;
    m_code.value = product.code || '';
    m_name.value = product.name || '';
    m_qty.value = Number(product.stock || 0);
    m_price.value = Number(product.price || 0).toFixed(2);
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    modalSave.dataset.id = product.id;
  }

  modalCancel.addEventListener('click', () => closeModal());
  function closeModal() {
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    delete modalSave.dataset.id;
  }

  modalSave.addEventListener('click', async () => {
    if (!isAdmin) return;
    const id = modalSave.dataset.id;
    if (!id) return closeModal();
    const code = (m_code.value || '').trim();
    const name = (m_name.value || '').trim();
    const stock = Number(m_qty.value) || 0;
    const price = Number(m_price.value) || 0;

    if (!code || !name) return alert('Code and name are required');
    if (stock < 0) return alert('Stock cannot be negative');

    try {
      await updateDoc(doc(db, 'products', id), {
        code, name, stock, price, updatedAt: serverTimestamp()
      });
      closeModal();
    } catch (err) {
      console.error('modal save err', err);
      alert('Failed to save changes');
    }
  });

  // Add Product from sidebar
  btnAddProduct.addEventListener('click', async () => {
    if (!isAdmin) return alert('Not authorized');
    const code = (p_code.value || '').trim();
    const name = (p_name.value || '').trim();
    const stock = Number(p_qty.value) || 0;
    const price = Number(p_price.value) || 0;

    if (!code) return alert('Product code is required');
    if (!name) return alert('Product name is required');
    if (stock < 0) return alert('Quantity must be 0 or greater');
    if (price < 0) return alert('Price must be 0 or greater');

    try {
      const existing = productsCache.find(x => (x.code || '').toLowerCase() === code.toLowerCase());
      if (existing) {
        const ref = doc(db, 'products', existing.id);
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(ref);
          if (!snap.exists()) throw new Error('Product no longer exists');
          const cur = snap.data();
          const newStock = (Number(cur.stock || 0) + stock);
          tx.update(ref, { stock: newStock, price, updatedAt: serverTimestamp() });
        });
        alert('Product updated (stock incremented)');
      } else {
        await addDoc(collection(db, 'products'), {
          code, name, stock, price,
          createdBy: currentUser.uid,
          createdAt: serverTimestamp()
        });
        alert('Product added');
      }
      btnClearForm.click();
    } catch (err) {
      console.error('add product error', err);
      alert('Failed to add/update product. See console.');
    }
  });

  btnClearForm.addEventListener('click', () => {
    p_code.value = ''; p_name.value = ''; p_qty.value = 1; p_price.value = '0.00';
  });

  // Quick Transfer from sidebar
  btnQuickTransfer.addEventListener('click', async () => {
    if (!isAdmin) return alert('Not authorized');
    const userId = t_user.value;
    const productId = t_product.value;
    const qty = parseInt(t_qty.value) || 0;

    if (!userId) return alert('Please select a user');
    if (!productId) return alert('Please select a product');
    if (qty <= 0) return alert('Please enter a valid quantity');

    const product = productsCache.find(p => p.id === productId);
    const user = usersCache.find(u => u.email === userId);

    if (!product || !user) return alert('Invalid selection');

    if (qty > product.stock) {
      alert(`Not enough stock. Available: ${product.stock}, Requested: ${qty}`);
      return;
    }

    if (!confirm(`Transfer ${qty} units of ${product.name} to ${user.email}?`)) return;

    try {
      const batch = writeBatch(db);
      const transfersRef = collection(db, 'transfers');

      // Create transfer record
      const transferData = {
        type: 'outgoing',
        productId: product.id,
        productCode: product.code,
        productName: product.name,
        fromUserId: currentUser.uid,
        fromUserEmail: currentUser.email,
        toUserEmail: user.email,
        quantity: qty,
        price: product.price,
        total: product.price * qty,
        status: 'completed',
        createdAt: serverTimestamp(),
        transferDate: new Date().toISOString()
      };

      const transferDoc = doc(transfersRef);
      batch.set(transferDoc, transferData);

      // Reduce HQ stock
      const productRef = doc(db, 'products', product.id);
      const newStock = product.stock - qty;
      batch.update(productRef, {
        stock: newStock,
        updatedAt: serverTimestamp()
      });

      // Update user warehouse
      const userProductId = `${user.email.replace(/[^a-zA-Z0-9]/g, '_')}_${product.id}`;
      const userProductRef = doc(db, 'userWarehouse', userProductId);
      
      let currentUserStock = 0;
      try {
        const userProductSnap = await getDoc(userProductRef);
        if (userProductSnap.exists()) {
          currentUserStock = userProductSnap.data().warehouseStock || 0;
        }
      } catch (err) {
        console.log('No existing stock found');
      }
      
      const newUserStock = currentUserStock + qty;
      
      batch.set(userProductRef, {
        userEmail: user.email,
        productId: product.id,
        productCode: product.code,
        productName: product.name,
        price: product.price,
        warehouseStock: newUserStock,
        lastUpdated: serverTimestamp(),
        lastTransferDate: new Date().toISOString()
      }, { merge: true });

      await batch.commit();
      
      alert(`Successfully transferred ${qty} units to ${user.email}!`);
      
      // Reset form
      t_qty.value = '1';
      
    } catch (err) {
      console.error('Transfer error:', err);
      alert('Failed to process transfer: ' + err.message);
    }
  });

  // Open modals
  btnOpenAddModal.addEventListener('click', () => {
    if (!isAdmin) return alert('Not authorized');
    addModal.classList.add('show');
    addModal.setAttribute('aria-hidden', 'false');
  });

  btnOpenTransfer.addEventListener('click', () => {
    if (!isAdmin) return alert('Not authorized');
    transferModal.classList.add('show');
    transferModal.setAttribute('aria-hidden', 'false');
    updateBulkTransferDisplay();
  });

  btnOpenHistory.addEventListener('click', () => {
    window.open('history.html', '_blank');
  });

  // NEW: Open GRV system
  btnOpenGRV.addEventListener('click', () => {
    if (!isAdmin) return alert('Not authorized');
    window.open('Restock.html', '_blank');
  });

  // Add Product Modal
  addModalCancel.addEventListener('click', () => {
    addModal.classList.remove('show');
    addModal.setAttribute('aria-hidden', 'true');
  });

  btnAddProductModal.addEventListener('click', async () => {
    if (!isAdmin) return;
    const code = (add_p_code.value || '').trim();
    const name = (add_p_name.value || '').trim();
    const stock = Number(add_p_qty.value) || 0;
    const price = Number(add_p_price.value) || 0;

    if (!code) return alert('Product code is required');
    if (!name) return alert('Product name is required');
    if (stock < 0) return alert('Quantity must be 0 or greater');
    if (price < 0) return alert('Price must be 0 or greater');

    try {
      const existing = productsCache.find(x => (x.code || '').toLowerCase() === code.toLowerCase());
      if (existing) {
        alert('A product with this code already exists');
        return;
      }

      await addDoc(collection(db, 'products'), {
        code, name, stock, price,
        createdBy: currentUser.uid,
        createdAt: serverTimestamp()
      });
      
      alert('Product added successfully!');
      addModal.classList.remove('show');
      addModal.setAttribute('aria-hidden', 'true');
      
      // Reset form
      add_p_code.value = '';
      add_p_name.value = '';
      add_p_qty.value = 1;
      add_p_price.value = '0.00';
      
    } catch (err) {
      console.error('add product error', err);
      alert('Failed to add product. See console.');
    }
  });

  // Bulk Transfer Modal
  transferModalCancel.addEventListener('click', () => {
    transferModal.classList.remove('show');
    transferModal.setAttribute('aria-hidden', 'true');
  });

  btnAddBulkItem.addEventListener('click', () => {
    if (!bulk_t_user.value) {
      alert('Please select a user first');
      return;
    }
    
    // Create a dialog to add product to bulk transfer
    const productSelect = document.createElement('select');
    productSelect.className = 'input';
    productSelect.innerHTML = '<option value="">-- Select Product --</option>';
    productsCache.forEach(product => {
      if (product.stock > 0) {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.code} - ${product.name} (Stock: ${product.stock})`;
        productSelect.appendChild(option);
      }
    });
    
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number';
    qtyInput.className = 'input';
    qtyInput.min = '1';
    qtyInput.value = '1';
    qtyInput.placeholder = 'Quantity';
    
    const addButton = document.createElement('button');
    addButton.className = 'btn info';
    addButton.innerHTML = '<i class="fas fa-plus"></i> Add';
    
    const dialogDiv = document.createElement('div');
    dialogDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 3000;';
    
    const dialogContent = document.createElement('div');
    dialogContent.style.cssText = 'background: var(--panel); padding: 20px; border-radius: 10px; width: 300px;';
    dialogContent.innerHTML = '<h4 style="margin: 0 0 12px 0;">Add Product to Transfer</h4>';
    
    dialogContent.appendChild(document.createTextNode('Product:'));
    dialogContent.appendChild(productSelect);
    dialogContent.appendChild(document.createTextNode('Quantity:'));
    dialogContent.appendChild(qtyInput);
    
    const buttonDiv = document.createElement('div');
    buttonDiv.style.cssText = 'margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn ghost';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = () => document.body.removeChild(dialogDiv);
    
    addButton.onclick = () => {
      const productId = productSelect.value;
      const qty = parseInt(qtyInput.value) || 0;
      
      if (!productId) {
        alert('Please select a product');
        return;
      }
      
      if (qty <= 0) {
        alert('Please enter a valid quantity');
        return;
      }
      
      const product = productsCache.find(p => p.id === productId);
      if (!product) return;
      
      // Check stock
      if (qty > product.stock) {
        alert(`Not enough stock. Available: ${product.stock}`);
        return;
      }
      
      // Add to bulk transfer list
      bulkTransferList.push({
        productId,
        productCode: product.code,
        productName: product.name,
        qty,
        price: product.price
      });
      
      updateBulkTransferDisplay();
      document.body.removeChild(dialogDiv);
    };
    
    buttonDiv.appendChild(cancelBtn);
    buttonDiv.appendChild(addButton);
    dialogContent.appendChild(buttonDiv);
    dialogDiv.appendChild(dialogContent);
    document.body.appendChild(dialogDiv);
  });

  btnClearBulk.addEventListener('click', () => {
    bulkTransferList = [];
    updateBulkTransferDisplay();
  });

  function updateBulkTransferDisplay() {
    if (bulkTransferList.length === 0) {
      bulkTransferItems.innerHTML = '<div class="empty">No products added for transfer</div>';
      return;
    }

    bulkTransferItems.innerHTML = bulkTransferList.map((item, index) => `
      <div class="transfer-item">
        <div>
          <small>${item.productCode} - ${item.productName}</small><br>
          <small>Qty: ${item.qty} × ${formatMoney(item.price)} = ${formatMoney(item.qty * item.price)}</small>
        </div>
        <div style="text-align:right">
          <small style="color:var(--danger);cursor:pointer" onclick="removeBulkItem(${index})">
            <i class="fas fa-times"></i>
          </small>
        </div>
      </div>
    `).join('');
  }

  window.removeBulkItem = function(index) {
    bulkTransferList.splice(index, 1);
    updateBulkTransferDisplay();
  };

  btnProcessBulkTransfer.addEventListener('click', async () => {
    if (bulkTransferList.length === 0) {
      alert('No items to transfer');
      return;
    }

    const userEmail = bulk_t_user.value;
    if (!userEmail) {
      alert('Please select a user');
      return;
    }

    const user = usersCache.find(u => u.email === userEmail);
    if (!user) return;

    if (!confirm(`Process ${bulkTransferList.length} transfers to ${userEmail}?`)) {
      return;
    }

    try {
      const batch = writeBatch(db);
      const transfersRef = collection(db, 'transfers');

      for (const item of bulkTransferList) {
        const product = productsCache.find(p => p.id === item.productId);
        if (!product) continue;

        // Check stock
        if (item.qty > product.stock) {
          throw new Error(`Insufficient stock for ${product.code}. Available: ${product.stock}, Requested: ${item.qty}`);
        }

        // Create transfer record
        const transferData = {
          type: 'outgoing',
          productId: item.productId,
          productCode: item.productCode,
          productName: item.productName,
          fromUserId: currentUser.uid,
          fromUserEmail: currentUser.email,
          toUserEmail: userEmail,
          quantity: item.qty,
          price: item.price,
          total: item.price * item.qty,
          status: 'completed',
          createdAt: serverTimestamp(),
          transferDate: new Date().toISOString()
        };

        const transferDoc = doc(transfersRef);
        batch.set(transferDoc, transferData);

        // Reduce HQ stock
        const productRef = doc(db, 'products', item.productId);
        const newStock = product.stock - item.qty;
        batch.update(productRef, {
          stock: newStock,
          updatedAt: serverTimestamp()
        });

        // Update user warehouse
        const userProductId = `${userEmail.replace(/[^a-zA-Z0-9]/g, '_')}_${item.productId}`;
        const userProductRef = doc(db, 'userWarehouse', userProductId);
        
        let currentUserStock = 0;
        try {
          const userProductSnap = await getDoc(userProductRef);
          if (userProductSnap.exists()) {
            currentUserStock = userProductSnap.data().warehouseStock || 0;
          }
        } catch (err) {
          console.log('No existing stock found');
        }
        
        const newUserStock = currentUserStock + item.qty;
        
        batch.set(userProductRef, {
          userEmail: userEmail,
          productId: item.productId,
          productCode: item.productCode,
          productName: item.productName,
          price: item.price,
          warehouseStock: newUserStock,
          lastUpdated: serverTimestamp(),
          lastTransferDate: new Date().toISOString()
        }, { merge: true });
      }

      await batch.commit();
      
      alert(`Successfully transferred ${bulkTransferList.length} items to ${userEmail}!`);
      
      // Clear and close
      bulkTransferList = [];
      transferModal.classList.remove('show');
      transferModal.setAttribute('aria-hidden', 'true');
      
      // Refresh
      attachProductsListener();
      
    } catch (err) {
      console.error('Bulk transfer error:', err);
      alert('Failed to process transfer: ' + err.message);
    }
  });

  // Search / sort
  searchInput.addEventListener('input', () => renderProducts());
  sortSelect.addEventListener('change', () => renderProducts());

  // Export CSV
  btnExport.addEventListener('click', () => {
    if (!isAdmin) return alert('Not authorized');
    const rows = [['Code','Name','Qty','Price']];
    productsCache.forEach(p => rows.push([p.code||'', p.name||'', String(p.stock||0), String(p.price||0)]));
    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'products.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Sign out
  btnSignOut.addEventListener('click', async () => {
    try { await signOut(auth); window.location.href = 'index.html'; } catch(e){ console.error(e); alert('Sign out failed'); }
  });

  // Clean up
  window.addEventListener('beforeunload', () => { 
    if (productsSnapshotUnsub) productsSnapshotUnsub();
  });

</script>
<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
</body>
</html>