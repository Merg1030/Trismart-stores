<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restock Inventory</title>
<style>
  body { font-family: Arial, sans-serif; background: #1e1e2f; color: #fff; margin: 0; padding: 15px; }
  h2 { text-align: center; color: #ffcc00; margin-bottom: 15px; font-size: 1.4rem; }
  .buttons { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  input, select { padding: 8px; border-radius: 6px; border: none; margin: 5px; width: 150px; background: #2c2c44; color: #fff; font-size: 0.85rem; }
  button { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; background: #ffcc00; color: #1e1e2f; font-weight: 600; font-size: 0.85rem; margin: 5px; }
  button:hover { background: #e6b800; }
  button:disabled { background: #666; color: #999; cursor: not-allowed; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.8rem; }
  th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
  th { color: #ffcc00; font-weight: 600; }
  tbody tr:nth-child(even) { background: #2c2c44; }
  tbody tr:nth-child(odd) { background: #1f1f33; }
  .form-container { display: none; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 15px; }
  .total-value { text-align: right; font-weight: bold; font-size: 0.95rem; color: #ffcc00; margin-top: 8px; }
  .scroll-container { overflow-x: auto; }
  .product-info { background: #2c2c44; padding: 10px; border-radius: 8px; margin: 10px 0; text-align: center; display: none; }
  .product-info span { color: #ffcc00; font-weight: bold; }
  
  /* Responsive table */
  @media(max-width:768px){
    input, select, button { width: 90%; max-width: 250px; }
    .scroll-container { width: 100%; overflow-x: auto; }
    table { width: 100%; min-width: 600px; }
    th, td { padding: 6px 4px; font-size: 0.75rem; }
  }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, updateDoc, addDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
    authDomain: "trismart-online-app.firebaseapp.com",
    projectId: "trismart-online-app",
    storageBucket: "trismart-online-app.firebasestorage.app",
    messagingSenderId: "867677912389",
    appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
    measurementId: "G-KEWDREKNDB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserUID;
let inventory = [];
let isProcessing = false;

onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    currentUserUID = user.uid;
    listenInventory();
    listenRestockHistory();
});

function listenInventory() {
    const invRef = collection(db, "users", currentUserUID, "inventory");
    onSnapshot(invRef, snapshot => {
        inventory = [];
        snapshot.forEach(docSnap => inventory.push({ id: docSnap.id, ...docSnap.data() }));
        populateSelect();
    });
}

function populateSelect() {
    const select = document.getElementById('itemSelect');
    select.innerHTML = '<option value="">Select Item</option>';
    inventory.forEach(item => {
        select.innerHTML += `<option value="${item.id}" data-price="${item.price}" data-code="${item.code}" data-stock="${item.stock}">${item.name}</option>`;
    });
}

document.getElementById('itemSelect')?.addEventListener('change', (e) => {
    const option = e.target.selectedOptions[0];
    const priceInput = document.getElementById('supplierPrice');
    const productInfo = document.getElementById('productInfo');
    
    if (option && option.dataset.price) {
        priceInput.value = option.dataset.price;
        
        // Show product information
        productInfo.style.display = 'block';
        productInfo.innerHTML = `
            Product: <span>${option.text}</span> | 
            Code: <span>${option.dataset.code}</span> | 
            Current Stock: <span>${option.dataset.stock}</span>
        `;
    } else {
        productInfo.style.display = 'none';
    }
});

async function restockItem(event) {
    event.preventDefault();
    
    if (isProcessing) {
        alert("Please wait, processing your request...");
        return;
    }
    
    const itemId = document.getElementById('itemSelect').value;
    const qty = parseInt(document.getElementById('restockQty').value);
    const supplier = document.getElementById('supplier').value.trim();
    const price = parseFloat(document.getElementById('supplierPrice').value);

    if (!itemId || isNaN(qty) || qty <= 0 || !supplier || isNaN(price) || price <= 0)
        return alert("Fill all fields with valid values");

    const item = inventory.find(i => i.id === itemId);
    if (!item) return alert("Item not found");

    isProcessing = true;
    const restockButton = document.querySelector('#restockForm button[type="submit"]');
    const originalText = restockButton.textContent;
    restockButton.textContent = "Processing...";
    restockButton.disabled = true;

    try {
        const itemRef = doc(db, "users", currentUserUID, "inventory", itemId);
        const historyRef = collection(db, "users", currentUserUID, "restockHistory");

        // Update stock
        await updateDoc(itemRef, { stock: item.stock + qty });

        // Add to history
        const totalCost = qty * price;
        await addDoc(historyRef, {
            itemId,
            itemCode: item.code,
            itemName: item.name,
            supplier,
            price,
            quantity: qty,
            totalCost,
            date: new Date()
        });

        document.getElementById('restockForm').reset();
        document.getElementById('productInfo').style.display = 'none';
        alert("Item restocked successfully!");
    } catch (err) {
        console.error("Restock error:", err);
        alert("Error restocking item");
    } finally {
        isProcessing = false;
        restockButton.textContent = originalText;
        restockButton.disabled = false;
    }
}

function toggleForm() {
    const form = document.querySelector('.form-container');
    form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
    
    const toggleBtn = document.getElementById('toggleFormBtn');
    toggleBtn.textContent = form.style.display === 'flex' ? 'Hide Restock Form' : 'Show Restock Form';
}

// ðŸ”¹ Listen and display restock history
function listenRestockHistory() {
    const historyRef = query(
        collection(db, "users", currentUserUID, "restockHistory"),
        orderBy("date", "desc")
    );
    onSnapshot(historyRef, snapshot => {
        const tbody = document.querySelector('#restockTable tbody');
        const totalDiv = document.querySelector('.total-value');
        tbody.innerHTML = '';
        let totalValue = 0;

        if (snapshot.empty) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No restocked items yet</td></tr>`;
            totalDiv.textContent = "Total Restock Value: ZMW 0.00";
            return;
        }

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            totalValue += data.totalCost;
            const date = new Date(data.date.seconds * 1000).toLocaleDateString();

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${date}</td>
                <td>${data.itemCode}</td>
                <td>${data.itemName}</td>
                <td>${data.supplier}</td>
                <td>${data.quantity}</td>
                <td>${data.price.toFixed(2)}</td>
                <td>${data.totalCost.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
        });

        totalDiv.textContent = `Total Restock Value: ZMW ${totalValue.toFixed(2)}`;
    });
}

window.restockItem = restockItem;
window.toggleForm = toggleForm;
</script>
</head>
<body>
<h2>Restock Inventory</h2>

<div class="buttons">
    <button onclick="window.location.href='Warehouse.html'">Back to Warehouse</button>
    <button id="toggleFormBtn" onclick="toggleForm()">Show Restock Form</button>
</div>

<div class="form-container">
  <form id="restockForm" onsubmit="restockItem(event)">
    <select id="itemSelect" required></select>
    <div id="productInfo" class="product-info"></div>
    <input type="number" id="restockQty" placeholder="Quantity to restock" min="1" required>
    <input type="text" id="supplier" placeholder="Supplier Name" required>
    <input type="number" id="supplierPrice" placeholder="Supplier Price per Unit" step="0.01" required>
    <button type="submit">Restock Item</button>
  </form>
</div>

<div class="scroll-container">
  <table id="restockTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Code</th>
        <th>Name</th>
        <th>Supplier</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="7" style="text-align:center;">No restocked items yet</td></tr>
    </tbody>
  </table>
</div>
<div class="total-value">Total Restock Value: ZMW 0.00</div>
</body>
</html>
