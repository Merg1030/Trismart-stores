<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trismart â€” Transfer History</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#0f1220;
      --panel:#191b2a;
      --accent:#ffcc00;
      --muted:#b8b8cc;
      --card:#27293d;
      --radius:12px;
      --glass: rgba(255,255,255,0.03);
      --danger:#f44336;
      --success:#4caf50;
      --info:#2196f3;
      --warning:#ff9800;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--bg) 0%, #23263b 100%);
      color:#fff;
      padding:24px;
    }

    .container{
      width:100%;
      max-width:1400px;
      background:var(--panel);
      border-radius:var(--radius);
      padding:18px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
      margin: 0 auto;
    }

    .header{display:flex;justify-content:space-between;align-items:center;gap:12px; margin-bottom: 24px;}
    h1{margin:0;font-size:1.5rem;}
    .small{color:var(--muted);}

    .btn{padding:9px 12px;border-radius:10px;border:none;background:var(--accent);color:#111;font-weight:700;cursor:pointer; display: inline-flex; align-items: center; gap: 6px;}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .input{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;}

    .controls{display:flex;gap:8px;align-items:center; margin-bottom: 20px; flex-wrap: wrap;}

    .tab-buttons{display:flex;gap:4px; margin-bottom: 20px;}
    .tab-btn{padding:10px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer; font-weight: 600;}
    .tab-btn.active{background:var(--accent);color:#111;border-color:var(--accent);}

    .table-wrap{overflow:auto;max-height:70vh;border-radius:8px; border: 1px solid rgba(255,255,255,0.04);}
    table{width:100%;border-collapse:collapse;font-size:0.95rem;}
    th,td{padding:12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.04);}
    th{color:var(--muted);font-weight:700;position:sticky;top:0;background:var(--panel);z-index:1;}

    .badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);font-weight:700;font-size:0.8rem; display: inline-block;}
    .badge.success{background:rgba(76, 175, 80, 0.1);color:#4caf50}
    .badge.danger{background:rgba(244, 67, 54, 0.1);color:#f44336}
    .badge.info{background:rgba(33, 150, 243, 0.1);color:#2196f3}
    .badge.warning{background:rgba(255, 152, 0, 0.1);color:#ff9800}

    .empty{color:var(--muted);padding:40px;text-align:center; font-size: 1.1rem;}

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.1));
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.03);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 8px 0;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .filters {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-group label {
      font-size: 0.85rem;
      color: var(--muted);
    }

    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .tab-buttons {
        flex-wrap: wrap;
      }
      
      .tab-btn {
        flex: 1;
        min-width: 120px;
      }
      
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filters {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <a href="available-stock.html" class="btn ghost" style="margin-bottom: 12px;"><i class="fas fa-arrow-left"></i> Back to HQ Stock</a>
        <h1>Transfer History</h1>
        <div class="small">All transfers to and from HQ warehouse</div>
      </div>
      <div id="currentUser" class="small"></div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-label">Total Transfers</div>
        <div class="stat-value" id="totalTransfers">0</div>
        <div class="small">All time</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Outgoing</div>
        <div class="stat-value" id="outgoingTransfers">0</div>
        <div class="small">To user warehouses</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Returns</div>
        <div class="stat-value" id="returnTransfers">0</div>
        <div class="small">Back to HQ</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Value</div>
        <div class="stat-value" id="totalValue">$0.00</div>
        <div class="small">All transfers</div>
      </div>
    </div>

    <!-- Tabs and Filters -->
    <div class="tab-buttons">
      <button class="tab-btn active" id="tabAll">All Transfers</button>
      <button class="tab-btn" id="tabOutgoing">Outgoing</button>
      <button class="tab-btn" id="tabReturns">Returns</button>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label for="dateFrom">From Date</label>
        <input type="date" id="dateFrom" class="input">
      </div>
      <div class="filter-group">
        <label for="dateTo">To Date</label>
        <input type="date" id="dateTo" class="input">
      </div>
      <div class="filter-group">
        <label for="filterUser">User</label>
        <select id="filterUser" class="input" style="min-width: 200px;">
          <option value="">All Users</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filterProduct">Product</label>
        <input type="text" id="filterProduct" class="input" placeholder="Search product..." style="min-width: 200px;">
      </div>
      <button class="btn ghost" id="btnClearFilters">Clear Filters</button>
      <button class="btn" id="btnExportHistory"><i class="fas fa-file-export"></i> Export</button>
    </div>

    <!-- History Table -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Type</th>
            <th>Product</th>
            <th>User</th>
            <th>Qty</th>
            <th>Unit Price</th>
            <th>Total Value</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="8" class="empty">Loading history...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    onSnapshot,
    getDocs,
    where
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDuAv_aGmY4VzergDS7g_K3zR-jFYHvGZo",
    authDomain: "trismart-online-app.firebaseapp.com",
    projectId: "trismart-online-app",
    storageBucket: "trismart-online-app.firebasestorage.app",
    messagingSenderId: "867677912389",
    appId: "1:867677912389:web:3c5ea505cb1e84a003d22c",
    measurementId: "G-KEWDREKNDB"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Admin email
  const ADMIN_EMAIL = 'chrischishe@gmail.com';

  // Elements
  const currentUserEl = document.getElementById('currentUser');
  const historyBody = document.getElementById('historyBody');
  const tabAll = document.getElementById('tabAll');
  const tabOutgoing = document.getElementById('tabOutgoing');
  const tabReturns = document.getElementById('tabReturns');
  const btnExportHistory = document.getElementById('btnExportHistory');
  const btnClearFilters = document.getElementById('btnClearFilters');
  const dateFrom = document.getElementById('dateFrom');
  const dateTo = document.getElementById('dateTo');
  const filterUser = document.getElementById('filterUser');
  const filterProduct = document.getElementById('filterProduct');
  
  // Stats elements
  const totalTransfers = document.getElementById('totalTransfers');
  const outgoingTransfers = document.getElementById('outgoingTransfers');
  const returnTransfers = document.getElementById('returnTransfers');
  const totalValue = document.getElementById('totalValue');

  let currentUser = null;
  let isAdmin = false;
  let transfersCache = [];
  let filteredTransfers = [];
  let currentFilter = 'all';
  let usersCache = [];

  // Format helpers
  function formatMoney(v) { return '$' + Number(v || 0).toFixed(2); }
  function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  
  function formatDate(timestamp) {
    if (!timestamp) return 'N/A';
    try {
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    } catch (e) {
      return 'Invalid date';
    }
  }

  // Auth guard
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }
    currentUser = user;
    currentUserEl.textContent = user.email;
    isAdmin = (user.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase();

    if (!isAdmin) {
      // Non-admin users might have limited access
      alert('You need admin privileges to view history');
      window.location.href = 'available-stock.html';
      return;
    }

    loadUsers();
    attachHistoryListener();
  });

  // Load users for filter
  async function loadUsers() {
    const q = query(collection(db, 'users'), where('email', '!=', ADMIN_EMAIL));
    const snapshot = await getDocs(q);
    usersCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    
    filterUser.innerHTML = '<option value="">All Users</option>';
    usersCache.forEach(user => {
      const option = document.createElement('option');
      option.value = user.email;
      option.textContent = `${user.email} (${user.displayName || 'User'})`;
      filterUser.appendChild(option);
    });
  }

  // Attach history listener
  function attachHistoryListener() {
    const q = query(collection(db, 'transfers'), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
      transfersCache = snapshot.docs.map(docSnap => ({
        id: docSnap.id,
        ...docSnap.data()
      }));
      
      updateStats();
      applyFilters();
      
    }, (err) => {
      console.error('History snapshot error', err);
      historyBody.innerHTML = '<tr><td colspan="8" class="empty">Error loading history</td></tr>';
    });
  }

  // Update statistics
  function updateStats() {
    const total = transfersCache.length;
    const outgoing = transfersCache.filter(t => t.type === 'outgoing').length;
    const returns = transfersCache.filter(t => t.type === 'return').length;
    const value = transfersCache.reduce((sum, t) => sum + (t.total || 0), 0);
    
    totalTransfers.textContent = total;
    outgoingTransfers.textContent = outgoing;
    returnTransfers.textContent = returns;
    totalValue.textContent = formatMoney(value);
  }

  // Apply filters
  function applyFilters() {
    let result = transfersCache.slice();
    
    // Apply type filter
    if (currentFilter === 'outgoing') {
      result = result.filter(t => t.type === 'outgoing');
    } else if (currentFilter === 'return') {
      result = result.filter(t => t.type === 'return');
    }
    
    // Apply date filters
    if (dateFrom.value) {
      const fromDate = new Date(dateFrom.value);
      fromDate.setHours(0, 0, 0, 0);
      result = result.filter(t => {
        try {
          const transferDate = t.createdAt?.toDate ? t.createdAt.toDate() : new Date(t.transferDate || t.createdAt);
          return transferDate >= fromDate;
        } catch (e) {
          return true;
        }
      });
    }
    
    if (dateTo.value) {
      const toDate = new Date(dateTo.value);
      toDate.setHours(23, 59, 59, 999);
      result = result.filter(t => {
        try {
          const transferDate = t.createdAt?.toDate ? t.createdAt.toDate() : new Date(t.transferDate || t.createdAt);
          return transferDate <= toDate;
        } catch (e) {
          return true;
        }
      });
    }
    
    // Apply user filter
    if (filterUser.value) {
      result = result.filter(t => t.toUserEmail === filterUser.value);
    }
    
    // Apply product filter
    if (filterProduct.value.trim()) {
      const searchTerm = filterProduct.value.trim().toLowerCase();
      result = result.filter(t => 
        (t.productCode || '').toLowerCase().includes(searchTerm) ||
        (t.productName || '').toLowerCase().includes(searchTerm)
      );
    }
    
    filteredTransfers = result;
    renderHistory();
  }

  // Render history table
  function renderHistory() {
    if (filteredTransfers.length === 0) {
      historyBody.innerHTML = '<tr><td colspan="8" class="empty">No transfers found</td></tr>';
      return;
    }

    historyBody.innerHTML = filteredTransfers.map(transfer => {
      const typeBadge = transfer.type === 'return' ? 
        `<span class="badge danger">RETURN</span>` : 
        `<span class="badge success">OUTGOING</span>`;
      
      const userInfo = transfer.type === 'return' ?
        `From: ${transfer.toUserEmail}` :
        `To: ${transfer.toUserEmail}`;
      
      const statusBadge = transfer.status === 'completed' ?
        `<span class="badge success">Completed</span>` :
        `<span class="badge warning">${transfer.status || 'Pending'}</span>`;
      
      return `
        <tr>
          <td>${formatDate(transfer.createdAt)}</td>
          <td>${typeBadge}</td>
          <td>${escapeHtml(transfer.productCode)} - ${escapeHtml(transfer.productName)}</td>
          <td>${userInfo}</td>
          <td>${transfer.quantity}</td>
          <td>${formatMoney(transfer.price)}</td>
          <td>${formatMoney(transfer.total)}</td>
          <td>${statusBadge}</td>
        </tr>
      `;
    }).join('');
  }

  // Tab switching
  tabAll.addEventListener('click', () => {
    tabAll.classList.add('active');
    tabOutgoing.classList.remove('active');
    tabReturns.classList.remove('active');
    currentFilter = 'all';
    applyFilters();
  });

  tabOutgoing.addEventListener('click', () => {
    tabOutgoing.classList.add('active');
    tabAll.classList.remove('active');
    tabReturns.classList.remove('active');
    currentFilter = 'outgoing';
    applyFilters();
  });

  tabReturns.addEventListener('click', () => {
    tabReturns.classList.add('active');
    tabAll.classList.remove('active');
    tabOutgoing.classList.remove('active');
    currentFilter = 'return';
    applyFilters();
  });

  // Filter event listeners
  dateFrom.addEventListener('change', applyFilters);
  dateTo.addEventListener('change', applyFilters);
  filterUser.addEventListener('change', applyFilters);
  filterProduct.addEventListener('input', applyFilters);

  // Clear filters
  btnClearFilters.addEventListener('click', () => {
    dateFrom.value = '';
    dateTo.value = '';
    filterUser.value = '';
    filterProduct.value = '';
    tabAll.click();
    applyFilters();
  });

  // Export history
  btnExportHistory.addEventListener('click', () => {
    const rows = [['Date', 'Type', 'Product Code', 'Product Name', 'User', 'Quantity', 'Unit Price', 'Total Value', 'Status']];
    
    filteredTransfers.forEach(transfer => {
      rows.push([
        formatDate(transfer.createdAt),
        transfer.type === 'return' ? 'RETURN' : 'OUTGOING',
        transfer.productCode || '',
        transfer.productName || '',
        transfer.toUserEmail || '',
        String(transfer.quantity || 0),
        String(transfer.price || 0),
        String(transfer.total || 0),
        transfer.status || 'completed'
      ]);
    });
    
    const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `transfer-history-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Set default date range to last 30 days
  window.addEventListener('load', () => {
    const today = new Date();
    const lastMonth = new Date();
    lastMonth.setDate(today.getDate() - 30);
    
    dateFrom.valueAsDate = lastMonth;
    dateTo.valueAsDate = today;
  });

</script>
</body>
</html>